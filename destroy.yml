---
- name: AgnosticD Foundation
  gather_facts: false
  hosts: localhost
  vars:
    agnosticd_action: destroy
  roles:
  - role: agnosticd_util
  - role: agnosticd_vars
  - role: agnosticd_init
  tasks:
  - name: Foundation Provision
    ansible.builtin.include_role:
      name: "foundations/{{ agnosticd_foundation }}"
      tasks_from: inventory.yml

- name: AgnosticD Architecture and Workloads
  gather_facts: false
  hosts: all
  vars:
    agnosticd_action: destroy
  roles:
  - role: agnosticd_util
  - role: agnosticd_vars
  tasks:
  - name: Architecture Workloads Destroy
    loop: "{{ agnosticd_workloads_destroy }}"
    loop_control:
      loop_var: __agnosticd_workload
    ansible.builtin.include_role:
      name: "workloads/{{ __agnosticd_workload.name }}"

  - name: Architecture Destroy
    ansible.builtin.include_role:
      name: "architectures/{{ agnosticd_architecture }}"
    when:
    - agnosticd_architecture is defined

  - name: Foundation Destroy
    ansible.builtin.include_role:
      name: "foundations/{{ agnosticd_foundation }}"
      apply:
        delegate_to: localhost
        delegate_facts: true
        run_once: true

  - name: AgnosticD Post
    ansible.builtin.include_role:
      name: agnosticd_post
      apply:
        delegate_to: localhost
        delegate_facts: true
        run_once: true
