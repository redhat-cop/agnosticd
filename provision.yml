---
- name: AgnosticD Foundation
  gather_facts: false
  hosts: localhost
  vars:
    agnosticd_action: provision
  roles:
  - role: agnosticd_util
  - role: agnosticd_vars
  - role: agnosticd_init
  tasks:
  - name: Foundation Provision
    ansible.builtin.include_role:
      name: "foundations/{{ agnosticd_foundation }}"

  - name: Foundation Inventory
    ansible.builtin.include_role:
      name: "foundations/{{ agnosticd_foundation }}"
      tasks_from: inventory.yml

- name: AgnosticD Architecture and Workloads
  gather_facts: false
  vars:
    agnosticd_action: provision
  hosts: all
  roles:
  - role: agnosticd_util
  - role: agnosticd_vars
  tasks:
  - name: Architecture Provision
    ansible.builtin.include_role:
      name: "architectures/{{ agnosticd_architecture }}"

  - name: Architecture Workloads Provision
    loop: "{{ agnosticd_workloads }}"
    loop_control:
      loop_var: __agnosticd_workload
    vars:
      __agnosticd_workload_role_name: >-
        {% if (playbook_dir ~ '/roles/workloads/' ~ __agnosticd_workload.name) is exists -%}
        workloads/{{ __agnosticd_workload.name }}
        {%- else -%}
        {{ __agnosticd_workload.name }}
        {%- endif %}
    ansible.builtin.include_role:
      name: "{{ __agnosticd_workload_role_name }}"

  - name: AgnosticD Post
    ansible.builtin.include_role:
      name: agnosticd_post
      apply:
        delegate_to: localhost
        delegate_facts: true
        run_once: true
