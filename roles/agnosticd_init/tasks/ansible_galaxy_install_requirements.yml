---
- vars:
    __requirement_path_final: "{{ agnosticd_output_dir }}/compiled_requirements.yml"
  block:

    - name: Requirement paths found
      debug:
        var: __requirement_paths

    - name: Copy requirements content to output_dir
      copy:
        dest: "{{ __requirement_path_final }}"
        content: "{{ __ansible_galaxy_requirements_content | to_yaml }}"

    - name: Install collections from {{ __ansible_galaxy_requirements_path }}
      vars:
        __from_ee: "{{ lookup('env', 'LAUNCHED_BY_RUNNER') == '1' }}"
        __collections_path: "{{ lookup('config', 'COLLECTIONS_PATHS')[0] }}"
      ansible.builtin.command: >-
        ansible-galaxy collection install
        -r "{{ __requirement_path_final }}"
        -p "{{ __collections_path | quote }}"
        --force-with-deps
      when: >-
        __collections_path.startswith('/tmp/') or  __from_ee | bool
      register: r_ansible_galaxy_install_collections
      until: r_ansible_galaxy_install_collections is successful
      retries: 10
      delay: 30
