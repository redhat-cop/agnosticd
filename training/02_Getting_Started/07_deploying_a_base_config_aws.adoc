
= How to deploy a base config on Agnostic D from an AWS instance

Assuming you’ve correctly configured your vars files, it’s time to deploy "a base config".

== Prerequisites

* AWS active account with both programmatic and console access.

* An existing Public Hosted Zone on AWS.

* Access control and write permissions link:https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/r53-api-permissions-ref.html[on Route 53 API]

== Preparing your a-base-config vars
The AgnosticD config a-base-config comes with sample vars files included for AWS, locally at ~/agnosticd/ansible/configs/a-base-config/sample_variables/sample_vars.yml. Only a few variables need changed.

1. Copy the `sample_vars.yml` file and call it `my_ec2_vars.yml`, or anything you like.
+
[source,bash]
----
$ cp configs/a-base-config/sample_variables/sample_vars.yml \
  ~/my_ec2_vars.yml
----

2. Edit your copy of the vars file, changing the value of guid to a valid subdomain name (For example an alphanumeric string starting with a letter). The values that need changing are identified below:
+
[source,bash]
----
# sample configuration file
#
# Usage: ansible-playbook main.yml -e @configs/a-base-config/sample.yml
#
# Ideally keep your copy OUTSIDE your repo, especially if using Cloud Credentials

env_type: a-base-config                 # Name of config to deploy
output_dir: /tmp/workdir                # Writable working scratch directory
node_instance_count: 1                  # Number of nodes to deploy
email: name@example.com                 # User info for notifications

guid: a890-amaya                                # Unique string used in FQDN
subdomain_base_suffix: ".rhte.opentlc.com"      # Your domain used in FQDN

# Cloud specfic settings - example given here for AWS

cloud_provider: ec2                     # Which AgnosticD Cloud Provider to use
aws_region: us-east-1                   # AWS Region to deploy in
HostedZoneId: Z2JMY49ICBI99H            # You will need to change this
key_name: a890key                       # Keyname must exist in AWS

node_instance_image: RHEL81GOLD
----

NOTE: The `HostedZoneId` must match the one for your domain.

image::../images/hosted_zone_id.png[Hosted Zone ID]

== Deploy a base config

Execute the main AgnosticD playbook (bear in mind the path to your files, which may differ):
+
[source,bash]
----
[agilpipp-redhat.com@bastion ansible]$ ansible-playbook main.yml \
   -e @~/my_ec2_vars.yml \ 
   -e @~/secrets.yml
----
+

NOTE: If you are having python2 Vs. Python3 issues, Add `/usr/bin/python3.6` before the ansible-playbook command. For example: `/usr/bin/python3.6 ansible-playbook ansible/main.yml -e @~/my_vars.yml -e@~/secrets.yml`

== Log into your new node

Congratulations!
You should now have your base config deployed succesfully, please log into your AWS console and find your new node(s):

image::../images/nodes_aws.png[Node on AWS]

In the AWS console you may have noticed the public IP address of your new node. This, and your other instance(s), have been captured in a temporary working directory, the `workdir` set in your `~/my_ec2_vars.yml` file typically set to `/tmp/workdir` if you have not changed it previously. This contains, amongst other files, an ssh configuration file.

Use this key to ssh into your new node (also, you could use the pem file you previously created and archived on your .ssh directory) using the ec2-user as follows:
[source,bash]
----
$ [agilpipp-redhat.com@bastion ~]$ ssh -i /tmp/workdir/a890key ec2-user@ec2-52-71-94-132.compute-1.amazonaws.com
[ec2-user@node ~]$
----

=== See your Deployment from your AWS console

Alternatively, if you click on the connect button, all the options are shown:

image::../images/connect_node_aws.png[Connection options]