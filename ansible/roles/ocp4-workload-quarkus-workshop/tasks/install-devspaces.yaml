---
# deploy devspaces operator
- name: Create operator subscription for Dev Spaces
  k8s:
    state: present
    merge_type:
    - strategic-merge
    - merge
    definition: "{{ lookup('file', item ) | from_yaml }}"
  loop:
  - ./files/devspaces_subscription.yaml

# wait for CRD to be a thing
- name: Wait for Dev Spaces CRD to be ready
  k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: checlusters.org.eclipse.che
  register: r_devspaces_crd
  retries: 200
  delay: 10
  until: r_devspaces_crd.resources | list | length == 1

- name: Verify if Dev Spaces Service is accessible
  k8s_info:
    api_version: v1
    kind: Service
    name: devspaces-operator-service
    namespace: openshift-operators
  register: r_devspaces_svc
  retries: 200
  delay: 10
  until: r_devspaces_svc.resources | list | length == 1

- name: Create CR for Dev Spaces
  kubernetes.core.k8s:
    merge_type:
    - merge
    definition: "{{ lookup('file', 'devspaces_cr.yaml' ) }}"
  register: r_create_crd
  until: r_create_crd is successful
  retries: 30
  delay: 10

- name: Wait for Dev Spaces Pod to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    label_selectors:
      - component=devspaces-dashboard
    namespace: openshift-operators
  register: r_devspaces_dashboard_pod
  failed_when:
    r_devspaces_dashboard_pod.resources[0].status.phase | default('') != 'Running'
  until: r_devspaces_dashboard_pod is successful
  delay: 10
  retries: 200

- name: Import stack imagestream
  k8s:
    state: present
    merge_type:
    - strategic-merge
    - merge
    definition: "{{ lookup('file', item ) | from_yaml }}"
  loop:
  - ./files/stack_imagestream.yaml

- name: wait for stack to be a thing
  k8s_info:
    kind: ImageStream
    name: quarkus-stack
    namespace: openshift
  register: r_stack_is
  retries: 200
  delay: 10
  until: r_stack_is.resources | list | length == 1

- name: import stack image
  shell: |
    oc import-image --all quarkus-stack -n openshift

- name: Create a Dev Spaces ImagePuller
  k8s:
    state: present
    merge_type:
    - strategic-merge
    - merge
    definition: "{{ lookup('file', item ) | from_yaml }}"
  loop:
  - ./files/devspaces_imagepuller.yaml

# - name: Pre-create and warm user workspaces
#   include_tasks: create_dev_workspace.yaml
#   vars:
#     user: "{{ item }}"
#   with_list: "{{ users }}"

- name: wait a minute and let the image download and be registered
  when: num_users | int > 0
  pause:
      minutes: 2

