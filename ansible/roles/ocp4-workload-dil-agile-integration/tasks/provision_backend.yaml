---

- name: Evaluate {{backend_project }} namespace if not exists 
  k8s:
    api_version: v1
    kind: Namespace
    name: '{{ backend_project }}'
    state: present

- name: Create S2I templates
  shell: "oc apply -f https://raw.githubusercontent.com/RedHat-Middleware-Workshops/dayinthelife-integration/master/support/templates/spring-boot-camel-template.json -n openshift"
  ignore_errors: true

- name: Create template for Integr8ly SSO Fuse 7.1
  shell: "oc create -f https://raw.githubusercontent.com/RedHat-Middleware-Workshops/dayinthelife-integration/master/support/templates/spring-boot-camel-template-SSO-integr8ly.json -n openshift"
  ignore_errors: true

- name: Create Backend Database
  shell: "oc new-app -f https://raw.githubusercontent.com/openshift/origin/master/examples/db-templates/postgresql-ephemeral-template.json \
  --param=POSTGRESQL_USER=dbuser --param=POSTGRESQL_PASSWORD=password --param=POSTGRESQL_DATABASE=sampledb --param=POSTGRESQL_VERSION=latest -n {{ backend_project }}"
  register: create_backend_db
  failed_when: create_backend_db.stderr != '' and 'already exists' not in create_backend_db.stderr

- name: Create Backend Location API service
  shell: "oc new-app s2i-fuse71-spring-boot-camel -p GIT_REPO=https://github.com/RedHat-Middleware-Workshops/dayinthelife-integration \
  -p CONTEXT_DIR=/projects/location-service -p APP_NAME=location-service -p GIT_REF=master -n {{ backend_project }}"
  register: create_location_api_service
  failed_when: create_location_api_service.stderr != '' and 'already exists' not in create_location_api_service.stderr

- name: Create Backend Location Detail SOAP service
  shell: "oc new-app s2i-fuse71-spring-boot-camel -p GIT_REPO=https://github.com/RedHat-Middleware-Workshops/dayinthelife-integration \
  -p CONTEXT_DIR=/projects/location-soap -p APP_NAME=location-soap -p GIT_REF=master -n {{ backend_project }}"
  register: create_location_detail_soap_service
  failed_when: create_location_detail_soap_service.stderr != '' and 'already exists' not in create_location_detail_soap_service.stderr

- name: Create Backend Location Detail SOAP to REST service
  shell: "oc new-app s2i-fuse71-spring-boot-camel -p GIT_REPO=https://github.com/RedHat-Middleware-Workshops/dayinthelife-integration \
  -p CONTEXT_DIR=/projects/location-soap2rest -p APP_NAME=location-soap2rest -p GIT_REF=master -n {{ backend_project }}"
  register: create_location_soap_rest_service
  failed_when: create_location_soap_rest_service.stderr != '' and 'already exists' not in create_location_soap_rest_service.stderr

