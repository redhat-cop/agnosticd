---
# Implement your Pre Workload deployment tasks here

- name: Cleaning admin
  include_tasks:
    file: ./clean-admin.yml

- name: extract api_url
  command: oc whoami --show-server
  register: api_url

- name: extract master_url
  command: oc get route console -o jsonpath='{.spec.host}' -n openshift-console
  register: master_url_r

- set_fact:
    master_url: "https://{{ master_url_r.stdout | trim }}"

- name: extract route_subdomain
  command: oc get ingresses.config.openshift.io cluster -o jsonpath='{.spec.domain}'
  register: route_subdomain

- name: extract ocp_username
  command: oc whoami
  register: ocp_username

- name: cat the kubeadmin-password
  command: "cat /home/{{ ansible_user }}/cluster-{{ guid }}/auth/kubeadmin-password"
  register: kubeadmin_password

- name: set bastion_fqdn
  set_fact:
    bastion_fqdn: bastion.{{ guid }}{{ subdomain_base_suffix }}

# Leave this as the last task in the playbook.
- name: pre_workload tasks complete
  debug:
    msg: "Pre-Workload tasks completed successfully."
  when: not silent|bool
