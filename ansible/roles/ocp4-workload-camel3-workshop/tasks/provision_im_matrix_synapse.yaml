---
- name: Evaluate {{ matrix_synapse_namespace }} namespace if not exists
  k8s:
    api_version: v1
    kind: Namespace
    name: '{{ matrix_synapse_namespace }}'
    state: present

- name: Create Matrix resources
  k8s:
    state: present
    resource_definition: "{{ lookup('template', 'im_matrix_synapse.yaml.j2') }}"

- name: wait for synapse pod
  shell: oc get pods -o json -n {{ matrix_synapse_namespace }}
  register: synapse_pod
  until: synapse_pod.stdout|from_json|json_query('items[*].status.phase')|unique == ["Running"]

- name: Get the pods in the {{ rocketchat_namespace }} namespace
  k8s_info:
    kind: Pod
    namespace: "{{ matrix_synapse_namespace }}"
  register: synapse_pod_list

- name: Show Synapse Pod
  debug:
    msg: "{{ synapse_pod_list }}"

- name: Show Synampse Pod Name
  set_fact:
    spodname: '{{ synapse_pod_list.resources[0].metadata.name }}'

- name: Print pod name from variable
  debug:
    msg: "pod name: {{ spodname }} "

- name: Create Synapse Admin
  kubernetes.core.k8s_exec:
    namespace: "{{ matrix_synapse_namespace }}"
    pod: '{{ synapse_pod_list.resources[0].metadata.name }}'
    command: register_new_matrix_user -u admin -p admin -a -c /data/config/homeserver.yaml
  register: command_status
  ignore_errors: True

- name: Check last command status
  debug:
    msg: "cmd status: {{command_status.rc}}"

- name: Check users
  debug:
    msg: "users: {{users}}"


- name: Log users
  debug:
    msg: "user: {{item}}"
  loop: "{{users}}"


- name: Create Synapse Users
  kubernetes.core.k8s_exec:
    namespace: "{{ matrix_synapse_namespace }}"
    pod: '{{ synapse_pod_list.resources[0].metadata.name }}'
    command: register_new_matrix_user -u {{item}} -p openshift --no-admin -c /data/config/homeserver.yaml
  loop: "{{users}}"
  ignore_errors: True


- name: create rooms
  set_fact:
    rooms: "{{ rooms | default([]) + ['room'+item | string] }}"
  loop: "{{ range(1,((num_users | int) + 1)) | list }}"

- name: Log rooms
  debug:
    msg: "{{rooms}}"

- name: Get Admin token
  shell: 
    cmd: >
      curl -X POST 
      -d '{"type":"m.login.password", "user":"admin", "password":"admin"}' 
      https://synapse-matrix.{{ route_subdomain }}/_matrix/client/r0/login | jq .access_token --raw-output
  register: admin_token

# - name: Get Admin token
#   shell: 
#     cmd: >
#       echo 
#       '{"access_token":"token"}' | jq .access_token --raw-output
#   register: token_status


- name: Log token
  debug:
    msg: "token: {{admin_token.stdout}}"


- name: Create Rooms
  shell: 
    cmd: >
      curl -X POST 
      -H "content-type: application/json" 
      -H "Authorization: Bearer {{admin_token.stdout}}" 
      https://synapse-matrix.{{ route_subdomain }}/_matrix/client/v3/createRoom
      -d '{"creation_content": {"m.federate": false},"name": "{{item}}","preset": "public_chat","room_alias_name": "{{item}}", "invite":["@{{users[idx]}}:rhintegration.demo"]}'
      | jq .room_id --raw-output
      | sed -r s/'!'/%21/g
      | sed -r s/':'/%3A/g
  loop: "{{rooms}}"
  loop_control:
    index_var: idx
  register: room_result

- name: Log room result
  debug:
    msg: "{{room_result}}"

- name: Log room result array
  debug:
    msg: "{{item.stdout}}"
  loop: "{{room_result.results}}"

# - name: create roomIds
#   set_fact:
#     roomids: "{{ roomids | default([]) + [item.stdout | string] }}"
#   loop: "{{room_result.results}}"

# - name: Log room IDs
#   debug:
#     msg: "{{roomids}}"




# curl -X POST \
# -H "content-type: application/json" \
# -H "Authorization: Bearer syt_YWRtaW4_inZPYzVijZBHSWQhTDvh_3oYqXr" \
# "https://synapse-matrix.apps.cluster-7xmhb.7xmhb.sandbox1496.opentlc.com/_synapse/admin/v1/join/!PcTSnTPpOWTSHHeRUm:rhintegration.demo" \
# -d '{"user_id": "@user1:rhintegration.demo"}'

# curl -X POST \
# -H "content-type: application/json" \
# -H "Authorization: Bearer syt_YWRtaW4_zizSAijAaqVVGYNzIZrg_4LwFnA" \
# https://synapse-service-matrix.apps.cluster-svdnn.svdnn.sandbox758.opentlc.com/_matrix/client/v3/createRoom \
# -d '{"creation_content": {"m.federate": false},"name": "room3","preset": "public_chat","room_alias_name": "room3"}'

