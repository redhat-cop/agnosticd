---
- name: get local ip
  shell: "ip addr show eth0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1"
  register: private_ip

- name: Setup hostname entry
  lineinfile:
    dest: /etc/hosts
    line: "{{ private_ip }} {{ idm_dns_name }}"
    state: present

- name: Configure initial IdM setup
  command: >
    ipa-server-install -U
      --hostname="{{ idm_dns_name | default(ansible_fqdn) }}"
      --domain="{{ idm_domain }}"
      --realm="{{ idm_realm | upper }}"
      --ds-password="{{ idm_dm_password }}"
      --admin-password="{{ idm_admin_password }}"
      --no-host-dns
  ignore_errors: true
  notify: Ensure IdM is running at boot
