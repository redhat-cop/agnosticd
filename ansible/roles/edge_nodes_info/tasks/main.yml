---
- name: Gather EC2 facts
  amazon.aws.ec2_instance_facts:
    aws_access_key: "{{ aws_access_key_id }}"
    aws_secret_key: "{{ aws_secret_access_key }}"
    region: "{{ aws_region_final | default(aws_region) | default(region) | default('us-east-1')}}"
    filters:
      "tag:AnsibleGroup": "{{ edge_node_group }}"
  register: hmi_device_facts

- name: debug hmi_device_facts
  debug:
    var: hmi_device_facts
    verbosity: 2

- when: hmi_device_facts['instances'] | length > 0
  block:
    - name: add edge hmi node in the inventory
      add_host:
        name: "{{ item.public_dns_name }}"
        groups: "{{ item.tags.AnsibleGroup }}"
        public_ip_address: "{{ item['public_ip_address'] }}"
      when:
        - item.state.name != 'terminated'
      loop: "{{ hmi_device_facts['instances'] }}"

    - name: debug groups
      debug:
        var: groups
        verbosity: 2

    - name: Print edge hmi nodes access info
      agnosticd_user_info:
        msg: "{{ item }}"
      loop:
        - "noVNC web url: http://{{ groups['hmi_nodes'][0] }}:6080/vnc.html"
        - "noVNC password: {{ novnc_password }}"

    - name: Print edge hmi nodes access data
      agnosticd_user_info:
        data:
          novnc_web_url: "http://{{ groups['hmi_nodes'][0] }}:6080/vnc.html"
          novnc_password: "{{ novnc_password }}"