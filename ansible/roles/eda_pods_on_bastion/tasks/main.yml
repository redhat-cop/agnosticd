---
- name: eda block
  become: true
  block:
  - name: Install epe-release
    ansible.builtin.yum:
      name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
      state: present

  - name: Install podman-compose
    ansible.builtin.yum:
      name: podman-compose
      state: present

  - name: Pull podman image
    become_user: "{{ eda_pods_on_bastion_user_name }}"
    containers.podman.podman_image:
      name: "quay.io/ansible/ansible-rulebook:v0.12.0"

  - name: Create directory
    ansible.builtin.file:
      path: "/opt/podman/eda"
      state: directory
      mode: '755'

  - name: Copy pods directories
    ansible.builtin.copy:
      src: "./files/{{ item }}"
      dest: "/opt/podman/eda"
      owner: "{{ eda_pods_on_bastion_user_name }}"
      mode: '777'
    loop:
      - volume_snapshot
      - patch_route
      - resource_quota


  - name: Copy common files
    ansible.builtin.copy:
      src: ./files/common/
      dest: "/opt/podman/eda/{{ item }}/"
      owner: "{{ eda_pods_on_bastion_user_name }}"
      mode: '666'
    loop:
      - volume_snapshot
      - patch_route
      - resource_quota

  - name: Copy podman-compose.yml.j2 template
    ansible.builtin.template:
      src: podman-compose.yml.j2
      dest: /opt/podman/eda/{{ item }}/podman-compose.yml
      owner: "{{ eda_pods_on_bastion_user_name }}"
      mode: '644'
    loop:
      - volume_snapshot
      - patch_route
      - resource_quota

  - name: Copy service.j2 template in systemd
    ansible.builtin.template:
      src: service.j2
      dest: /etc/systemd/system/{{ item }}.service
      owner: root
      group: root
      mode: '644'
    loop:
      - volume_snapshot
      - patch_route
      - resource_quota


  - name: Enable and start podman daemon
    ansible.builtin.systemd:
      enabled: true
      state: started
      daemon_reload: true
      name: "{{ item }}@{{ eda_pods_on_bastion_user_name }}"
    loop:
      - volume_snapshot
      - patch_route
      - resource_quota
