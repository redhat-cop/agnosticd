- include_vars: osp.yml

- set_fact:
    heat_template: "{{output_dir}}/{{ env_type }}.{{ guid }}.{{cloud_provider}}_cloud_template"

- name: Print heat_template
  debug:
    var: heat_template

- name: Generate Heat template
  template:
    src: "{{ cloud_infra_template_src }}"
    dest: "{{ heat_template }}"
  tags: # Not sure what uses these?
    - osp_infrastructure_deployment
    - gen_heat_template

- name: Stop if debugging template
  fail:
    msg: "Check template here: {{ heat_template }}"
  when: debug_template|d(false)|bool

- name: Validate Heat template
  assert:
    that: >
      lookup('file', heat_template) | from_yaml is succeeded
      or lookup('file', heat_template) | from_json is succeeded
    success_msg: Heat template is syntactically valid

- name: validate Heat template with dry run
  environment:
    OS_AUTH_URL: "{{ osp_auth_url }}"
    OS_USERNAME: "{{ osp_auth_username }}"
    OS_PASSWORD: "{{ osp_auth_password }}"
    OS_PROJECT_NAME: "{{ osp_project_creation.project.name }}"
    OS_PROJECT_DOMAIN_ID: "{{ osp_auth_project_domain }}"
    OS_USER_DOMAIN_NAME: "{{ osp_auth_user_domain }}"
  command: >-
    openstack stack create --dry-run
    -t {{ heat_template }} {{ guid }}-base-stack
  changed_when: false
  register: heat_validation
  until: heat_validation is succeeded
  retries: "{{ heat_retries }}"
  delay: 20
  tags:
    - osp_infrastructure_deployment
    - validate_heat_template

######################### Launch Template