---

- name: Fetching enabled repos name list from subscription of {{org}}
  shell: >-
    hammer --output cve  
    repository list 
    --organization "{{org}}" |grep Name
  register: repo_name
  ignore_errors: yes
  tags:
    - configure_satellite
    - configure_satellite_repository
           
- name: Creating fact from enabled Repos Name list from subscription of {{org}} 
  set_fact:
    repos_added: "{{ repos_added | d([]) + [ item.split(':')[1].lstrip(' ') ] }}"
  loop: "{{ repo_name.stdout_lines}}"
  when: repo_name is defined
  tags:
    - configure_satellite
    - configure_satellite_repository

- name: print already exist repos 
  debug: 
    var: repos_added | d([])
     
- name: Setting up satellite repository 
  command: >-
    hammer repository-set enable 
    --organization "{{item.organization}}" 
    --product "{{item.product}}" 
    --basearch "{{item.basearch}}" 
<<<<<<< HEAD
    --name "{{item.name}}" {% if item.releasever is defined %} --releasever '{{ item.releasever }}' {% endif %}
  when: 
    -  item.name | regex_replace('[()]')  + ' ' + item.basearch + ( ' ' if item.releasever|d(None)  else '')  +  item.releasever|d('')  not in  repos_added|d([])
=======
    --name "{{item.name}}"
    --releasever "{{item.releasever}}"
  when: 
    - 'item.sync_name not in repos_added|d([])'
    - 'item.releasever is defined'
>>>>>>> b8e0700692a0f8ae13a0204a129408056f6ac00e
  loop: "{{ satellite_repository }}"
  tags:
    - configure_satellite
    - configure_satellite_repository

<<<<<<< HEAD
- name: Grab ID of existing repos
  shell: >-
    hammer repository list
    --organization "{{ org }}" | grep yum | awk '{print $1}'
  register: repos
=======
- name: Setting up satellite repository
  command: >-
    hammer repository-set enable 
    --organization "{{item.organization}}" 
    --product "{{item.product}}" 
    --basearch "{{item.basearch}}" 
    --name "{{item.name}}"
  when: 
    - 'item.sync_name not in repos_added|d([])'
    - 'item.releasever is not defined'
  loop: "{{ satellite_repository }}"
  tags:
    - configure_satellite
    - configure_satellite_repository
>>>>>>> b8e0700692a0f8ae13a0204a129408056f6ac00e

- name: Grab ID of existing repos
  shell: >-
    hammer repository list
    --organization "{{ org }}" | grep yum | awk '{print $1}'
  register: repos

# - debug: var=repos

- name: Sync repo
  command: >-
    hammer repository synchronize
    --organization "{{ org }}"
    --id "{{ item }}"
  loop: "{{ repos.stdout_lines }}"
<<<<<<< HEAD
  # register: sync_result
  # retries: 3
  # until: "{{ sync_result is  success }} "
  async: 50
=======
  register: sync_result
  retries: 3
  until: "{{ sync_result is  success }} "
>>>>>>> b8e0700692a0f8ae13a0204a129408056f6ac00e
  tags:
    - configure_satellite
    - configure_satellite_repository
    - configure_satellite_sync_repo


<<<<<<< HEAD
=======
# - name: Sync repo
#   command: >-
#     hammer repository synchronize 
#     --organization "{{item.organization}}" 
#     --product "{{item.product}}" 
#     --name "{{item.sync_name}}"
#     --async
#   loop: "{{ satellite_repository }}"
#   ignore_errors: yes
>>>>>>> b8e0700692a0f8ae13a0204a129408056f6ac00e

