# vim: set ft=ansible
---
# Implement your Workload deployment tasks here

# TODO: change to variable-based versions
- name: set relevant facts for re-use
  set_fact:
    elastic_version: "elasticsearch-operator.4.2.1-201910221723"
    jaeger_version: "jaeger-operator.v1.13.1"
    kiali_version: "kiali-operator.v1.0.7"
    servicemesh_version: "servicemeshoperator.v1.0.2"

- name: create elastic subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-elastic
        namespace: openshift-operators
      spec:
        channel: "4.2"
        source: redhat-operators
        sourceNamespace: openshift-marketplace
        name: elasticsearch-operator
        startingCSV: "{{ elastic_version }}"
        installPlanApproval: Manual

- name: wait for the status of the elastic subscription to not be empty
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: service-mesh-elastic
    namespace: openshift-operators
  register: operator_subscription_out
  until: operator_subscription_out.resources[0].status.installplan.name is defined
  retries: 30
  delay: 20

- name: patch the installplan to approve it
  k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: InstallPlan
      metadata:
        namespace: openshift-operators
        name: "{{ operator_subscription_out.resources[0].status.installplan.name }}"
      spec:
        approved: true

- name: create Jaeger subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-jaeger
        namespace: openshift-operators
      spec:
        channel: stable
        source: redhat-operators
        sourceNamespace: openshift-marketplace
        name: jaeger-product
        startingCSV: "{{ jaeger_version }}"
        installPlanApproval: Manual

- name: wait for the status of the jaeger subscription to not be empty
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: service-mesh-jaeger
    namespace: openshift-operators
  register: operator_subscription_out
  until: operator_subscription_out.resources[0].status.installplan.name is defined
  retries: 30
  delay: 20

- name: patch the installplan to approve it
  k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: InstallPlan
      metadata:
        namespace: openshift-operators
        name: "{{ operator_subscription_out.resources[0].status.installplan.name }}"
      spec:
        approved: true

- name: create Kiali subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-kiali
        namespace: openshift-operators
      spec:
        channel: stable
        source: redhat-operators
        sourceNamespace: openshift-marketplace
        name: kiali-ossm
        startingCSV: "{{ kiali_version }}"
        installPlanApproval: Manual

- name: wait for the status of the kiali subscription to not be empty
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: service-mesh-kiali
    namespace: openshift-operators
  register: operator_subscription_out
  until: operator_subscription_out.resources[0].status.installplan.name is defined
  retries: 30
  delay: 20

- name: patch the installplan to approve it
  k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: InstallPlan
      metadata:
        namespace: openshift-operators
        name: "{{ operator_subscription_out.resources[0].status.installplan.name }}"
      spec:
        approved: true

- name: create Service Mesh Operator subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-operator
        namespace: openshift-operators
      spec:
        channel: "1.0"
        source: redhat-operators
        sourceNamespace: openshift-marketplace
        name: servicemeshoperator
        startingCSV: "{{ servicemesh_version }}"
        installPlanApproval: Manual

- name: wait for the status of the servicemesh subscription to not be empty
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: service-mesh-operator
    namespace: openshift-operators
  register: operator_subscription_out
  until: operator_subscription_out.resources[0].status.installplan.name is defined
  retries: 30
  delay: 20

- name: patch the installplan to approve it
  k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: InstallPlan
      metadata:
        namespace: openshift-operators
        name: "{{ operator_subscription_out.resources[0].status.installplan.name }}"
      spec:
        approved: true

- name: wait for the CSVs to exist
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    name: "{{ item }}"
    namespace: openshift-operators
  register: csv_exists_out
  retries: 5
  delay: 70
  until: csv_exists_out.resources | length > 0
  with_items:
    - "{{ elastic_version }}"
    - "{{ jaeger_version }}"
    - "{{ kiali_version }}"
    - "{{ servicemesh_version }}"

- name: wait for the CSVs to be Succeeded
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    name: "{{ item }}"
    namespace: openshift-operators
  register: csv_exists_out
  retries: 5
  delay: 70
  until: csv_exists_out.resources[0].status.phase == "Succeeded"
  with_items:
    - "{{ elastic_version }}"
    - "{{ jaeger_version }}"
    - "{{ kiali_version }}"
    - "{{ servicemesh_version }}"

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool

