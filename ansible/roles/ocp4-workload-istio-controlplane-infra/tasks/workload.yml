# vim: set ft=ansible
---
# Implement your Workload deployment tasks here

- name: create Service Mesh CatalogSourceConfig
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1
      kind: CatalogSourceConfig
      metadata:
        name: service-mesh-catalog-source-config
        namespace: openshift-marketplace
      spec:
        packages: elasticsearch-operator,jaeger-product,kiali-ossm,servicemeshoperator
        source: service-mesh-catalog-source-config
        targetNamespace: openshift-operators

- name: create ElasticSearch subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-elasticsearch
        namespace: openshift-operators
      spec:
        channel: preview
        source: service-mesh-catalog-source-config
        name: elasticsearch-operator
        sourceNamespace: openshift-operators

- name: create Jaeger subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-jaeger
        namespace: openshift-operators
      spec:
        channel: stable
        source: service-mesh-catalog-source-config
        name: jaeger-product
        sourceNamespace: openshift-operators

- name: create Kiali subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-kiali
        namespace: openshift-operators
      spec:
        channel: stable
        source: service-mesh-catalog-source-config
        name: kiali-ossm
        sourceNamespace: openshift-operators

- name: create Service Mesh Operator subscription
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: service-mesh-operator
        namespace: openshift-operators
      spec:
        channel: "1.0"
        source: service-mesh-catalog-source-config
        name: servicemeshoperator
        sourceNamespace: openshift-operators

- name: wait for the status of the subscriptions to not be empty
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: "{{ item }}"
    namespace: openshift-operators
  register: operator_subscription_out
  until: operator_subscription_out.resources[0].status is defined
  retries: 30
  delay: 20
  with_items:
    - service-mesh-operator
    - service-mesh-jaeger
    - service-mesh-kiali
    - service-mesh-elasticsearch

- name: wait for the operator deployments to be running
  k8s_facts:
    api_version: extensions/v1beta1
    kind: Deployment
    name: "{{ item }}"
    namespace: openshift-operators
  register: operator_deployment_out
  until: 
    - operator_deployment_out.resources[0].status.readyReplicas is defined 
    - operator_deployment_out.resources[0].status.readyReplicas | int > 0
  retries: 5
  delay: 20
  with_items:
    - elasticsearch-operator
    - istio-operator
    - jaeger-operator
    - kiali-operator

- name: create istio-system project
  k8s:
    state: present
    definition:
      apiVersion: project.openshift.io/v1
      kind: Project
      metadata:
        name: istio-system

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool

