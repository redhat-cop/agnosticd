---
# User info printout messages on workload start
- name: Setting up workload for user
  debug:
    msg: "Setting up workload for user ocp_username = {{ ocp_username }}"

- name: Give access to opentlc-mgr
  when: (ocp_username == 'opentlc-mgr')
  shell: |
         oc adm policy add-cluster-role-to-user cluster-admin {{ ocp_username }}

- name: Setting up enable_modules for demo
  debug:
    msg: "Setting up workload enable_modules = {{ enable_modules }}"

- name: create module list
  set_fact:
    modules: "{{ enable_modules.split(';') | map('trim') | list }}"

- name: Selected Modules
  debug:
    msg: "selected modules list: {{ modules }}"

- name: Run shell 'oc' command to retrieve the cluster subdomain
  shell: "oc whoami --show-server | cut -d'.' -f 2,3,4,5,6 | cut -d':' -f 1"
  register: r_shell

- set_fact: subdomain_base={{ r_shell.stdout_lines[0] }}
- set_fact: ocp_apps_domain=apps.{{ subdomain_base }}

- name: Setting up subdomain_base and ocp_apps_domain
  debug:
    msg: "Setting up workload subdomain_base = {{ subdomain_base }} and ocp_apps_domain = {{ ocp_apps_domain }}"


###
# Projects
# - name: "Project Mercury :: Adding user projects - mercury, firstpass, bian, apiexchange"
#   include_tasks: create_project.yaml
#   vars:
#     user: "{{ ocp_username }}"
#     name: "{{ item }}"
#     display_name: "Project {{ item }}"
#   loop:
#     - "mercury"
#     - "firstpass"
#     - "bian"
#     - "apiexchange"

###
# 3scale Operator install
# ---
- name: 'Project Mercury :: Setting up the 3scale in the cluster'
  when:
    - ocp4_workload_threescale_registry_token is defined
  block:

  # create the "3scale" project and namespace
  - name: Create '3scale' project
    include_tasks: create_project.yaml
    vars:
      user: "{{ ocp_username }}"
      name: "3scale"
      display_name: "3scale Operator"

  # Sets up the RWX storage provider required for 3scale
  - name: Configure NFS Server workload to provide RWX storage class
    include_role:
      name: ocp4-workload-nfs-server

  # install 3scale operator
  - name: install 3scale operator
    include_tasks: threescale_workload.yaml

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
