---
# Implement your Workload removal tasks here

- name: Remove 3scale project and all created resources
  k8s:
    kind: Project
    api_version: project.openshift.io/v1
    name: 3scale
    state: absent
    wait: true

- name: Wait until all 3scale pods have been removed
  k8s_info:
    api_version: v1
    kind: Pod
    namespace: 3scale
  register: r_threescale_pods
  retries: 20
  delay: 5
  until: r_threescale_pods.resources | length == 0

- name: Gather 3scale remaining CRDs objects
  shell: oc get crd -o json | jq -r ".items[] | select(.spec.group==\"capabilities.3scale.net\") | .metadata.name" | jq -R -s -c '[split("\n")[] | select(length > 0)]'
  register: r_threescale_crds

- name: Remove 3scale custom resource definitions
  k8s:
    kind: CustomResourceDefinition
    api_version: apiextensions.k8s.io/v1
    name: "{{ item }}"
    state: absent
    wait: true
  with_items:
    # - "{{ _cluster_crds | to_json | from_json | json_query('[?spec.group==`capabilities.3scale.net`].metadata.name') }}"
    - "{{ r_threescale_crds.stdout | default([]) }}"
    - apis.capabilities.3scale.net
    - apimanagers.apps.3scale.net
    - bindings.capabilities.3scale.net
