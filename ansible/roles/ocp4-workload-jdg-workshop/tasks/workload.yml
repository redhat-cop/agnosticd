---
# vim: set ft=ansible

# Implement your Workload deployment tasks here

- name: Give access to opentlc-mgr
  shell: |
         oc adm policy add-cluster-role-to-user cluster-admin opentlc-mgr

- name: Create CatalogSource Index 4.7
  k8s:
    state: present
    merge_type:
    - strategic-merge
    - merge
    definition: "{{ lookup('file', item ) | from_yaml }}"
  loop:
  - redhat-operators-index.yaml
  - community-operators-index.yaml

- name: create projects for users userXX-{{ workshop_openshift_project_postfix }}
  include_tasks: create_project.yaml
  vars:
    user: "{{ item }}"
    name: "{{ item }}-{{ workshop_openshift_project_postfix }}"
  loop: "{{ users }}"

- name: create projects for users userXX-{{ workshop_openshift_project_postfix2 }}
  include_tasks: create_project.yaml
  vars:
    user: "{{ item }}"
    name: "{{ item }}-{{ workshop_openshift_project_postfix2 }}"
  loop: "{{ users }}"

- name: create guides project
  k8s:
    state: present
    kind: Project
    api_version: project.openshift.io/v1
    definition:
      metadata:
        name: "guides"
        annotations:
          openshift.io/description: ""
          openshift.io/display-name: "JDG Workshop Guides"

- name: search for guide
  k8s_facts:
    kind: DeploymentConfig
    name: web
    namespace: guides
  register: r_guide_dc

- name: create guides project
  when: num_users | int > 0
  k8s:
    state: present
    kind: Project
    api_version: project.openshift.io/v1
    definition:
      metadata:
        name: "guides"
        annotations:
          openshift.io/description: ""
          openshift.io/display-name: "Data Grid Workshop Guides"

- name: install guides
  include_tasks: install-guides.yaml

- name: install username distribution
  include_tasks: install-username-distribution.yaml

- name: Create ServiceAccount infinispan-monitoring
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: infinispan-monitoring
        namespace: default

- name: create monitoring for users
  include_tasks: install-monitoring.yaml
  vars:
    user: "{{ item }}"
    projectname: "{{ item }}-cache"
  loop: "{{ users }}"

- name: create monitoring cluster role view binding
  include_tasks: add-cluster-role-binding.yaml
  vars:
    user: "{{ item }}"
    projectname: "{{ item }}-cache"
  loop: "{{ users }}"

- name: Create user monitoring config map
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: cluster-monitoring-config
        namespace: openshift-monitoring
      data:
        config.yaml: |
          enableUserWorkload: true

- name: create datagrid for users in project cache
  include_tasks: install-datagrid.yaml
  vars:
    user: "{{ item }}"
    projectname: "{{ item }}-cache"
  loop: "{{ users }}"

- name: create datagrid for users in project cache2
  include_tasks: install-datagrid.yaml
  vars:
    user: "{{ item }}"
    projectname: "{{ item }}-cache2"
  loop: "{{ users }}"

- name: Look for serverless subscription
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: serverless-operator
    namespace: openshift-operators
  register: r_serverless_sub

- name: show existing serverless sub
  debug:
    msg: "existing serverless sub: {{ r_serverless_sub }}"

- name: Create OpenShift Objects for Serverless (knative)
  include_tasks: install-serverless.yaml

#Install CRW via operator
- name: see if codeready is installed
  k8s_facts:
    api_version: org.eclipse.che/v1
    kind: CheCluster
    name: codeready-workspaces
    namespace: codeready
  register: r_codeready_cr

- name: show codeready cr
  debug:
    msg: "existing codeready project: {{ r_codeready_cr }}"

- name: install codeready
  when: r_codeready_cr.resources | list | length == 0
  include_tasks: install-codeready.yaml

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent | bool
