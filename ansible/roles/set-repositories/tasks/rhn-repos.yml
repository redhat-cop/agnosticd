# vim: set ft=ansible:
---

- name: Force unregister before register
  command: "{{ item }}"
  args:
    warn: False
  with_items:
  - 'subscription-manager clean'
  - 'subscription-manager remove --all'
  - 'yum remove -y "katello-ca-consumer-*"'

- name: 'Register system using Red Hat Subscription Manager'
  redhat_subscription:
    state: present
    username: "{{ rhel_subscription_user }}"
    password: "{{ rhel_subscription_pass }}"
    pool_ids: "{{ rhsm_pool_ids }}"
    auto_attach: false

- name: "Build command line for repos to enable"
  set_fact:
    repos_params: "{{ repos_params|default('') }} --enable={{ item }}"
  with_items:
  - "{{ rhel_repos }}"

- name: "Run 'subscription-manager to disable/enable repos"
  command: "subscription-manager repos {{ repos_params }}"
  when:
  - repos_params is defined
  - repos_params | length > 0
