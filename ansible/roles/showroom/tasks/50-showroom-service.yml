---

# Orchestrate showroom containers and setup orchestration pre-requisites

- name: Insert showroom orchestration files, compose and systemd
  ansible.builtin.template:
    src: "{{ __orchestration.src }}"
    dest: "{{ __orchestration.dest }}"
    owner: "{{ __orchestration.owner | default(showroom_user) }}"
    group: "{{ __orchestration.group | default(showroom_user_group) }}"
    mode: "u=rw,g=r,o=r"
  loop:
    - src: "{{ showroom_container_compose_template | default('container-compose.yml.j2') }}"
      dest: "{{ showroom_user_home_dir }}/orchestration/container-compose.yml"
    - src: "{{ showroom_systemd_service_template | default('showroom.service.j2') }}"
      dest: "/etc/systemd/system/showroom.service"
      owner: root
      group: root
  loop_control:
    loop_var: __orchestration

- name: Setup showroom host for nginx for showroom_frontend_service
  when: showroom_frontend_service == "nginx"
  block:

    - name: Setup showroom host with nginx.conf
      ansible.builtin.template:
        src: nginx.conf.j2
        dest: "{{ showroom_user_home_dir }}/orchestration/nginx.conf"
        owner: "{{ showroom_user }}"
        group: "{{ showroom_user_group }}"
        mode: "u=rw,g=r,o=r"

- name: Setup showroom host for traefik for showroom_frontend_service
  when: showroom_frontend_service == "traefik"
  block:

    # TODO: Move this to 8443 after validation
    # IE eliminate the entire sysctl task once verified and tested

    - name: Allow users to open ports 80 and up without sudo etc
      ansible.posix.sysctl:
        name: net.ipv4.ip_unprivileged_port_start
        value: 80
        state: present
        reload: true

    - name: Enable and start podman.socket service for traefik
      ansible.builtin.service:
        name: podman.service
        enabled: true
        state: started

    - name: Enable showroom user lingering by touching the linger file
      ansible.builtin.file:
        path: "/var/lib/systemd/linger/{{ showroom_user }}"
        state: touch
        mode: "u=rw,g=r,o=r"

          # TODO: Placeholder if podman network needed for traefik
          # - name: Create traefik network showroom
          # bash equiv: podman network create showroom_network

    - name: Create acme.json for LetsEncypt called via traefik
      ansible.builtin.file:
        path: "{{ showroom_user_home_dir }}/orchestration/acme.json"
        state: touch
        mode: '0600'

- name: Enable and Start showroom service
  ansible.builtin.service:
    name: showroom.service
    enabled: true
    state: started
