---

- name: Implement internal sshkeys and configs for showroom access
  when: showroom_ssh_method == "password"
  block:

    - name: Enable ssh password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication yes'
        backrefs: true

    - name: Set correct password for showroom ssh accounts
      ansible.builtin.user:
        name: "{{ __showroom_lab_user }}"
        password: |-
          {{ showroom_user_password | default(common_password) | password_hash('sha512') }}
      loop: "{{ showroom_lab_users }}"
      loop_control:
        loop_var: __showroom_lab_user

- name: Implement internal sshkeys and configs for showroom access
  when: showroom_ssh_method == "sshkey"
  block:

    - name: Setup showroom user .ssh directory
      ansible.builtin.file:
        path: "{{ showroom_user_home_dir }}/.ssh"
        state: directory
        owner: "{{ showroom_user | default('showroom') }}"
        group: "{{ showroom_user_group | default('showroom') }}"
        mode: u=rwx,g-rwx,o-rwx

    - name: Generate an ed25519 OpenSSH keypair for showroom
      community.crypto.openssh_keypair:
        path: "{{ showroom_user_home_dir }}/.ssh/id_ed25519"
        type: ed25519
        comment: "{{ showroom_user }}@localhost.com"
      become_user: "{{ showroom_user }}"
      register: r_ssh_key

    - name: Inject sshkey into the showroom_lab_users authorized_keys
      ansible.posix.authorized_key:
        user: "{{ __showroom_lab_user }}"
        state: present
        key: "{{ r_ssh_key.public_key }}"
      loop: "{{ showroom_lab_users }}"
      loop_control:
        loop_var: __showroom_lab_user

    - name: Generate SSH config file for the showroom user
      ansible.builtin.template:
        src: ssh_config.j2
        dest: "{{ showroom_user_home_dir }}/.ssh/config"
        owner: "{{ showroom_user }}"
        group: "{{ showroom_user_group }}"
        mode: u=rw,g-rwx,o-rwx

- name: Restart sshd to pickup all/any changes
  ansible.builtin.systemd:
    name: sshd
    state: restarted

- name: Enable tmux if desired for better ssh UX
  when: showroom_ttys_enable_tmux
  block:

    - name: Insert the showroom-tmux script for tty ssh sessions etc
      ansible.builtin.copy:
        src: showroom-tmux
        dest: /usr/local/bin/showroom-tmux
        owner: root
        group: root
        mode: u=rwx,g=rx,o=rx

    - name: Setup mouse scrolling for tmux via user tmux.conf
      ansible.builtin.lineinfile:
        path: "/home/{{ __showroom_lab_user }}/.tmux.conf"
        line: "set -g mouse on"
        create: true
        mode: u=rw,g-rwx,o-rwx
        owner: "{{ __showroom_lab_user }}"
        group: users
      loop: "{{ showroom_lab_users }}"
      loop_control:
        loop_var: __showroom_lab_user
