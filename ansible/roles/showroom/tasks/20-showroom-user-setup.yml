---

# Create the showroom user and working directories

- name: "Create showroom user {{ showroom_user }}"
  ansible.builtin.user:
    name: "{{ showroom_user | default('showroom') }}"
    home: "{{ showroom_user_home_dir }}"
    uid: "{{ showroom_user_uid }}"
    password: "{{ common_password | password_hash('sha512') }}"

- name: Setup persistent working directory
  ansible.builtin.file:
    path: "{{ __showroom_work_dir }}"
    state: directory
    owner: "{{ showroom_user | default('showroom') }}"
    group: "{{ showroom_user_group | default('showroom') }}"
  loop: "{{ showroom_work_dirs }}"
  loop_control:
    loop_var: __showroom_work_dir

- name: Add passwordless sudo for {{ showroom_user }}
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: "^{{ showroom_user }}"
    line: "{{ showroom_user }} ALL=(ALL) NOPASSWD: ALL"

- name: User and system configuration when using traefik
  when: showroom_frontend_service == "traefik"
  block:

    # TODO: Move this to 8443 after validation
    # IE eliminate the entire sysctl task once verified and tested

    - name: Allow users to open ports 80 and up without sudo etc
      ansible.posix.sysctl:
        name: net.ipv4.ip_unprivileged_port_start
        value: 80
        state: present
        reload: true

    - name: Create acme.json for LetsEncypt called via traefik with correct permissions
      ansible.builtin.file:
        path: "{{ showroom_user_home_dir }}/orchestration/acme.json"
        state: touch
        owner: "{{ showroom_user }}"
        group: "{{ showroom_user_group }}"
        mode: u=rw,g-rwx,o-rwx

    - name: "Setup {{ showroom_user }} ssh directory"
      ansible.builtin.file:
        path: "{{ showroom_user_home_dir }}/.ssh"
        state: directory
        owner: "{{ showroom_user | default('showroom') }}"
        group: "{{ showroom_user_group | default('showroom') }}"
        mode: u=rw,go=

    - name: "Borrow {{ ansible_user }} authorized keys for {{ showroom_user }}"
      ansible.builtin.copy:
        src: "~{{ ansible_user }}/.ssh/authorized_keys"
        dest: "~{{ showroom_user }}/.ssh/authorized_keys"
        owner: "{{ showroom_user }}"
        mode: u=rw,go=
        remote_src: true

    - name: "Start --user {{ showroom_user }} podman.socket for traefik"
      ansible.builtin.shell: "loginctl enable-linger $USER; systemctl --user enable podman.socket --now"
      vars:
        ansible_user: "{{ showroom_user }}"
        remote_user: "{{ showroom_user }}"
      become: false

    - name: "Create a Podman network {{ showroom_podman_network }}"
      containers.podman.podman_network:
        name: "{{ showroom_podman_network | default('showroom_network') }}"
        state: present
      become_user: "{{ showroom_user }}"
