---

- name: Generate SSH keypair for use outside deployment
  community.crypto.openssh_keypair:
    path: "{{ generate_ssh_keypair_tmp_dir }}/id_rsa"
    force: true
  register: r_openssh_keypair

- name: Set facts for both public and private key
  ansible.builtin.set_fact:
    generate_ssh_keypair_public_key: "{{ r_openssh_keypair.public_key }}"
    generate_ssh_keypair_private_key: "{{ lookup('file', generate_ssh_keypair_tmp_dir + '/id_rsa') }}"

- name: Cleanup and delete ssh key file artifacts
  ansible.builtin.file:
    path: "{{ __key_file }}"
    state: absent
  loop:
    - "{{ generate_ssh_keypair_tmp_dir }}/id_rsa"
    - "{{ generate_ssh_keypair_tmp_dir }}/id_rsa.pub"
  loop_control:
    loop_var: __key_file

- name: Output ssh keypair as user data
  agnosticd_user_info:
    data:
      generated_ssh_public_key: "{{ generate_ssh_keypair_public_key }}"
      generated_ssh_private_key: "{{ generate_ssh_keypair_private_key }}"
