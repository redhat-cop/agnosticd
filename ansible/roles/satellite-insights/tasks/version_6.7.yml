---
- name: Set the branch_id to include the satellite uuid
  lineinfile:
    path: "/opt/theforeman/tfm/root/usr/share/gems/gems/redhat_access-2.2.8/app/services/redhat_access/telemetry/look_ups.rb"
    regexp: '^(\s+)branch_id ='
    line: '\1branch_id = "#{owner[''uuid'']}-#{Digest::SHA1.hexdigest(Setting[:instance_id])}"'
    backrefs: yes
  notify: restart satellite

- name: "Refresh the manifest to reset cdn url to default"
  theforeman.foreman.katello_manifest:
    username: "{{ satellite_admin }}"
    password: "{{ satellite_admin_password }}"
    server_url: "https://{{ publicname }}"
    validate_certs: no
    organization: "{{ org }}"
    repository_url: "https://cdn.redhat.com"
    manifest_path: "/tmp/{{ manifest_basename }}"
    state: present
