---

# The enmasse project now includes ansible playbooks.
# We'll download the enmasse source code to the local filesystem so as to be available to the ansible invoking this task
- stat: path=/tmp/enmasse-{{enmasse_tag}}.tgz
  register: enmasse_zip
  delegate_to: 127.0.0.1

- name: Download enmasse project
  get_url:
    url: https://github.com/EnMasseProject/enmasse/releases/download/{{enmasse_tag}}/enmasse-{{enmasse_tag}}.tgz
    dest: /tmp/enmasse-{{enmasse_tag}}.tgz
    mode: 0755
  when: enmasse_zip.stat.exists == False
  delegate_to: 127.0.0.1

- name: unzip enmasse project
  command: tar -zxvf /tmp/enmasse-{{enmasse_tag}}.tgz -C /tmp
  when: enmasse_zip.stat.exists == False
  delegate_to: 127.0.0.1

- name: modify hosts in enmasse playbook
  replace:
    path: "{{enmasse_path}}/ansible/playbooks/openshift/multitenant.yml"
    regexp: '^- hosts: localhost'
    replace: '- hosts: all'
  delegate_to: 127.0.0.1




# Project and user administration

- name: "Create project for workload {{namespace}}"
  shell: "oc new-project {{namespace}}"

- name: Give ocp_username access to ocp_project
  shell: "oc policy add-role-to-user admin {{ocp_username}} -n {{namespace}}"

- name: Make sure we go back to default project
  shell: "oc project default"

- name: annotate the project as requested by user
  shell: "oc annotate namespace {{namespace}} openshift.io/requester={{ocp_username}} --overwrite"

- name: Give ocp_username access to namespace
  shell: "oc policy add-role-to-user admin {{ocp_username}} -n {{namespace}}"

- name: workload Tasks Complete
  debug:
    msg: workload Tasks Complete

