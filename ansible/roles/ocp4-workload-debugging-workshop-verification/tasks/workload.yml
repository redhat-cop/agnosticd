---
# Implement your Workload deployment tasks here

# Check Workshop Infrastructure
- block:
  - name: "[{{ _workshop_infra_namespace }}] Reading deployments"
    k8s_info:
      api_version: v1
      kind: Deployment
      namespace: "{{ _workshop_infra_namespace }}"
    register: workshop_infra_verify_dc

  - fail:
      msg: "[{{ _workshop_infra_namespace }}] Some/all deployments are not ready"
    when: item.replicas != item.readyReplicas
    loop: "{{ workshop_infra_verify_dc|json_query('resources[*].status') }}"

# Check CodeReadyWorkspaces
- block:
  - name: "[{{ _crw_namespace }}] Reading deployments"
    k8s_info:
      api_version: v1
      kind: Deployment
      namespace: "{{ _crw_namespace }}"
    register: crw_verify_dc

  - fail:
      msg: "[{{ _crw_namespace }}] Some/all deployments are not ready"
    when: item.replicas != item.readyReplicas
    loop: "{{ crw_verify_dc|json_query('resources[*].status') }}"

# Check Istio
- block:
  - name: "[{{ _istio_namespace }}] Reading deployments"
    k8s_info:
      api_version: v1
      kind: Deployment
      namespace: "{{ _istio_namespace }}"
    register: istio_verify_dc

  - fail:
      msg: "[{{ _istio_namespace }}] Some/all deployments are not ready"
    when: item.replicas != item.readyReplicas
    loop: "{{ istio_verify_dc|json_query('resources[*].status') }}"


# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
