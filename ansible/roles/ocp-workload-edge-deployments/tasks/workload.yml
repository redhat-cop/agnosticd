---
# Implement your Workload deployment tasks here

- name: Setting up workload for user
  debug:
    msg: "Setting up workload for user ocp_username = {{ ocp_username }}"

- name: Create project for IoT Development
  shell: "oc new-project iot-development"

- name: Create resources for IoT Development
  shell: "oc process -f /tmp/{{guid}}/project-iot-development.yaml | oc create -f -"

- name: Create project for IoT Testing
  shell: "oc new-project iot-testing"

- name: Create resources for IoT Testing
  shell: "oc process -f /tmp/{{guid}}/project-iot-testing.yaml | oc create -f -"

- name: Create project for IoT Hub
  shell: "oc new-project iot-hub"

- name: Create resources for IoT Hub
  shell: "oc process -f /tmp/{{guid}}/project-iot-hub.yaml | oc create -f -"

- name: Create policy for letting Jenkins ServiceAccount Access to iot-testing Project
  shell: "oc policy add-role-to-user edit system:serviceaccount:iot-development:jenkins -n iot-testing"

- name: Generate a brand new SSH key for connecting to the remote machine
  shell: "cd /tmp/{{guid}}/deploy-containers-apb; ssh-keygen -N '' -f ./id_rsa"

- name: Get the Builder Token for injecting it in the Ansible Playbook Bundle (APB) configuration
  shell: "oc get $(oc get secret -n openshift -o name | grep builder-token | head -1) -n openshift -o yaml | grep token: | awk '{print $2;}' | base64 -d"
  register: tokenresult

- name: Setting the just acquired Builder Token in the APB configuration
  shell: "sed -i 's/YOUR_TOKEN_HERE/{{ tokenresult.stdout }}/g' /tmp/{{guid}}/deploy-containers-apb/playbooks/provision.yml"

- name: Setting the OCP Registry Address in the APB configuration
  shell: "sed -i 's/YOUR_OCP_ADDRESS_HERE/docker-registry-default.{{ ocp_apps_domain }}/g' /tmp/{{guid}}/deploy-containers-apb/playbooks/provision.yml"

- name: Setting the Endpoint for AMQ connections (supposing a Single Node Installation) in the APB configuration
  shell: "sed -i 's/TARGET_AMQ_BROKER/anything.{{ ocp_apps_domain }}/g' /tmp/{{guid}}/deploy-containers-apb/playbooks/provision.yml"

- name: Ensure that APB binary is installed
  yum:
    name: apb
    state: present

- name: Ready to prepare the APB build
  shell: "cd /tmp/{{guid}}/deploy-containers-apb; apb prepare"

- name: Create the APB build
  shell: "cd /tmp/{{guid}}/deploy-containers-apb; oc new-build --name deploy-containers-apb --allow-missing-images -n openshift ."

- name: Start the APB build and push process
  shell: "cd /tmp/{{guid}}/deploy-containers-apb; oc start-build -n openshift --follow --from-dir . deploy-containers-apb"

## We should handle the ssh-copy-id of the previously created SSH key on the remote host and in parallel also handling the setup of the external machine

- name: Annotate the completed iot-development project as requested by user
  shell: "oc annotate namespace iot-development openshift.io/requester={{ocp_username}} --overwrite"

- name: Annotate the completed iot-testing project as requested by user
  shell: "oc annotate namespace iot-testing openshift.io/requester={{ocp_username}} --overwrite"

- name: Annotate the completed iot-hub project as requested by user
  shell: "oc annotate namespace iot-hub openshift.io/requester={{ocp_username}} --overwrite"

- name: Give user access to the completed iot-development project
  shell: "oc policy add-role-to-user admin {{ocp_username}} -n iot-development"

- name: Give user access to the completed iot-testing project
  shell: "oc policy add-role-to-user admin {{ocp_username}} -n iot-testing"

- name: Give user access to the completed iot-hub project
  shell: "oc policy add-role-to-user admin {{ocp_username}} -n iot-hub"


- name: workload Tasks Complete
  debug:
    msg: workload Tasks Complete

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
