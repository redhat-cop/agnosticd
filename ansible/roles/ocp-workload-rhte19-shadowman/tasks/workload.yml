---
# Kafka
- name: Create Project demojam 
  shell: oc new-project demojam

- name: Create Cluster Operator Role
  shell: oc adm policy add-cluster-role-to-user strimzi-cluster-operator-namespaced --serviceaccount strimzi-cluster-operator -n demojam

- name: Create Entity Operator Role
  shell: oc adm policy add-cluster-role-to-user strimzi-entity-operator --serviceaccount strimzi-cluster-operator -n demojam

- name: Create Topic Operator Role
  shell: oc adm policy add-cluster-role-to-user strimzi-topic-operator --serviceaccount strimzi-cluster-operator -n demojam

- name: Install Cluster Operator
  shell: oc apply -f https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.14.0/strimzi-cluster-operator-0.14.0.yaml -n demojam

- name: Create Kafka Cluster
  shell: oc apply -f https://raw.githubusercontent.com/roller1187/kafka-workshop/master/setup/my-cluster.yaml -n demojam

- name: Wait for Secrets to be Available
  shell: oc wait --for=condition=Ready --timeout=120s pod/my-cluster-kafka-0

- name: Make Temp Directory
  file:
      path: /tmp/certs/
      state: directory

- name: Extract Secret
  shell: oc extract -n demojam secret/my-cluster-cluster-ca-cert --keys=ca.crt --to=- > /tmp/certs/ca.crt


# Directive Producer
- name: Create ConfigMap for Kafka
  shell: oc create configmap kafka-cert --from-file=/tmp/certs/ca.crt -n demojam

- name: Create Directive Producer Project
  shell: oc -n demojam new-app java:8~https://github.com/andykrohg/directive-producer.git

- name: Add ConfigMap to Producer
  shell: oc -n demojam set volume dc/directive-producer --add --type=configmap --configmap-name=kafka-cert --mount-path=/tmp/certs

- name: Expose Producer Route
  shell: oc -n demojam create route edge directive-producer --service directive-producer

# Slack Producer
- name: Deploy Slack Producer
  shell: |
        oc -n demojam new-app nodejs:10~https://github.com/tonykhbo/slack2node.git \
        --name=slack-producer --env SLACK_TOKEN=xoxp-3275597612-742553086596-760321623681-52ab6b7bef8ba4cba5739b51c4821299 \
        --env RED_CHANNEL_ID=CNSRA1WQM --env WHITE_CHANNEL_ID=CNE2Q20G2

# DemoJam Zombie App
- name: Create proxy.conf
  shell: echo -e RewriteRule ^/camel/rest/gameover/\(.*\) http://directive-producer:8080/camel/rest/gameOver/\$1 [P]\\nProxyPass \"/camel/rest/gameover/\" \"http://directive-producer:8080/camel/rest/gameOver/\" nocanon\\nProxyPassReverse \"/camel/rest/gameover/\"  \"http://directive-producer:8080/camel/rest/gameOver/\"\\nProxyRequests     Off\\nAllowEncodedSlashes NoDecode > ./proxy.conf

- name: Create Httpd ConfigMap 
  shell: oc create -n demojam configmap producer-url --from-file=./proxy.conf

- name: Create Application demojam-zombie
  shell: oc new-app -n demojam httpd:2.4~https://github.com/andykrohg/demojam-zombie.git

- name: Mount ConfigMap into demojam-zombie
  shell: oc -n demojam set volume dc/demojam-zombie --add --type=configmap --configmap-name=producer-url --mount-path=/opt/app-root/etc/httpd.d

- name: Expose demojam-zombie
  shell: oc -n demojam expose svc/demojam-zombie

# Landing Page
- name: Create Landing Page application
  shell: oc new-app -n demojam nodejs:10~https://github.com/tonykhbo/demojam.git --name=landing-page

- name: Expose Landing Page
  shell: oc -n demojam expose svc/landing-page

# Data Grid
- name: Load Data Grid Template
  shell: |
        oc create -n demojam -f \
        https://raw.githubusercontent.com/jboss-container-images/jboss-datagrid-7-openshift-image/7.3-v1.2/services/datagrid-service-template.yaml

- name: Create datagrid-service from template
  shell: oc new-app -n demojam datagrid-service -p APPLICATION_USER=datagrid -p APPLICATION_PASSWORD=hunter2

- name: Create datagrid-service hotrod route
  shell: oc create -n demojam route passthrough datagrid-service-hotrod --port=hotrod --service datagrid-service

- name: Expose datagrid-service on http
  shell: oc -n demojam expose svc/datagrid-service

- name: Expose datagrid-service ping
  shell: oc -n demojam expose svc/datagrid-service-ping




- name: workload Tasks Complete
  debug:
    msg: workload Tasks Complete
