---
# Kafka
- name: Create Project  
  shell: oc new-project {{ocp_project}}

- name: Create Cluster Operator Role
  shell: oc adm policy add-cluster-role-to-user strimzi-cluster-operator-namespaced --serviceaccount strimzi-cluster-operator -n {{ocp_project}}

- name: Create Entity Operator Role
  shell: oc adm policy add-cluster-role-to-user strimzi-entity-operator --serviceaccount strimzi-cluster-operator -n {{ocp_project}}

- name: Create Topic Operator Role
  shell: oc adm policy add-cluster-role-to-user strimzi-topic-operator --serviceaccount strimzi-cluster-operator -n {{ocp_project}}

- name: Install Cluster Operator
  shell: oc apply -f https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.14.0/strimzi-cluster-operator-0.14.0.yaml -n {{ocp_project}}

- name: Create Kafka Cluster
  shell: oc apply -f https://raw.githubusercontent.com/roller1187/kafka-workshop/master/setup/my-cluster.yaml -n {{ocp_project}}

- name: Extract Kafka Secret
  shell: oc extract -n {{ocp_project}} secret/my-cluster-cluster-ca-cert --keys=ca.crt --confirm=true
  register: result
  until: result.rc == 0
  retries: 5
  delay: 10

# Directive Producer
- name: Create ConfigMap for Kafka
  shell: oc -n {{ocp_project}} create configmap kafka-cert --from-file=./ca.crt -n {{ocp_project}}

- name: Get Kafka Route
  shell: oc -n {{ocp_project}} get route/my-cluster-kafka-bootstrap -o jsonpath='{.spec.host}'
  register: kafka_url 
  until: kafka_url.rc == 0
  retries: 5
  delay: 10

- name: Create Directive Producer Project
  shell: oc -n {{ocp_project}} new-app java:8~https://github.com/andykrohg/directive-producer.git -e KAFKA_BROKERS={{kafka_url.stdout}}:443

- name: Add ConfigMap to Producer
  shell: oc -n {{ocp_project}} set volume dc/directive-producer --add --type=configmap --configmap-name=kafka-cert --mount-path=/tmp/certs

- name: Expose Producer Route
  shell: oc -n {{ocp_project}} create route edge directive-producer --service directive-producer

# Slack Producer
- name: Deploy Slack Producer
  shell: |
        oc -n {{ocp_project}} new-app nodejs:10~https://github.com/tonykhbo/slack2node.git \
        --name=slack-producer --env SLACK_TOKEN={{slack_token}} \
        --env RED_CHANNEL_ID={{slack_red_channel}} --env WHITE_CHANNEL_ID={{slack_white_channel}}

# Landing Page
- name: Create Landing Page application
  shell: oc new-app -n {{ocp_project}} nodejs:10~https://github.com/tonykhbo/demojam.git --name=landing-page

- name: Get Producer URL
  shell: oc get route/directive-producer -n {{ocp_project}} -o jsonpath='{.spec.host}'
  register: remote_url

- name: Create Remote Config Map
  shell: oc -n {{ocp_project}} create configmap remote-link --from-literal=remote.txt=https://{{remote_url.stdout}}

- name: Add ConfigMap to Landing Page
  shell: oc -n {{ocp_project}} set volume dc/landing-page --add --type=configmap --configmap-name=remote-link --mount-path=/opt/app-root/src/public/config

- name: Expose Landing Page
  shell: oc -n {{ocp_project}} expose svc/landing-page

# DemoJam Zombie App
- name: Create proxy.conf
  shell: echo -e RewriteRule ^/camel/rest/gameover/\(.*\) http://directive-producer:8080/camel/rest/gameOver/\$1 [P]\\nProxyPass \"/camel/rest/gameover/\" \"http://directive-producer:8080/camel/rest/gameOver/\" nocanon\\nProxyPassReverse \"/camel/rest/gameover/\"  \"http://directive-producer:8080/camel/rest/gameOver/\"\\nProxyRequests     Off\\nAllowEncodedSlashes NoDecode > ./proxy.conf

- name: Create Httpd ConfigMap 
  shell: oc create -n {{ocp_project}} configmap producer-url --from-file=./proxy.conf

- name: Get Landing Page Route
  shell: oc -n {{ocp_project}} get route/landing-page -o jsonpath='{.spec.host}'
  register: join_link

- name: Create Join Link ConfigMap
  shell: oc -n {{ocp_project}} create configmap join-link --from-literal=link.txt=http://{{join_link.stdout}}

- name: Create Application demojam-zombie
  shell: oc new-app -n {{ocp_project}} httpd:2.4~https://github.com/andykrohg/demojam-zombie.git

- name: Mount Httpd ConfigMap into demojam-zombie
  shell: oc -n {{ocp_project}} set volume dc/demojam-zombie --add --type=configmap --configmap-name=producer-url --mount-path=/opt/app-root/etc/httpd.d

- name: Mount Join Link ConfigMap into demojam-zombie
  shell: oc -n {{ocp_project}} set volume dc/demojam-zombie --add --type=configmap --configmap-name=join-link --mount-path=/opt/app-root/src/config

- name: Expose demojam-zombie
  shell: oc -n {{ocp_project}} expose svc/demojam-zombie

- name: Get demojam-zombie Route
  shell: oc -n {{ocp_project}} get route/demojam-zombie -o jsonpath='{.spec.host}'
  register: demojam_url
  until: demojam_url.rc == 0
  retries: 5
  delay: 10

- name: Find demojam-zombie Pod Name
  command: "oc get pods -l app=demojam-zombie -o jsonpath={.items[0].metadata.name} -n {{ ocp_project }}"
  register: demojam_zombie_name
  until: demojam_zombie_name.rc == 0
  retries: 5
  delay: 10

# Data Grid
- name: Load Data Grid Template
  shell: |
        oc create -n {{ocp_project}} -f \
        https://raw.githubusercontent.com/jboss-container-images/jboss-datagrid-7-openshift-image/7.3-v1.2/services/datagrid-service-template.yaml

- name: Create datagrid-service from template
  shell: oc new-app -n {{ocp_project}} datagrid-service -p APPLICATION_USER=datagrid -p APPLICATION_PASSWORD=hunter2

- name: Create datagrid-service hotrod route
  shell: oc create -n {{ocp_project}} route passthrough datagrid-service-hotrod --port=hotrod --service datagrid-service

- name: Expose datagrid-service on http
  shell: oc -n {{ocp_project}} expose svc/datagrid-service

- name: Expose datagrid-service ping
  shell: oc -n {{ocp_project}} expose svc/datagrid-service-ping

- name: Extract Datagrid Secret
  command: oc extract secret/service-certs --keys=tls.crt --confirm=true -n {{ ocp_project }}
  register: result
  until: result.rc == 0
  retries: 5
  delay: 10

- name: Get Datagrid Route
  shell: oc -n {{ocp_project}} get route/datagrid-service-hotrod -o jsonpath='{.spec.host}'
  register: datagrid_url
  until: datagrid_url.rc == 0
  retries: 5
  delay: 10

- name: Find Directive Producer Pod Name
  command: "oc get pods -l app=directive-producer -o jsonpath={.items[0].metadata.name} -n {{ ocp_project }}"
  register: directive_producer_name
  until: directive_producer_name.rc == 0
  retries: 5
  delay: 10

- name: Wait Until Directive Producer is Ready
  command: "oc get pods -l app=directive-producer -o jsonpath={.items[0].status.containerStatuses[0].ready} -n {{ ocp_project }}"
  register: producer_container
  until: producer_container.stdout == "true"
  retries: 5
  delay: 10

- name: Download Directive Consumer Jar
  command: oc exec {{ directive_producer_name.stdout }} -n {{ ocp_project }} -- curl -Lo ./directive-consumer.jar https://github.com/andykrohg/directive-consumer/releases/download/1.0/directive-consumer-1.0.0.jar

- name: Extract Directive Consumer Jar
  command: oc exec {{ directive_producer_name.stdout }} -n {{ ocp_project }} -- jar -xf directive-consumer.jar BOOT-INF/classes

- name: Copy ca.crt into Directive Consumer Jar
  command: oc cp ./ca.crt {{ ocp_project }}/{{ directive_producer_name.stdout }}:/home/jboss/BOOT-INF/classes/ca.crt

- name: Copy tls.crt into Directive Consumer Jar
  command: oc cp ./tls.crt {{ ocp_project }}/{{ directive_producer_name.stdout }}:/home/jboss/BOOT-INF/classes/tls.crt

- name: Update Kafka Properties
  command: oc exec {{ directive_producer_name.stdout }} -n {{ ocp_project }} -- sed s/{kafka-host}/{{ kafka_url.stdout }}/g -i ./BOOT-INF/classes/kafka.properties

- name: Update Datagrid Properties
  command: oc exec {{ directive_producer_name.stdout }} -n {{ ocp_project }} -- sed s/{datagrid-host}/{{ datagrid_url.stdout }}/g -i ./BOOT-INF/classes/datagrid.properties

- name: Update Game Properties
  command: oc exec {{ directive_producer_name.stdout }} -n {{ ocp_project }} -- sed s/{game-url}/http:\\/\\/{{ demojam_url.stdout }}/g -i ./BOOT-INF/classes/game.properties

- name: Update Directive Consumer Jar
  command: oc exec {{ directive_producer_name.stdout }} -n {{ ocp_project }} -- jar -uf ./directive-consumer.jar BOOT-INF/classes

- name: Download Updated Jar from Directive Consumer
  command: oc rsync -n {{ ocp_project }} {{ directive_producer_name.stdout }}:/home/jboss/directive-consumer.jar .

- name: Serve Directive Consumer from demojam-zombie App
  command: oc cp ./directive-consumer.jar {{ ocp_project }}/{{ demojam_zombie_name.stdout }}:/opt/app-root/src/


- name: workload Tasks Complete
  debug:
    msg: workload Tasks Complete
