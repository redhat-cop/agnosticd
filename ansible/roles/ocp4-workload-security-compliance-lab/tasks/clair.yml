- name: populate clair config
  shell: "sed 's/<domain>/'$domain'/' <config-template.yaml > clair-config.yaml"
  args:
    chdir: "{{ tmp_dir}}/files"


# Create Clair secret
- name: create clair secret
  command: "{{ openshift_cli }} create secret generic clairsecret --from-file=clair-config.yaml -n quay-enterprise"
  args:
    chdir: "{{ tmp_dir }}/files"
  ignore_errors: true
        
- name: "Create the clair build config"
  command: "{{ openshift_cli }} new-build --name=clair --binary --strategy=docker -n quay-enterprise"
  ignore_errors: true

- name: "Copy over the clair Dockerfile"
  copy:
    src: Dockerfile-clair
    dest: "{{ tmp_dir }}/Dockerfile"

- name: "Build the clair image" 
  command: "{{ openshift_cli }} start-build --from-file={{ tmp_dir }}/Dockerfile bc/clair --follow --wait -n quay-enterprise"

# Deploy Clair
- name: Install clair
  command: "{{ openshift_cli }} create -f clair-kubernetes.yml -n quay-enterprise"
  args:
    chdir: "{{ tmp_dir}}/files"

# Wait for clair to deploy (TODO)
