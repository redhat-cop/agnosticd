- name: populate clair config
  shell: "sed 's/<domain>/'{{ ocp_apps_domain }}'/' <config-template.yaml > clair-config.yaml"
  args:
    chdir: "{{ tmp_dir}}/files"


# Create Clair secret
- name: create clair secret
  command: "{{ openshift_cli }} create secret generic clairsecret --from-file=config.yaml=clair-config.yaml -n quay-enterprise"
  args:
    chdir: "{{ tmp_dir }}/files"
  ignore_errors: true

- name: enable privileged scc
  command: "{{ openshift_cli }} adm policy add-scc-to-user privileged -z default -n quay-enterprise"

# Deploy Clair
- name: Install clair
  command: "{{ openshift_cli }} create -f clair-kubernetes.yml -n quay-enterprise"
  args:
    chdir: "{{ tmp_dir}}/files"

# Wait for clair to deploy
- name: wait for clair to deploy
  shell:  "{{ openshift_cli }} get pods | grep clair"
  register: result
  until: result.stdout.find("Running") != -1
  retries: 30
  delay: 10

# Expose clair route
- name: Expose clair
  command: "{{ openshift_cli }} expose svc/clairsvc"