---

- name: create the quay-enterprise project
  command: "{{ openshift_cli }} new-project quay-enterprise project"

- name: clone the quay operator project
  git:
    repo: git@github.com:sabre1041/quay-operator.git
    dest: "{{ tmp_dir }}"
    version: "master"

- name: Create openshift quay objects
  command: "{{ openshift_cli }} create -f {{ item }}"
  args:
    chdir: "{{ tmp_dir }}/quay-operator"
  with_items:
    - deploy/crds/cop_v1alpha1_quayecosystem_crd.yaml
    - deploy/service_account.yaml
    - deploy/cluster_role.yaml
    - deploy/cluster_role_binding.yaml
    - deploy/role.yaml
    - deploy/role_binding.yaml
    - deploy/operator.yaml

- name: create the quay secret for pulling the image
  command: >
    "{{ openshift_cli }} create secret docker-registry coreos-pull-secret 
     --docker-server=quay.io 
     --docker-username='{{ quay_pull_user }}' 
     --docker-password='{{ quay_pull_password }}'"

- name: deploy the quay operator
  command: "{{ openshift_cli }} create -f quay_cr.yml"
  args:
    chdir: "{{ tmp_dir}}/files"

- name: wait for quay to deploy
  shell:  "{{ openshift_cli }} get pods | grep quayecosystem-quay"
  register: result
  until: result.stdout.find("Running") != -1
  retries: 30
  delay: 10

