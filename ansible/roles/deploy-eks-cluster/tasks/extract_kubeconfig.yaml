---
- name: Create eks cred profile
  ansible.builtin.blockinfile:
    path: /home/ec2-user/.aws/credentials
    insertafter: 'EOF'
    marker: "# {mark} Role deploy-eks-cluster"
    block: |
      [eks]
      aws_access_key_id = {{ _eks_cluster_admin_access_key_id }}
      aws_secret_access_key = {{ _eks_cluster_admin_secret_access_key }}
      region = {{ aws_region }}

- name: Extract eks cluster kubeconfig
  ansible.builtin.command:
    cmd: >-
      /usr/local/bin/aws eks update-kubeconfig
      --name {{ deploy_eks_cluster_name }}
      --role-arn arn:aws:iam::{{ sandbox_account_id }}:role/eks-admin
      --profile eks
      --alias eks-admin

- name: Copy .kube/config to lab user
  become: true
  ansible.builtin.copy:
    src: /home/ec2-user/.kube/config
    dest: /home/{{ deploy_eks_cluster_extract_kubeconfig_username }}/.kube/config
    remote_src: true
    owner: "{{ deploy_eks_cluster_extract_kubeconfig_username }}"
    mode: 0600
