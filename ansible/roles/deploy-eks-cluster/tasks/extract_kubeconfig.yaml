---
- name: Create eks cred profile
  ansible.builtin.blockinfile:
    path: ~/.aws/credentials
    block: |
      [eks]
      aws_access_key_id = {{ hostvars.localhost.admin_access_key_id }}
      aws_secret_access_key = {{ hostvars.localhost.admin_secret_access_key }}
      region = {{ aws_region }}

- name: Extract eks cluster kubeconfig
  become: true 
  ansible.builtin.command:
    cmd: >-
      /usr/local/bin/aws eks update-kubeconfig
      --name {{ deploy_eks_cluster_name }}
      --role-arn arn:aws:iam::{{ sandbox_account_id }}:role/eks-admin
      --profile eks
      --alias eks-admin
      --kubeconfig /home/{{ deploy_eks_cluster_extract_kubeconfig_username }}/.kube/config
