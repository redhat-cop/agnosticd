---
# Implement your Workload removal tasks here

- name: Remove OpenShift Serverless projects and all created resources
  k8s:
    kind: Project
    api_version: project.openshift.io/v1
    name: "{{ item }}"
    state: absent
    wait: true
  loop:
    - knative-serving
    - knative-sources
    - knative-eventing

- name: Remove OpenShift Serverless Operator subscriptions
  k8s:
    kind: Subscription
    api_version: operators.coreos.com/v1alpha1
    name: serverless-operator
    namespace: openshift-operators
    state: absent
    wait: true

- name: Remove OpenShift Serverless Deployments .. CSVs
  k8s:
    kind: ClusterServiceVersion
    api_version: operators.coreos.com/v1alpha1
    name: serverless-operator.v1.7.1
    namespace: openshift-operators
    state: absent

- name: Gather CRDs with label 'knative.dev/crd-install=true'
  k8s_info:
    kind: CustomResourceDefinition
    api_version: apiextensions.k8s.io/v1
    label_selectors:
      - knative.dev/crd-install=true
  register: r_serverless_crds

- name: Remove OpenShift Serverless CRDs found
  k8s:
    kind: CustomResourceDefinition
    api_version: apiextensions.k8s.io/v1
    name: "{{ item.metadata.name | default(item) }}"
    state: absent
  with_items:
    - "{{ r_serverless_crds.resources | default(omit) }}"
    - knativeeventings.operator.knative.dev
    - knativeservings.operator.knative.dev