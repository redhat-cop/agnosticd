---
# Implement your Workload removal tasks here

- name: Setting up enable_modules for demo
  debug:
    msg: "Setting up workload enable_modules = {{ enable_modules }}"

- name: create module list
  set_fact:
    modules: "{{ enable_modules.split(';') | map('trim') | list }}"

- name: Run shell 'oc' command to retrieve the cluster subdomain
  shell: "oc whoami --show-server | cut -d'.' -f 2,3,4,5,6 | cut -d':' -f 1"
  register: r_shell

- set_fact: subdomain_base={{ r_shell.stdout_lines[0] }}
- set_fact: ocp_apps_domain=apps.{{ subdomain_base }}

- name: Setting up subdomain_base and ocp_apps_domain
  debug:
    msg: "Setting up workload subdomain_base = {{ subdomain_base }} and ocp_apps_domain = {{ ocp_apps_domain }}"

###
# Nexus operator removal
#
- name: 'Project Mercury :: Install the Nexus operator and deploy its server task'
  include_role:
    name: ocp4-workload-nexus-operator
  vars:
    become_override: yes
  when: ("nexus" in modules)

###
# OpenShift Serverless operator removal
#
- name: 'Project Mercury :: Run OpenShift Serverless removal Tasks when module is enabled'
  include_tasks:
    file: ./serverless_removal.yaml
    apply:
      become: "{{ become_override | bool }}"
  when: ("serverless" in modules)

###
# OpenShift ServiceMesh operator removal
#
- name: 'Project Mercury :: Run OpenShift ServiceMesh removal Tasks when module is enabled'
  include_tasks:
    file: ./servicemesh_removal.yaml
    apply:
      become: "{{ become_override | bool }}"
  when: ("servicemesh" in modules)

###
# OpenShift Pipelines operator removal
#
- name: 'Project Mercury :: Remove the OpenShift Pipelines operator task'
  include_role:
    name: ocp4-workload-pipelines
  vars:
    become_override: yes
  when: ("pipelines" in modules)

###
# 3scale Operator removal
#
- name: 'Project Mercury :: Run 3scale removal Tasks when module is enabled'
  include_tasks:
    file: ./threescale_removal.yaml
    apply:
      become: "{{ become_override | bool }}"
  when: ("3scale" in modules)

# Sets up the RWX storage provider required for 3scale
- name: Remove NFS Server workload that provides RWX storage class
  include_role:
    name: ocp4-workload-nfs-server
  vars:
    become_override: yes
    _nfs_provided_storage_class: "{{ _nfs_provided_storage_class }}"
  when: ("3scale" in modules)

###
# Mercury projects
# - name: "Project Mercury :: Remove users projects"
#   k8s:
#     kind: Project
#     api_version: project.openshift.io/v1
#     name: "{{ item }}"
#     state: absent
#     wait: true
#   loop:
#     - "mercury"
#     - "firstpass"
#     - "bian"
#     - "apiexchange"

# ###
# # Remove MachineConfig with DNS configuration when OpenTLC OpenStand environment
# - name: 'Project Mercury :: Removal of DNS configuration on OpenTLC environment'
#   k8s:
#     state: absent
#     definition: "{{ lookup('file', item ) | from_yaml }}"
#   loop:
#     - ./files/machineconfig-dns-master.yml
#     - ./files/machineconfig-dns-worker.yml
#   when: ("machineconfig" in modules) and (ocp_apps_domain.endswith(".opentlc.com"))

# - name: 'Project Mercury :: Removal of the OCP4 cluster autoscaler'
#   include_role:
#     name: ocp4-workload-cluster-autoscale
#   when: ("autoscale" in modules)



# Leave this as the last task in the playbook.
- name: remove_workload tasks complete
  debug:
    msg: "Remove Workload tasks completed successfully."
  when: not silent|bool
