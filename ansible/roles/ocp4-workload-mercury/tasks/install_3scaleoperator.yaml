---

# deploy the "threescale-registry-auth" secret
- name: Create the Secret object for 3scale registry authentication
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: threescale-registry-auth
        namespace: 3scale
      data:
        .dockerconfigjson: "{{ ocp4_workload_mercury_threescale_registry_token }}"
      type: kubernetes.io/dockerconfigjson

# deploy 3scale operator
- name: Create operator subscription for 3scale
  k8s:
    state: present
    merge_type:
    - strategic-merge
    - merge
    definition: "{{ lookup('file', item ) | from_yaml }}"
  loop:
  - ./files/3scale-operator-1-group.yaml
  - ./files/3scale-operator-2-subscription.yaml

# wait for CRD to be a thing
- name: Wait for 3scale CRD to be ready
  k8s_facts:
    api_version: apiextensions.k8s.io/v1beta1
    kind: CustomResourceDefinition
    name: apimanagers.apps.3scale.net
  register: r_crd
  retries: 60
  delay: 5
  until: r_crd.resources | list | length == 1