# vim: set ft=ansible
---
# Implement your Workload deployment tasks here

- name: create labguide project
  k8s:
    state: present
    definition:
      apiVersion: project.openshift.io/v1
      kind: Project
      metadata:
        name: labguide

- name: check if guide is deployed
  k8s_facts:
    api_version: apps.openshift.io/v1
    kind: DeploymentConfig
    name: "{{ _deployed_guide_name }}"
    namespace: labguide
  register: guide_exists

- name: fetch the string for passing to new-app
  uri: 
    url: "{{ _deployed_guide_string_url }}"
    return_content: true
  register: newapp_string
  when:
    - guide_exists.resources | list | length < 1

- name: deploy workshopper using the fetched string
  shell: "oc new-app -n labguide --name {{ _deployed_guide_name }} {{ newapp_string.content }}"
  when:
    - guide_exists.resources | list | length < 1

- name: lab guide route
  k8s:
    state: present
    definition:
      apiVersion: route.openshift.io/v1
      kind: Route
      metadata:
        labels:
          app: "{{ _deployed_guide_name }}"
        name: "{{ _deployed_guide_name }}"
        namespace: labguide
      spec:
        port:
          targetPort: 8080-tcp
        to:
          kind: Service
          name: "{{ _deployed_guide_name }}"
          weight: 100
        wildcardPolicy: None

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool

