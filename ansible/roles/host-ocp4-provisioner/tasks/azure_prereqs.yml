---
- name: Install required packages for Azure CLI
  package:
    name:
    - libffi
    - openssl
    - openssl-devel
    - python3
    - python3-devel
    - python3-pip

- name: Import Microsoft PKI
  shell: "sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc"

- name: Creating Azure CLI repo
  blockinfile:
    path: /etc/yum.repos.d/azure-cli.repo
    create: yes
    block: |-
      [azure-cli]
      name=Azure CLI
      baseurl=https://packages.microsoft.com/yumrepos/azure-cli
      enabled=1
      gpgcheck=1
      gpgkey=https://packages.microsoft.com/keys/microsoft.asc

- name: Install Azure CLI
  package:
    name: azure-cli

- name: Logging into Azure
  command: >-
    az login --service-principal
    -u {{ azure_service_principal | quote }}
    -t {{ azure_tenant | quote }}
    -p {{ azure_password | quote }}
  become: no

- name: Add osServicePrincipal.json file for OpenShift Installer
  template:
    src: "osServicePrincipal.json.j2"
    dest: "/home/{{ ansible_user }}/.azure/osServicePrincipal.json"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0600

