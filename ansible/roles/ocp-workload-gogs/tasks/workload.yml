---
# Implement your Workload deployment tasks here

- name: Setting up workload for user
  debug:
    msg: "Setting up workload for user ocp_username = {{ ocp_username }}"

- environment:
    KUBECONFIG: "{{ tmp_kubeconfig }}"
  block:
    - name: Create Project {{ gogs_project }}
      k8s:
        state: present
        definition: "{{ lookup('template', item ) | from_yaml }}"
      loop:
      - ./templates/project.j2
      register: r_createproject
      until: r_createproject is succeeded
      retries: 5

    - name: Get apps route suffix
      block:
        - k8s:
            state: present
            definition:
              apiVersion: "route.openshift.io/v1"
              kind: Route
              metadata:
                name: dummy
                namespace: "{{ gogs_project }}"
              spec:
                to:
                  kind: Service
                  name: dummy
                ports:
                - targetPort: 8080
        - k8s_facts:
            api_version: "route.openshift.io/v1"
            kind: Route
            name: dummy
            namespace: "{{ gogs_project }}"
          register: dummy_route
        - set_fact:
            apps_hostname_suffix: "{{ dummy_route.resources[0].spec.host|regex_replace('^dummy-' + gogs_project + '\\.(.*)$', '\\1') }}"
        - k8s:
            state: absent
            api_version: "route.openshift.io/v1"
            kind: Route
            name: dummy
            namespace: "{{ gogs_project }}"
        - set_fact:
            gogs_hostname: "{{ gogs_app_name }}-{{ gogs_project }}.{{ apps_hostname_suffix }}"

    - name: Create OpenShift objects for workload
      k8s:
        state: present
        definition: "{{ lookup('template', item ) | from_yaml }}"
      loop:
      - ./templates/service_account.j2
      - ./templates/pvc_data.j2
      - ./templates/pvc_postgresql_data.j2
      - ./templates/configmap_app.j2
      - ./templates/deployment_postgresql.j2
      - ./templates/service_postgresql.j2
      - ./templates/deployment_app.j2
      - ./templates/service_app.j2
      - ./templates/route.j2

    - name: wait for gogs to be running
      uri:
        url: http://{{ gogs_hostname }}
        status_code: 200
      register: result
      until: result.status == 200
      retries: "{{ gogs_deploy_retry_count }}"
      delay: "{{ gogs_deploy_retry_delay }}"

    # Create gogs admin user
    - name: create gogs admin user '{{ gogs_admin_user }}'
      uri:
        url: http://{{ gogs_hostname }}/user/sign_up
        method: POST
        body: "user_name={{ gogs_admin_user }}&password={{ gogs_admin_password }}&&retype={{ gogs_admin_password }}&&email={{ gogs_admin_user }}@gogs.com"
        headers:
          Content-Type: "application/x-www-form-urlencoded"
        status_code: 302,200

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
