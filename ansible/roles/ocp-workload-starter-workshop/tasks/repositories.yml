---
- name: projects Tasks Started
  debug:
    msg: "projects Tasks - Started"

#####
#
- name: wait for gogs to be running
  uri:
    url: http://{{ gogs_hostname }}
    status_code: 200
  register: result
  until: result.status == 200
  retries: "30"
  delay: "10"
  tags: gogs

# TODO: 
#Â Clone project per user in gogs

- name: check if repository exists in git
  uri:
    url: http://{{ gogs_hostname }}/api/v1/repos/{{ user_gogs_user }}/{{ reponame}}
    user: "{{ user_gogs_user }}"
    password: "{{ user_gogs_password }}"
    force_basic_auth: true
    status_code: 200,404
  register: repo_result
  tags: gogs

- name: create catalog git repository
  uri:
    url: http://{{ gogs_hostname }}/api/v1/user/repos
    method: POST
    body: '{"name": "catalog", "private": false}'
    body_format: json
    user: "{{ user_gogs_user }}"
    password: "{{ user_gogs_password }}"
    status_code: 200,201
    force_basic_auth: true
  when: repo_result.status != 200
  tags: gogs

- name: create temporary git directory
  tempfile:
    state: directory
    prefix: projects-git
  register: git_dir
  when: repo_result.status != 200
  tags: gogs

- name: unarchive projects source archive
  unarchive:
    remote_src: yes
    src: "https://github.com/{{ github_account }}/rhsummit18-cloudnative-labs/archive/{{ github_ref }}.zip"
    dest: "{{ git_dir.path }}"
  when: repo_result.status != 200
  tags: gogs

- name: push catalog to git repository in Gogs
  shell: |
    git init
    git remote add origin http://{{ user_gogs_user }}:{{ user_gogs_password }}@{{ gogs_hostname }}/{{ user_gogs_user }}/catalog.git
    git add . --all
    git config user.email "rhdeveloper@redhat.com"
    git config user.name "rh-developer"
    git commit -m "Initial add"
    git push origin master
  args:
    chdir: "{{ git_dir.path }}/rhsummit18-cloudnative-labs-{{ github_ref }}/catalog"
  when: repo_result.status != 200
  tags: gogs
#
#####

- name: projects Tasks Complete
  debug:
    msg: "projects Tasks - Completed"
