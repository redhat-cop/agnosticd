---
- name: infrastructure Tasks Started
  debug:
    msg: "infrastructure Tasks - Started"

#####
#

# Make sure admin project exists, or else, create it
- name: check if project {{ admin_project }} exists
  shell: oc get project {{ admin_project }}
  register: shared_project_result
  ignore_errors: true
  changed_when: false

- name: create project {{ admin_project }}
  shell: oc new-project {{ admin_project }}
  when: shared_project_result|failed

# Add imagestreams/templates
- name: Add firepad template to {{ admin_project }}
  shell: oc apply -f /tmp/{{guid}}/firepad-template.yml -n {{ admin_project }}
  ignore_errors: yes
- name: Add guides template to {{ admin_project }}
  shell: oc apply -f /tmp/{{guid}}/guides-template.yml -n {{ admin_project }}
  ignore_errors: yes

# Deploy Gogs
- import_role:
    name: siamaksade.openshift_gogs
  vars:
    project_name: "{{ admin_project }}"
    gogs_route: "{{ gogs_hostname }}"
    gogs_image_version: 0.11.34
    gogs_admin_user: "{{ user_gogs_admin }}"
    gogs_admin_password: "{{ user_gogs_password }}"
    gogs_user: "{{ user_gogs_user }}"
    gogs_password: "{{ user_gogs_password }}"
    gogs_generate_user_count: "{{ user_count_end }}"
    gogs_generate_user_format: "{{ user_format }}"
    clean_deploy: true
  tags: gogs

# Deploy Firepad
- name: Install firepad
  shell: oc new-app pad --name=pad -n {{ admin_project }}
  ignore_errors: yes

# Deploy Workshopper
- name: Add guides and configmap
  shell: |
         oc new-app guide \
         -p HOSTNAME={{ guide_hostname }} \
         -p CONSOLE_ADDRESS={{ openshift_master }} \
         -p ROUTER_ADDRESS={{ ocp_apps_domain }} \
         -p GITLAB_URL_PREFIX={{ gogs_urlprefix }} \
         -p PAD_URL_PREFIX={{ pad_urlprefix }} \
         -n {{ admin_project }}
  ignore_errors: yes

# Deploy nexus
- import_role:
    name: siamaksade.openshift_sonatype_nexus
  vars:
    project_name: "{{ admin_project }}"
    nexus_image_version: 3.10.0
    nexus_volume_capacity: 5Gi
  tags: gogs

#
#####

- name: infrastructure Tasks Complete
  debug:
    msg: "infrastructure Tasks - Completed"
