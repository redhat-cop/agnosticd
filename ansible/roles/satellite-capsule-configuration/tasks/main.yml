---

- name: Download Cert from Satellite
  get_url:
    url: "https://satellite1.{{guid}}.internal/pub/katello-ca-consumer-latest.noarch.rpm"
    dest: /root/katello-ca-consumer-latest.noarch.rpm
    mode: 0664
    validate_certs: no

- name: Install CA certificate
  yum:
    name: /root/katello-ca-consumer-latest.noarch.rpm
    state: present

- name: Install certs
  # use rpm here to avoid issue when yum is broken (chicken&egg)
  yum:
    name:  "/root/katello-ca-consumer-latest.noarch.rpm"
    state: present

- name: Delete Cert Package
  file:
    name: /root/katello-ca-consumer-latest.noarch.rpm
    state: absent

- name: Register with activation-key
  redhat_subscription:
    state: present
    server_hostname: "satellite1.{{guid}}.internal"
    activationkey: "{{activation_key_name}}"
    org_id: "Default_Organization"