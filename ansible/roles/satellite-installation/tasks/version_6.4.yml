---
- name: Setting up facts for public hostname
  set_fact:
      publicname: "{{ inventory_hostname | regex_replace('.internal',subdomain_base_suffix) }}"
  tags:
    - install_satellite
    - public_hostname
    
- name: Reset internal hostname to public hostname
  hostname:
    name: "{{ publicname }}"
  tags:
    - install_satellite
    - public_hostname

- name: Add public hostname name in hosts file
  lineinfile: 
    dest: /etc/hosts 
    state: present 
    insertafter: EOF 
    line: "{{ ansible_default_ipv4['address'] }}  {{ publicname }}"
  tags:
    - install_satellite
    - public_hostname

- name: Update system
  package: 
    name: '*'
    state: latest
  tags:
    - install_satellite
    - update_satellite_host

- name: Install Satellite Package
  package: 
    name: satellite-6.4*.el7*
    state: present
  tags:
    - install_satellite

- name: configure satellite 
  command: >-
    satellite-installer --scenario satellite 
    --foreman-admin-username {{ satellite_admin }}
    --foreman-admin-password {{ satellite_admin_password }}
    --certs-cname {{inventory_hostname}}
  async: 3600
  poll: 36   
  tags:
    - install_satellite
    - setup_satellite
