---
# Implement your Workload removal tasks here

- name: Set up ocp4_workload_pipelines combined dictionary
  set_fact:
    ocp4_workload_pipelines: >-
      {{ ocp4_workload_pipelines_defaults
       | combine(ocp4_workload_pipelines_vars    | default( {} ),
                 ocp4_workload_pipelines_secrets | default( {}), recursive=true )
      }}

- name: Remove Pipelines Installation
  k8s:
    state: absent
    api_version: operator.tekton.dev/v1alpha1
    kind: Config
    name: cluster

- name: Get Installed CSV
  k8s_facts:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: openshift-pipelines-operator
    namespace: openshift-operators
  register: r_subscription

- name: Remove CSV
  when:
  - r_subscription.resources | length > 0
  - r_subscription.resources[0].status.currentCSV is defined
  - r_subscription.resources[0].status.currentCSV | length > 0
  k8s:
    state: absent
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    name: "{{ r_subscription.resources[0].status.currentCSV }}"
    namespace: openshift-operators

- name: Remove Subscription
  k8s:
    state: absent
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - ./templates/subscription.j2

- name: Remove openshift-pipelines project
  k8s:
    state: absent
    api_version: project.openshift.io/v1
    kind: Project
    name: openshift-pipelines

- name: Remove tkn and tkn bash completion
  become: true
  file:
    state: absent
    path: "{{ item }}"
  loop:
  - /usr/bin/tkn
  - /etc/bash_completion.d/tkn

- name: Remove Tekton CRDs
  k8s:
    state: absent
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: "{{ item }}"
  loop:
  - clustertasks.tekton.dev
  - conditions.tekton.dev
  - config.operator.tekton.dev
  - eventlisteners.tekton.dev
  - pipelineresources.tekton.dev
  - pipelineruns.tekton.dev
  - pipelines.tekton.dev
  - taskruns.tekton.dev
  - tasks.tekton.dev
  - triggerbindings.tekton.dev
  - triggertemplates.tekton.dev

# Leave this as the last task in the playbook.
- name: remove_workload tasks complete
  debug:
    msg: "Remove Workload tasks completed successfully."
  when: not silent|bool
