---
- name: Install cockpit console
  ansible.builtin.package:
    name: 
      - cockpit
      - cockpit-system
    state: present

- name: Copy controller key to cockpit 
  ansible.builtin.copy:
    src: "/etc/tower/tower.key"
    dest: "/etc/cockpit/ws-certs.d/00-signed.key"
    remote_src: true

- name: Copy controller cert to cockpit 
  ansible.builtin.copy:
    src: "/etc/tower/tower.cert"
    dest: "/etc/cockpit/ws-certs.d/00-signed.cert"
    remote_src: true

- name: Grab ec2 instances info
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key }}"
    AWS_REGION: "{{ aws_region }}"
  amazon.aws.ec2_instance_info:
  register: r_cockpit_instances
  delegate_to: localhost

- name: Print ec2 instances
  debug:
    msg: "{{ r_cockpit_instances }}"

- name: Setup cockpit/machines.d/99-webui.json file per student
  ansible.builtin.template:
    src: "student-99-webui.json.j2"
    dest: "/etc/cockpit/machines.d/99-webui.json"

- name: Enable and start cockpit console service
  ansible.builtin.service:
    name: cockpit.socket
    enabled: true
    state: started

- name: Enable and start cockpit for all nodes
  ansible.builtin.service:
    name: cockpit.socket
    enabled: true
    state: started
  delegate_to: "{{ item }}"
  loop: "{{ groups.nodes }}"

- name: print out user.info
  agnosticd_user_info:
    msg: |
      Cockpit URL: https://{{ groups['bastions'][0].split('.')[0] }}.{{ subdomain_base }}:9090/
      Cockpit User name: {{ student_name }}
      Cockpit User Password: {{ student_password }}

- name: Save user data
  agnosticd_user_info:
    data:
      cockpit_url: "https://{{ groups['bastions'][0].split('.')[0] }}.{{ subdomain_base }}:9090/"
      cockpit_user_name: "{{ student_name }}"
      cockpit_user_password: "{{ student_password }}"
