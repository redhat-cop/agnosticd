---
# Implement your Pre Workload deployment tasks here
- name: usercount debug
  debug:
    msg: "Debugging num_users {{ num_users }}"

- name: create usernames
  set_fact:
    users: "{{ users | default([]) + ['user'+item | string] }}"
  loop: "{{ range(1,((num_users | int) + 1)) | list }}"

# Figure out paths
- name: Get openshift console
  set_fact:
    console_url: "{{ query('kubernetes.core.k8s', api_version='config.openshift.io/v1', kind='Console', resource_name='cluster') | json_query('[0].status.consoleURL')  }}"

- name: Get openshift domain
  set_fact:
    route_subdomain: "{{ query('kubernetes.core.k8s', api_version='operator.openshift.io/v1', kind='IngressController', resource_name='default', namespace='openshift-ingress-operator') | json_query('[0].status.domain')  }}"

- name: extract api_url
  shell: oc whoami --show-server
  register: api_url_r

- name: set the master
  set_fact:
    api_url: "{{ api_url_r.stdout | trim }}"

- name: debug
  debug:
    msg: 
    - "Console URL: {{ console_url }}"
    - "API URL: {{ api_url }}"
    - "Route Subdomain: {{ route_subdomain }}"
    - "Admin username: {{ ocp_username }}"

- name: Fetch OpenShift cluster version
  set_fact:
    openshift_version: "{{ query('kubernetes.core.k8s', kind='ClusterOperator', resource_name='openshift-apiserver') | json_query('[0].status.versions[?name==`operator`].version | [0]') | split('.') | slice(2) | first | join('.') }}"
  when: (openshift_version is not defined) or (openshift_version | length == 0)

- name: debug
  debug:
    msg: "Setting up for OpenShift version: {{ openshift_version }}"

- name: debug values
  debug:
    msg:
    - "api URL: {{ api_url }}"
    - "console URL: {{ console_url }}"
    - "route subdomain: {{ route_subdomain }}"
    - "ocp_username: {{ ocp_username }}"

# Leave this as the last task in the playbook.
- name: pre_workload tasks complete
  debug:
    msg: "Pre-Workload tasks completed successfully."
  when: not silent|bool
