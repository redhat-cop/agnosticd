# vim: set ft=ansible
---
# Implement your Workload deployment tasks here
- set_fact:
    f_user_name: "user{{ user_num }}"

- name: "Get {{ f_user_name }} S3 credentials for Jupyter"
  k8s_info:
    name: "{{ f_user_name }}-odh-obc"
    namespace: "{{ ocp4_workload_rhte_analytics_data_ocp_workshop_namespace }}"
    kind: Secret
  register: secret_out

- name: Set the user S3 secrets as facts
  set_fact:
    f_s3_access_key: "{{ secret_out.resources[0].data.AWS_ACCESS_KEY_ID | b64decode }}"
    f_s3_secret_key: "{{ secret_out.resources[0].data.AWS_SECRET_ACCESS_KEY | b64decode }}"

- name: "Create the JupyterHub Single User ConfigMap for {{ user_name }}"
  k8s:
    namespace: "{{ ocp4_workload_rhte_analytics_data_ocp_workshop_namespace }}"
    definition: "{{ lookup('template', 'jupyterhub-single-user-profile-user.configmap.yaml.j2') }}"
#
#- name: "Create the ImageStream for the notebook used in this workshop"
#  k8s:
#    state: present
#    namespace: "{{ project_name }}"
#    definition: "{{ lookup('template', 'workshop-notebook.imagestream.yaml.j2') }}"
#
#- name: "Create the JupyterHub Singleuser profile ConfigMap for this notebook workshop"
#  k8s:
#    state: present
#    namespace: "{{ project_name }}"
#    definition: "{{ lookup('template', 'jupyter-singleuser-profiles-workshop.yaml.j2') }}"

#- name: Deploy the Strimzi Cluster Operator
#  k8s:
#    state: present
#    namespace: "{{ project_name }}"
#    definition: "{{ lookup('template', 'kafka/strimzi-cluster-operator.deployment.yaml.j2') }}"
#
#- name: Create the ODH Custom Resource
#  k8s:
#    state: present
#    namespace: "{{ project_name }}"
#    definition: "{{ lookup('template', 'opendatahub_v1alpha1_opendatahub_cr.yaml.j2') }}"

# Leave this as the last task in the playbook.
- name: "{{ user_name }} tasks complete"
  debug:
    msg: "{{ user_name }} Tasks completed successfully."
  when: not silent|bool
