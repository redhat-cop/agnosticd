---
- name: Save output dir if archive file is defined
  when: agnosticd_save_output_dir_archive is defined
  block:
  - name: Create output_dir archive
    include_tasks:
      file: create-output-dir-archive.yml
      apply:
        delegate_to: localhost
        delegate_facts: true
        run_once: true
        become: false

  - name: Upload output_dir archive to S3
    when: agnosticd_save_output_dir_s3_bucket is defined
    include_tasks:
      file: upload-archive-s3.yml
      apply:
        delegate_to: localhost
        delegate_facts: true
        run_once: true
        become: false

  always:
  - name: Remove output_dir archive tempfile
    when: agnosticd_save_output_dir_archive_tempfile is defined
    file:
      path: "{{ agnosticd_save_output_dir_archive_tempfile }}"
      state: absent
    delegate_to: localhost
    run_once: true
    become: false

  - name: Remove output_dir encrypted archive tempfile
    when: agnosticd_save_output_dir_archive_password is defined
    file:
      path: "{{ agnosticd_save_output_dir_archive_tempfile }}.gpg"
      state: absent
    delegate_to: localhost
    run_once: true
    become: false
...
