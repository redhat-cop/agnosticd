---

- name: create project for user
  k8s:
    state: present
    definition: "{{ lookup('template', role_path ~ '/templates/namespace.j2' ) | from_yaml }}"

- name: delete existing limitrange
  k8s:
    state: absent
    namespace: "{{ ocp_project }}"
    name: "{{ ocp_project }}-core-resource-limits"
    api_version: v1
    kind: LimitRange

- name: create limitrange in namespace
  k8s:
    state: present
    namespace:  "{{ ocp_project }}"
    definition: "{{ lookup('template', role_path ~ '/templates/limitrange.j2' ) | from_yaml }}"

- name: create CRD for Fuse Online
  k8s:
    state: present
    definition: "{{ lookup('file', role_path ~ '/files/syndesis-crd.yml' ) | from_yaml }}"

- name: create syndesis installer role
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/syndesis-installer-role.yml' ) | from_yaml }}"

- name: "grant syndesis installer privileges to {{ ocp_username }}"
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('template', role_path ~ '/templates/syndesis-installer-rolebinding.j2' ) | from_yaml }}"

- name: install Syndesis serviceaccount
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/syndesis-serviceaccount.yml' ) | from_yaml }}"

- name: install Syndesis operator role
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/syndesis-operator-role.yml' ) | from_yaml }}"

- name: install Syndesis operator install rolebinding
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/syndesis-operator-install-rolebinding.yml' ) | from_yaml }}"

- name: install Syndesis operator
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/syndesis-operator.yml' ) | from_yaml }}"

- name: wait until Syndesis operator is deployed
  k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: syndesis-operator
    namespace: "{{ ocp_project }}"
  register: r_syndesis_operator_deployment
  retries: 50
  delay: 10
  until:
    - r_syndesis_operator_deployment.resources[0].status.readyReplicas is defined
    - r_syndesis_operator_deployment.resources[0].status.replicas is defined
    - r_syndesis_operator_deployment.resources[0].status.readyReplicas == r_syndesis_operator_deployment.resources[0].status.replicas  

- name: create image pull secret for registry.redhat.io
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/image-pull-secret.yml' ) | from_yaml }}"

- name: link secret to syndesis operator sa
  shell: oc secrets link syndesis-operator registry-credentials --for=pull -n {{ ocp_project }}

- name: link secret to builder sa
  shell: oc secrets link builder registry-credentials -n {{ ocp_project }}

- name: install Syndesis custom resource
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/syndesis-cr.yml' ) | from_yaml }}"

- name: check that Syndesis deployed correctly
  k8s_info:
    api_version: syndesis.io/v1alpha1
    kind: Syndesis
    name: app
    namespace: "{{ ocp_project }}"
  register: r_syndesis_cr
  retries: 180
  delay: 10
  until:
    - r_syndesis_cr.resources[0].status.phase is defined
    - r_syndesis_cr.resources[0].status.phase == "Installed"

# Coolstore Catalog Service
- name: add the view role to the default service account
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('file', role_path ~ '/files/role-default-view.yml' ) | from_yaml }}"

- name: create configmap for catalog service
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('template', role_path ~ '/templates/catalog-service-configmap.j2' ) | from_yaml }}"

- name: deploy the catalog service application
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('template', role_path ~ '/templates/coolstore-catalog-mongodb-persistent.j2' ) | from_yaml }}"  

- name: resume the catalog service
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    name: "{{ catalog_service_name }}"
    definition:
      apiVersion: apps.openshift.io/v1
      kind: DeploymentConfig
      spec:
        paused: false

- name: wait until catalog service is deployed
  k8s_info:
    api_version: apps.openshift.io/v1
    kind: DeploymentConfig
    name: "{{ catalog_service_name }}"
    namespace: "{{ ocp_project }}"
  register: r_catalog_service_deployment
  retries: 50
  delay: 10
  until:
    - r_catalog_service_deployment.resources[0].status.readyReplicas is defined
    - r_catalog_service_deployment.resources[0].status.replicas is defined
    - r_catalog_service_deployment.resources[0].status.readyReplicas == r_catalog_service_deployment.resources[0].status.replicas

- name: give user admin privileges in namespace
  k8s:
    state: present
    namespace: "{{ ocp_project }}"
    definition: "{{ lookup('template', role_path ~ '/templates/namespace-admin-rb.j2' ) | from_yaml }}"

- name: workload Tasks Complete
  debug:
    msg: workload Tasks Complete
