---

- name: Get enabled repos list from subscription 
  shell: >-
    hammer --output cve  
    repository list 
    --organization "{{org}}" |grep Name | awk -F'  +' '{print $2}' 
  register: repo_list
  ignore_errors: yes
  tags:
    - configure_satellite
    - configure_satellite_subscription
           
# - name: Print repos list
#   debug: 
#     var: repo_list.stdout_lines | d([])
#   tags:
#     - configure_satellite
#     - configure_satellite_subscription
     
# - name: Print repo names to be added
#   debug: 
#     msg: "{{ item.1.name | regex_replace('[()]')  + ' ' + item.1.basearch + ( ' ' if item.1.releasever|d(None)  else '')  +  item.1.releasever|d('')  }}"
#   loop: "{{ satellite_content | subelements('repos') }}"
#   tags:
#     - configure_satellite
#     - configure_satellite_subscription

- name: Setting up satellite repository 
  command: >-
    hammer repository-set enable 
    --organization "{{ org }}" 
    --product "{{ item.1.product }}" 
    --basearch "{{ item.1.basearch }}" 
    --name "{{ item.1.name }}" {% if item.1.releasever is defined %} --releasever '{{ item.1.releasever }}' {% endif %}
  when: 
    -  item.1.name | regex_replace('[()]')  + ' ' + item.1.basearch + ( ' ' if item.1.releasever|d(None)  else '')  +  item.1.releasever|d('')  not in repo_list.stdout_lines  | d([])
  loop: "{{ satellite_content | subelements('repos') }}"
  tags:
    - configure_satellite
    - configure_satellite_subscription


