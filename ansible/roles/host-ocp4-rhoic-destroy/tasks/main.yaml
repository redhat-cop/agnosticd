---
- name: Identify Resource Group info
  register: resource_group_info
  ibm.cloudcollection.ibm_resource_group_info:
    name: "{{ ibmcloud_resource_group_name }}"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"


- name: Identify VPC info
  register: vpc_info
  ibm.cloudcollection.ibm_is_vpc_info:
    name: "{{ vpc_name }}"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"

- name: Identify VPC Subnet info
  register: vpc_subnet_info
  ibm.cloudcollection.ibm_is_subnet_info:
    name: "{{ subnet_name }}"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"


- name: Check is cluster exists
  ibm.cloudcollection.ibm_container_vpc_cluster_info:
    name: "{{ cluster_name }}"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"
  failed_when:
    - cluster_output.rc != 0
    - '"cluster could not be found" not in cluster_output.stderr'
  register: cluster_output

- name: Delete Red Hat OpenShift Managed-Service cluster with VPC networking
  when: cluster_output.resource.id | default(False)
  ibm.cloudcollection.ibm_container_vpc_cluster:
    state: absent
    id: "{{ cluster_output.resource.id }}"
    resource_group_id: "{{ resource_group_info.resource.id }}"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"
    flavor: "{{ worker_profile }}"
    # vpc_id: "{{ vpc_info.resource.id }}"
    zones:
      - name: "{{ vpc_subnet_info.resource.zone }}"
        subnet_id: "{{ vpc_subnet_info.resource.id }}"
  register: cluster_create_output


- name: Delete Object Storage instance
  register: cos_instance_info
  ibm.cloudcollection.ibm_resource_instance:
    name: "{{ cos_instance_name }}"
    service: "cloud-object-storage"
    plan: "{{ cos_plan }}"
    location: "global"
    resource_group_id: "{{ resource_group_info.resource.id }}"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"
    state: absent

- name: Delete Public Gateway
  register: public_gateway_info
  ibm.cloudcollection.ibm_is_public_gateway:
    state: absent
    name: "{{ subnet_name }}-pgw"
    vpc: "{{ vpc_info.resource.id }}"
    resource_group: "{{ resource_group_info.resource.id }}"
    zone: "{{ region }}-1"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"

- name: Delete Subnet
  register: subnet_info
  ibm.cloudcollection.ibm_is_subnet:
    state: absent
    name: "{{ subnet_name }}"
    vpc: "{{ vpc_info.resource.id }}"
    resource_group: "{{ resource_group_info.resource.id }}"
    zone: "{{ region }}-1"
    total_ipv4_address_count: 256
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"

- name: Delete VPC
  register: vpc_info
  ibm.cloudcollection.ibm_is_vpc:
    state: absent
    name: "{{ vpc_name }}"
    resource_group: "{{ resource_group_info.resource.id }}"
    ibmcloud_api_key: "{{ ibmcloud_api_key }}"
