---
- name: Get CertificateSigningRequests that need to be approved
  k8s_info:
    api_version: certificates.k8s.io/v1beta1
    kind: CertificateSigningRequest
  register: r_csrs

- name: Approve CerrtificateSigningRequests
  when: r_csrs.resources | default([]) | length > 0
  block:
  - name: Approve all pending CertificateSigningRequests
    loop: "{{ r_csrs.resources | default([]) }}"
    command: "oc adm certificate approve {{ item.metadata.name }}"

  - name: Wait and recheck for more CertificateSigningRequests
    when: ocp4_approve_certificate_signing_requests_iteration < ocp4_approve_certificate_signing_requests_retries
    block:
    - name: Wait for additional CertificateSigningRequests to appear
      pause:
        seconds: "{{ ocp4_approve_certificate_signing_requests_recheck_delay }}"

    - name: Increment ocp4_approve_certificate_signing_requests_iteration
      set_fact:
        ocp4_approve_certificate_signing_requests_iteration: >-
          {{ 1 + ocp4_approve_certificate_signing_requests_iteration | int }}

    - name: Repeat CertificateSigningRequest approval
      include_tasks:
        file: approve-certificate-signing-requests.yml
...
