---
- name: "Creating common CRs"
  shell: "cat << EOF | oc apply -f -\n{{ lookup('template', item) }}\nEOF"
  with_items:
    - "namespace.yaml.j2"
    - "secret.yaml.j2"
    - "sa.yaml.j2"
  when: not mssql_workload_destroy|bool

- name: "Creating new scc"
  shell: "cat << EOF | oc apply -f -\n{{ lookup('template', item) }}\nEOF"
  with_items:
    - "scc.yaml.j2"
  ignore_errors: yes
  when: not mssql_workload_destroy|bool

- name: "Removing common CRs"
  shell: "cat << EOF | oc delete --ignore-not-found -f -\n{{ lookup('template', item) }}\nEOF"
  with_items:
    - "namespace.yaml.j2"
    - "sa.yaml.j2"
    - "scc.yaml.j2"
  when: mssql_workload_destroy|bool

- name: "{{ mssql_workload_title }} storage CRs"
  include_tasks: "./storage/{{ mssql_pv_provider }}/main.yml"

- name: "{{ mssql_workload_title }} application CRs"
  shell: "cat << EOF | oc apply -f -\n{{ lookup('template', item) }}\nEOF"
  with_items:
    - "deployment.yaml.j2"
    - "service.yaml.j2"
  when: not mssql_workload_destroy|bool

- name: "{{ mssql_workload_title }} MsSQL sample app CRs"
  shell: "cat << EOF | oc apply -f -\n{{ lookup('template', item) }}\nEOF"
  with_items:
    - "app/deployment.yaml.j2"
    - "app/service.yaml.j2"
    - "app/route.yaml.j2"
  when: not mssql_workload_destroy|bool

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool