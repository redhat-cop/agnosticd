---
- name: create /root/.ssh
  file:
    dest: /root/.ssh
    mode: 0700
    state: directory

- name: copy the environment .pem key
  become: true
  copy:
    src: "{{ env_authorized_key_path }}"
    dest: "/root/.ssh/{{ env_authorized_key }}.pem"
    owner: root
    group: root
    mode: 0400
  when: set_env_authorized_key|bool

- name: Generate pub key if it doesn't exist
  shell: >-
    ssh-keygen -y -f {{ env_authorized_key_path | quote }}
    > {{ env_authorized_key_path_pub | quote }}
  args:
    creates: "{{ env_authorized_key_path_pub }}"
  delegate_to: localhost

- name: copy the environment .pub key
  become: true
  copy:
    src: "{{ env_authorized_key_path_pub }}"
    dest: "/root/.ssh/{{ env_authorized_key }}.pub"
    owner: root
    group: root
    mode: 0400
  when: set_env_authorized_key|bool

- name: Set authorized key from file
  authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ lookup('file', env_authorized_key_path_pub) }}"

- name: Generate host .ssh/config Template
  become: false
  delegate_to: localhost
  run_once: true
  template:
    src: host_ssh_config.j2
    dest: "{{ output_dir }}/ssh-config-{{ env_type }}-{{ guid }}"

- name: copy over host .ssh/config Template
  become: true
  copy:
    src: "{{output_dir}}/ssh-config-{{ env_type }}-{{ guid }}"
    dest: /root/.ssh/config
    owner: root
    group: root
    mode: 0400
