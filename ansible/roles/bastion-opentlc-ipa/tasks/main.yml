#vim: set ft=ansible:
---
# tasks file for bastion

######################### Setting up environment for post deployment administration

- name: install ipa client packages
  yum:
    name: "ipa-client"
    state: present

- name: Register bastion with IPA
  shell: "/usr/sbin/ipa-client-install --domain=OPENTLC.COM -w {{ipa_host_password}} -N -U --mkhomedir --no-dns-sshfp --hostname={{bastion_public_dns_chomped}}"

- name: Add opentlc-access ipa group to sudoers.d
  lineinfile:
    path: /etc/sudoers.d/opentlc-sudoers
    state: present
    create: yes
    line: '%opentlc-access ALL=(ALL)       NOPASSWD: ALL'
    validate: '/usr/sbin/visudo -cf %s'


- name: copy over ipa_optimize.sh script
  copy:
    src: "{{ role_path }}/files/ipa_optimize.sh"
    dest: /opt/ipa_optimize.sh
    owner: root
    group: root
    mode: 0700
  notify: Run ipa_optimize.sh

- name: copy over fix_ipa.sh script
  copy:
    src: "{{ role_path }}/files/fix_ipa.sh"
    dest: /opt/fix_ipa.sh
    owner: root
    group: root
    mode: 0700

# ipa is working directly after ipa-client but after a while it fails.
# Restart fixes the issue (quick fix for now)
# run this task async so it does not stop the playbook
- name: restart sssd
  shell: sleep 120 && /opt/fix_ipa.sh
  async: 300
  poll: 10
