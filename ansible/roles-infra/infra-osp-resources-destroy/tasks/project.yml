- environment:
    OS_AUTH_URL: "{{ osp_auth_url }}"
    OS_USERNAME: "{{ osp_auth_username }}"
    OS_PASSWORD: "{{ osp_auth_password }}"
    OS_PROJECT_NAME: "{{ osp_project_name }}"
    OS_PROJECT_DOMAIN_ID: "{{ osp_auth_project_domain }}"
    OS_USER_DOMAIN_NAME: "{{ osp_auth_user_domain }}"
  block:
    - name: Get user info
      os_user_facts:
        name: "{{ guid }}-user"
        domain: default
      register: r_osp_user_info

    - name: Get UUID of user
      set_fact:
        osp_user_uuid: "{{ r_osp_user_info | json_query(uuid_query) }}"
      vars:
        uuid_query: ansible_facts.openstack_users[].id|[0]

    - name: Delete user keypair
      shell: nova keypair-delete --user {{ osp_user_uuid }} {{ guid }}-infra_key

    - name: Delete user
      os_user:
        state: absent
        name: "{{ guid }}-user"

    - name: Delete project
      os_project:
        name: "{{ osp_project_name }}"
        state: absent
      tags:
        - full_delete
