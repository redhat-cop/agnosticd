---
- name: Get Virtual Private Cloud (VPC) network
  ibm.cloudcollection.ibm_is_vpc_info:
    name: "{{ ibmcloud_vpc_name }}"
    #resource_group: "{{ r_ibmcloud_resource_group_id }}"
    region: "{{ ibmcloud_region }}"
  ignore_errors: true # TODO
  register: r_ibmcloud_vpc

- name: Delete Security Group
  when: r_ibmcloud_vpc is success
  ibm.cloudcollection.ibm_is_security_group:
    state: absent
    name: "{{ item.group_name }}"
    id: "{{ item.group_id }}"
    vpc: "{{ r_ibmcloud_vpc.resource.id }}"
    resource_group: "{{ r_ibmcloud_resource_group_id }}"
    region: "{{ ibmcloud_region }}"
  loop: "{{ r_ibmcloud_vpc.resource.security_group }}"

- name: Delete VPC Subnet
  when: r_ibmcloud_vpc is success
  ibm.cloudcollection.ibm_is_subnet:
    name: "{{ item.name }}"
    id: "{{ item.id }}"
    vpc: "{{ r_ibmcloud_vpc.resource.id }}"
    resource_group: "{{ r_ibmcloud_resource_group_id }}"
    state: absent
    zone: "{{ ibmcloud_availability_zone }}"
    region: "{{ ibmcloud_region }}"
  loop: "{{ r_ibmcloud_vpc.resource.subnets }}"

- name: Delete Virtual Private Cloud (VPC) network
  when: r_ibmcloud_vpc is success
  ibm.cloudcollection.ibm_is_vpc:
    name: "{{ ibmcloud_vpc_name }}"
    id: "{{ r_ibmcloud_vpc.resource.id }}"
    resource_group: "{{ r_ibmcloud_resource_group_id }}"
    state: absent
    region: "{{ ibmcloud_region }}"
