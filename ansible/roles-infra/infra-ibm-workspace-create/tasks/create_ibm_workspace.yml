---
- name: Get a list of workspaces
  command: >
    ibmcloud schematics workspace list -o json
  register: r_workspaces

- name: Check if workspace already exists (default to false)
  set_fact:
    workspace_exists: false

- name: Check if workspace already exists
  when: (r_workspaces.stdout | from_json).workspaces | json_query(workspace_query)
  set_fact:
    workspace_exists: true
  vars:
    workspace_query: >
      [?name=='{{ guid }}-workspace']

# I am not sure if we will ever need this and it doesn't work as is
# Error occurred while processing source URL https://. Error: Incorrect git URL https://
# For now, skip it
# - name: Set the workspace ID and update if it exists
#   when: workspace_exists
  # block:
  # - name: Set fact for workspace_id
  #   set_fact:
  #     workspace_id: "{{ (r_workspaces.stdout | from_json).workspaces | json_query(workspace_id_query) }}"
  #   vars:
  #     workspace_id_query: >
  #       [?name=='{{ guid }}-workspace'].id|[0]
  
  # - name: Debug workspace_id
  #   debug:
  #     var: workspace_id
  
  # - name: Update the existing workspace
  #   command: >
  #     ibmcloud schematics workspace update --id {{ workspace_id }} --file {{ ibm_cloud_workspace_config }} -o json
  #   register: r_existing_workspace

- name: Create the workspace if it does not exist
  when: not workspace_exists
  block:
  - name: Create the workspace
    command: >
      ibmcloud schematics workspace new --file {{ ibm_cloud_workspace_config }} -o json
    register: r_new_workspace
  - debug:
      var: (r_new_workspace.stdout | from_json)

  - name: Get the new workspace ID
    set_fact:
      workspace_id: "{{ (r_new_workspace.stdout | from_json).id }}"

  - debug:
      var: workspace_id
