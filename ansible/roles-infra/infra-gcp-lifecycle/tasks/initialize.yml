---
- environment:
    PATH: '{{ output_dir }}/google-cloud-sdk/bin:/usr/bin:/usr/local/bin'
    CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: "{{ gcp_credentials_file }}"
    CLOUDSDK_COMPUTE_REGION: "{{ gcp_region }}"
    CLOUDSDK_CONFIG: "{{ output_dir }}/.gcloud-{{ guid }}"
    CLOUDSDK_CORE_PROJECT: "{{ gcp_project_id }}"
  block:
    - name: Ensure gcloud is installed
      command: which gcloud
      register: gcloud_result

    - name: Fail if gcloud not available
      fail:
        msg: you need gcloud cli installed
      when: gcloud_result is failed

    - name: Get all instances that match the guid
      command: >-
        gcloud compute instances list --filter="name~'cluster-{{ guid }}'" --format="json(name,machineType,zone,status,networkInterfaces[0].accessConfigs[0].natIP)"
      register: allinstances
