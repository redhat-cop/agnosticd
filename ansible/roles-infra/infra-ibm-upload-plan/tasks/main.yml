---
- name: Creating tarball
  archive:
    path: "{{ ibm_cloud_template_config }}"
    dest: "{{ output_dir }}/{{cloud_provider}}_cloud_template.tar"
    format: tar

# I opened a case with IBM to know exactly what is happening here, we have an upload_file = 0, looks like some kind of internal validation is failing.
# Also and, of course..., there is no ansible module to upload or apply plans
- name: Upload plan to workspace
  command: >
    ibmcloud schematics workspace upload --id {{ workspace_id }} --template {{ workspace_id }} --file {{ output_dir }}/{{ cloud_provider }}_cloud_template.tar

# Because the dependency between the upload and plan creation-apply, the following lines are commented

# - name: Create the plan based on the template
#   command: >
#     ibmcloud schematics plan --id {{ workspace_id }} --output json

# - name: Apply the plan (Create the resources)
#   command: >
#     ibmcloud schematics apply --id {{ workspace_ id }} --force --output json