---
- name: install devspaces operator
  ansible.builtin.include_role:
    name: install_operator
  vars:
    install_operator_name: devspaces
    install_operator_namespace: "{{ ocp4_workload_devspaces_namespace }}"
    install_operator_csv_nameprefix: devspacesoperator
    install_operator_channel: "{{ ocp4_workload_devspaces_channel }}"
    install_operator_starting_csv: "{{ ocp4_workload_devspaces_startingcsv }}"
    install_operator_catalogsource_setup: true
    install_operator_catalogsource_image: "{{ ocp4_workload_devspaces_catalogsource_image }}"
    install_operator_catalogsource_image_tag: "{{ ocp4_workload_devspaces_catalogsource_tag }}"

- name: create checluster
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'checluster.yml.j2') | from_yaml }}"

- name: wait devspaces dashboard pod is ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    label_selectors:
      - component=devspaces-dashboard
    namespace: "{{ ocp4_workload_devspaces_namespace }}"
  register: r_devspaces_dashboard_pod
  failed_when: r_devspaces_dashboard_pod.resources[0].status.phase | default('') != 'Running'
  until: r_devspaces_dashboard_pod is successful
  delay: 10
  retries: 30

- name: create devworkspace
  when: ocp4_workload_devspaces_devworkspace | bool
  block:
    - name: create devworkspacetemplate
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', item) | from_yaml }}"
      loop:
        - namespace.yml.j2
        - devworkspacetemplate.yml.j2
    - name: pause 10 minutes
      ansible.builtin.pause:
        minutes: 10
    - name: create devworkspace
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'devworkspace.yml.j2') | from_yaml }}"
