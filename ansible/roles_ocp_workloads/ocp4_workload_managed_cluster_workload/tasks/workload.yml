---
# Implement your Workload deployment tasks here

- name: Setting up workload for user
  debug:
    msg: "Setting up workload for user ocp_username = {{ ocp_username }}"

- name: Set managed cluster variables
  set_fact:
    ocp4_workload_managed_cluster_name: "{{ item.managed_cluster_name }}"
    ocp4_workload_managed_cluster_kconf_path: "{{ item.managed_cluster_kconf_path | default('/home/ec2-user/.kube') }}"
  loop: "{{ acm_aws_clusters }}"

- name: Install managed cluster roles
  environment:
      KUBECONFIG: "{{ ocp4_workload_managed_cluster_kconf_path }}/{{ ocp4_workload_managed_cluster_name }}/kubeconfig"
  block:
    - name: Use context #we need to figure out how to do this in each role
      shell: oc config use-context "{{ ocp4_workload_managed_cluster_name }}"

    - name: Install Gitea Operator
      ansible.builtin.include_role:
        name: ocp4_workload_gitea_operator
      vars:
        ocp4_workload_gitea_operator_project: "{{ ocp4_workload_managed_cluster_gitea_operator_project }}"
        ocp4_workload_gitea_operator_catalog_image_tag: "{{ ocp4_workload_managed_cluster_gitea_operator_catalog_image_tag }}"
        ocp4_workload_gitea_operator_deploy_gitea_instance: "{{ ocp4_workload_managed_cluster_gitea_operator_deploy_gitea_instance }}"
        ocp4_workload_gitea_operator_gitea_image: "{{ ocp4_workload_managed_cluster_gitea_operator_gitea_image }}"
        ocp4_workload_gitea_operator_gitea_image_tag: "{{ ocp4_workload_managed_cluster_gitea_operator_gitea_image_tag }}"
        ocp4_workload_gitea_operator_name: "{{ ocp4_workload_managed_cluster_gitea_operator_name }}"
        ocp4_workload_gitea_operator_gitea_hostname: "{{ ocp4_workload_managed_cluster_gitea_operator_gitea_hostname }}"
        ocp4_workload_gitea_operator_gitea_volume_size: "{{ ocp4_workload_managed_cluster_gitea_operator_gitea_volume_size }}"
        ocp4_workload_gitea_operator_postgresql_volume_size: "{{ ocp4_workload_managed_cluster_gitea_operator_postgresql_volume_size }}"
        ocp4_workload_gitea_operator_ssl_route: "{{ ocp4_workload_managed_cluster_gitea_operator_ssl_route }}"
        ocp4_workload_gitea_operator_disable_registration: "{{ ocp4_workload_managed_cluster_gitea_operator_disable_registration }}"
        ocp4_workload_gitea_operator_enable_captcha: "{{ ocp4_workload_managed_cluster_gitea_operator_enable_captcha }}"
        ocp4_workload_gitea_operator_allow_create_organization: "{{ ocp4_workload_managed_cluster_gitea_operator_allow_create_organization }}"
        ocp4_workload_gitea_operator_register_email_confirm: "{{ ocp4_workload_managed_cluster_gitea_operator_register_email_confirm }}"
        ocp4_workload_gitea_operator_enable_notify_email: "{{ ocp4_workload_managed_cluster_gitea_operator_enable_notify_email }}"
        ocp4_workload_gitea_operator_mailer_enabled: "{{ ocp4_workload_managed_cluster_gitea_operator_mailer_enabled }}"
        ocp4_workload_gitea_operator_create_admin: "{{ ocp4_workload_managed_cluster_gitea_operator_create_admin }}"
        ocp4_workload_gitea_operator_admin_user: "{{ ocp4_workload_managed_cluster_gitea_operator_admin_user }}"
        ocp4_workload_gitea_operator_admin_email: "{{ ocp4_workload_managed_cluster_gitea_operator_admin_email }}"
        ocp4_workload_gitea_operator_admin_password: "{{ ocp4_workload_managed_cluster_gitea_operator_admin_password }}"
        ocp4_workload_gitea_operator_create_users: "{{ ocp4_workload_managed_cluster_gitea_operator_create_users }}"
        ocp4_workload_gitea_operator_user_number: "{{ ocp4_workload_managed_cluster_gitea_operator_user_number }}"
        ocp4_workload_gitea_operator_generate_user_format: "{{ ocp4_workload_managed_cluster_gitea_operator_generate_user_format }}"
        ocp4_workload_gitea_operator_user_password: "{{ ocp4_workload_managed_cluster_gitea_operator_user_password }}"
        ocp4_workload_gitea_operator_migrate_repositories: "{{ ocp4_workload_managed_cluster_gitea_operator_migrate_repositories }}"
        ocp4_workload_gitea_operator_repositories_list: "{{ ocp4_workload_managed_cluster_gitea_operator_repositories_list }}"

    - name: Install Pipelines
      ansible.builtin.include_role:
        name: ocp4_workload_pipelines
      vars:
        ocp4_workload_pipelines_channel: "{{ ocp4_workload_managed_cluster_pipelines_channel }}"
        ocp4_workload_pipelines_tkn_version: "{{ocp4_workload_managed_cluster_pipelines_tkn_version }}"
        ocp4_workload_pipelines_csv_nameprefix: "{{ ocp4_workload_managed_cluster_pipelines_csv_nameprefix }}"
        ocp4_workload_pipelines_use_catalog_snapshot: "{{ ocp4_workload_managed_cluster_pipelines_use_catalog_snapshot }}"
        ocp4_workload_pipelines_catalog_snapshot_image: "{{ ocp4_workload_managed_cluster_pipelines_catalog_snapshot_image }}"
        ocp4_workload_pipelines_catalog_snapshot_image_tag: "{{ ocp4_workload_managed_cluster_pipelines_catalog_snapshot_image_tag }}"

    - name: Install GitOps
      ansible.builtin.include_role:
        name: ocp4_workload_openshift_gitops
      vars:
        ocp4_workload_openshift_gitops_channel: "{{ ocp4_workload_managed_cluster_openshift_gitops_channel }}"
        ocp4_workload_openshift_gitops_pipelines_csv_prefix: "{{ ocp4_workload_managed_cluster_openshift_gitops_pipelines_csv_prefix }}"
        ocp4_workload_openshift_gitops_use_catalog_snapshot: "{{ ocp4_workload_managed_cluster_openshift_gitops_use_catalog_snapshot }}"
        ocp4_workload_openshift_gitops_catalogsource_name: "{{ ocp4_workload_managed_cluster_openshift_gitops_catalogsource_name }}"
        ocp4_workload_openshift_gitops_catalog_snapshot_image: "{{ ocp4_workload_managed_cluster_openshift_gitops_catalog_snapshot_image }}"
        ocp4_workload_openshift_gitops_catalog_snapshot_image_tag: "{{ ocp4_workload_managed_cluster_openshift_gitops_catalog_snapshot_image_tag }}"

    - name: Install MTA
      ansible.builtin.include_role:
        name: ocp4_workload_mta
      vars:
        ocp4_workload_mta_install_operator: "{{ ocp4_workload_managed_cluster_mta_install_operator }}"
        ocp4_workload_mta_print_access_information: "{{ ocp4_workload_managed_cluster_mta_print_access_information }}"

    - name: Install MTA Tackle
      ansible.builtin.include_role:
        name: ocp4_workload_mta_tackle
      vars:
        ocp4_workload_mta_tackle_print_access_information: "{{ ocp4_workload_managed_cluster_mta_tackle_print_access_information }}"
        ocp4_workload_mta_tackle_namespace: "{{ ocp4_workload_managed_cluster_mta_tackle_namespace }}"
        ocp4_workload_mta_tackle_seed: "{{ ocp4_workload_managed_cluster_mta_tackle_seed }}"

    - name: Install RHODS OLM
      ansible.builtin.include_role:
        name: ocp4_workload_rhods_olm
      vars:
        ocp4_workload_rhods_olm_install_operator_name: "{{ ocp4_workload_managed_cluster_rhods_olm_install_operator_name }}"
        ocp4_workload_rhods_olm_channel_name: "{{ ocp4_workload_managed_cluster_rhods_olm_channel_name }}"
        ocp4_workload_rhods_olm_operator_subscription_channel: "{{ ocp4_workload_managed_cluster_rhods_olm_operator_subscription_channel }}"
        ocp4_workload_rhods_olm_channel: "{{ ocp4_workload_managed_cluster_rhods_olm_channel }}"
        ocp4_workload_rhods_olm_odh_namespace: "{{ ocp4_workload_managed_cluster_rhods_olm_odh_namespace }}"
        ocp4_workload_rhods_olm_applications_namespace: "{{ ocp4_workload_managed_cluster_rhods_olm_applications_namespace }}"
        ocp4_workload_rhods_olm_monitoring_namespace: "{{ ocp4_workload_managed_cluster_rhods_olm_monitoring_namespace }}"
        ocp4_workload_rhods_olm_namespace_list: "{{ ocp4_workload_managed_cluster_rhods_olm_namespace_list }}"
        ocp4_workload_rhods_olm_catalogsource_name: "{{ ocp4_workload_managed_cluster_rhods_olm_catalogsource_name }}"
        ocp4_workload_rhods_olm_catalogsource_namespace: "{{ ocp4_workload_managed_cluster_rhods_olm_odh_namespace }}"
        ocp4_workload_rhods_olm_catalogsource_display_name: "{{ ocp4_workload_managed_cluster_rhods_olm_catalogsource_display_name "
        ocp4_workload_rhods_olm_catalog_snapshot_image: "{{ ocp4_workload_managed_cluster_rhods_olm_catalog_snapshot_image }}"
        ocp4_workload_rhods_olm_catalog_snapshot_image_tag: "{{ ocp4_workload_managed_cluster_rhods_olm_catalog_snapshot_image_tag }}"
        ocp4_workload_rhods_olm_starting_csv: "{{ ocp4_workload_managed_cluster_rhods_olm_starting_csv }}"
        ocp4_workload_rhods_olm_is_workshop: "{{ ocp4_workload_managed_cluster_rhods_olm_is_workshop }}"
        ocp4_workload_rhods_olm_workshop_num_users: "{{ ocp4_workload_managed_cluster_rhods_olm_workshop_num_users }}"
        ocp4_workload_rhods_olm_workshop_username_base: "{{ ocp4_workload_managed_cluster_rhods_olm_workshop_username_base }}"
        ocp4_workload_rhods_olm_workshop_password: "{{ ocp4_workload_managed_cluster_rhods_olm_workshop_password }}"


    - name: Install Big Demo
      ansible.builtin.include_role:
        name: ocp4_workload_big_demo
      vars:
        ocp4_workload_big_demo_gitea_user: "{{ ocp4_workload_managed_cluster_big_demo_gitea_user }}"
        ocp4_workload_big_demo_gitea_user_password: "{{ ocp4_workload_managed_cluster_big_demo_gitea_user_password }}"
        ocp4_workload_big_demo_gitea_webhook_secret: "{{ ocp4_workload_managed_cluster_big_demo_gitea_webhook_secret }}"
        ocp4_workload_big_demo_gitea_repo_object_detection: "{{ ocp4_workload_managed_cluster_big_demo_gitea_repo_object_detection }}"
        ocp4_workload_big_demo_gitea_repo_object_detection_branch: "{{ ocp4_workload_managed_cluster_big_demo_gitea_repo_object_detection_branch }}"

    - name: Install Object Detection AI ML Setup
      ansible.builtin.include_role:
        name: ocp4_workload_object_detection_ai_ml_setup
      vars:
        rhods_username: "{{ ocp4_workload_managed_cluster_rhods_username }}"
        ocp4_workload_aiml_namespace: "{{ ocp4_workload_managed_cluster_aiml_namespace }}"
        ocp4_workload_gitea_aiml_user: "{{ ocp4_workload_managed_cluster_gitea_aiml_user }}"
        ocp4_workload_big_demo_gitea_project: "{{ ocp4_workload_managed_cluster_big_demo_gitea_project }}"
        ocp4_workload_big_demo_gitea_instance: "{{ ocp4_workload_managed_cluster_big_demo_gitea_instance }}"

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent
