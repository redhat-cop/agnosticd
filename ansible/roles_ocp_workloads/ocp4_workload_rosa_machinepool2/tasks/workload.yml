---
- name: Setting up workload for user
  ansible.builtin.debug:
    msg: "Setting up workload for user ocp_username = {{ ocp_username }}"

- name: Get machinepool worker info
  ansible.builtin.command:
    cmd: >-
      /usr/local/bin/rosa describe machinepool worker
      --cluster={{ ocp4_workload_rosa_machinepool2_cluster_name }}
      --output=json
  register: _rosa_machinepool_worker

- name: Set _rosa_azs from machinepool worker info
  ansible.builtin.set_fact:
    _rosa_machinepool_azs: >-
      {{ _rosa_machinepool_worker.stdout | from_json | json_query('availability_zones') }}

- name: Set number of Machines desired per MachinePool, one for each AZ
  ansible.builtin.set_fact:
    _rosa_machines_per_pool: "{{ _rosa_machinepool_azs | length }}"

# create all the pools
    # with an include
    # put in our own label demo.redhat.com/metal
    #
# wait till all machines need not progress
    # probably don't need an include
    # select by label demo.redhat.com/metal
    # until:
    # all are
    # .status.phase Running
    # .status.phase Provisioned
    # .status.phase Failed
    # .status.phase Provisioning:
    # .status.providerstatus.conditions[0].status: "False"

     .status.providerStatus:
        conditions:
        - lastTransitionTime: "2025-01-17T20:35:53Z"
          message: "error creating EC2 instance: InsufficientInstanceCapacity: We currently
            do not have sufficient m5zn.metal capacity in the Availability Zone you requested
            (us-east-2a). Our system will be working on provisioning additional capacity.
            You can currently get m5zn.metal capacity by not specifying an Availability
            Zone in your request or choosing us-east-2b, us-east-2c.\n\tstatus code: 500,
            request id: 053c3cc0-7d00-402d-b321-7c0c6079d982"
          reason: MachineCreationFailed
          status: "False"
          type: MachineCreation

      conditions:
          lastTransitionTime: 2025-01-17T21:07:51Z
          message: error launching instance: You have requested more vCPU capacity
            than your current vCPU limit of 2000 allows for the instance bucket
            that the specified instance type belongs to. Please visit
            http://aws.amazon.com/contact-us/ec2-request to request an adjustment
            to this limit.
          reason: MachineCreationFailed
          status: False
          type: MachineCreation

      conditions:
      - lastTransitionTime: "2025-01-17T20:18:22Z"
        message: Machine successfully created
        reason: MachineCreationSucceeded
        status: "True"
        type: MachineCreation
#
# # - name: Make Machinepools
#
# - name: Check machinepools
#
# - name: Remake Machinepools
#

# # Only includes first available metal node from the list
# - ansible.builtin.include_tasks:
#     file: add_metal_node.yml
#   loop: "{{ ocp4_workload_rosa_machinepool_instance_types }}"
#   loop_control:
#     loop_var: _metal_node_type
#     index_var: _loop_index
#
# Leave this as the last task in the playbook.
# --------------------------------------------
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent | bool
