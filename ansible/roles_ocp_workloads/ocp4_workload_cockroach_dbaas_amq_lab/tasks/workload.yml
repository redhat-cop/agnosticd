---
- name: Setting up workload for user
  debug:
    msg: "Setting up workload for user ocp_username = {{ ocp_username }}"

- name: Create Cockroach SaaS database provider account
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: dbaas.redhat.com/v1beta1
      kind: DBaaSInventory
      metadata:
        name: cockroach-saas-provider
        namespace: openshift-dbaas-operator
        labels:
          related-to: dbaas-operator
          type: dbaas-vendor-service
      spec:
        credentialsRef:
          name: cockroach-saas-provider-credentials
        providerRef:
          name: cockroachdb-cloud-registration
        
- name: Get the uid in order to set the owner reference for the provider secret
  kubernetes.core.k8s_info:
    api_version: dbaas.redhat.com/v1beta1
    kind: DBaaSInventory
    name: cockroach-saas-provider
    namespace: openshift-dbaas-operator
  register: r_cockroach_dbaas_inventory

#- name: debug
#  ansible.builtin.debug:
#    var: r_cockroach_dbaas_inventory

- name: Create Cockroach SaaS database provider secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: cockroach-saas-provider-credentials
        namespace: openshift-dbaas-operator
        labels:
          db-operator/type: credentials
          related-to: dbaas-operator
        ownerReferences:
          - apiVersion: dbaas.redhat.com/v1beta1
            kind: DBaaSInventory
            name: cockroach-saas-provider
            uid: "{{ r_cockroach_dbaas_inventory.resources[0].metadata.uid }}"
      data:
        apiSecretKey: "{{ ocp4_workload_cockroach_dbaas_amq_lab_apikey | b64encode }}"


# Leave this as the last task in the playbook.
# --------------------------------------------
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
