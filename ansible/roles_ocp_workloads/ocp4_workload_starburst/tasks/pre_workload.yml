---

# The default bastion k8s virtualenv has kubernetes 11.0. and Ansible kubernets module requires 12.0.
# Recreating the virtualenv with correct kubernetes python library from ansible2.11-python3.8-2021-09-27.txt


- name: Set Ansible Python interpreter to /usr/bin/python
  set_fact:
      ansible_python_interpreter: "/usr/bin/python"

- name: remove existing k8s virtualenv 
  file:
    path: /opt/virtualenvs/k8s
    state: absent
  become: true
  when: remove_k83_venv == true

- name: manually create the initial k8s virtualenv
  command:
    cmd: python3 -m venv /opt/virtualenvs/k8s
    creates: "/opt/virtualenvs/k8s/bin/python"
  become: true

- name: Download requirements file ansible2.11-python3.8-2021-09-27.txt
  get_url:
    url: https://raw.githubusercontent.com/redhat-cop/agnosticd/development/tools/virtualenvs/ansible2.11-python3.8-2021-09-27.txt
    dest: /tmp/ansible2.11-python3.8-2021-09-27.txt

- name: install requirements in k8s virtualenv
  pip:
    requirements: /tmp/ansible2.11-python3.8-2021-09-27.txt
    virtualenv: /opt/virtualenvs/k8s
  become: true

- name: Set Ansible Python interpreter to k8s virtualenv
  set_fact:
      ansible_python_interpreter: "/opt/virtualenvs/k8s/bin/python"

- name: creating namespace
  kubernetes.core.k8s:
    name: "{{ starburst_sub_metadata_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: pre_workload Tasks Complete
  debug:
    msg: "Pre-Software checks completed successfully"