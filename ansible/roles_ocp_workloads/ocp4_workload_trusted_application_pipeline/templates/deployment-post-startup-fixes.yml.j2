apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: default
  name: post-startup-fixes
spec:
  selector:
    matchLabels:
      app: post-startup-fixes
  replicas: 1
  template:
    metadata:
      labels:
        app: post-startup-fixes
    spec:
      containers:
      - name: post-startup-fixes
        image: registry.redhat.io/openshift4/ose-tools-rhel9@sha256:8037187950e7374a9c9bec4996033c9b24ce374920ef29047d4f63b4c20f3e6b
        command:
        - /bin/bash
        args:
        - '-ec'
        - >-
          while true; do
            oc get deployment tekton-triggers-core-interceptors -n {{ ocp4_workload_trusted_application_pipeline_pipelines_namespace }} --no-headers > /dev/null 2>&1;
            if [[ $? != 0 ]]; then
              sleep 5;
              continue;
            fi

            echo "Found tekton-triggers-core-interceptors deployment";
            oc rollout status deployment tekton-triggers-core-interceptors -n {{ ocp4_workload_trusted_application_pipeline_pipelines_namespace }} | grep 'successfully rolled out' > /dev/null 2>&1;
            if [[ $? != 0 ]]; then
              sleep 5;
              continue;
            fi

            STATUS_CODE=$(curl -sk -o /dev/null -w "%{http_code}" {{ ocp4_workload_trusted_application_pipeline_central_host }}/v1/ping);
            echo Central Status Code: $STATUS_CODE;
            if [[ "${STATUS_CODE}" != "200" ]]; then
              sleep 5;
              continue;
            fi

            oc delete pod -l app=tekton-triggers-core-interceptors -n {{ ocp4_workload_trusted_application_pipeline_pipelines_namespace }} --ignore-not-found=true;
            break;
          done

          oc delete securedcluster stackrox-secured-cluster-services -n {{ ocp4_workload_trusted_application_pipeline_stackrox_namespace }} --ignore-not-found=true;
          while true; do
            RESPONSE=$(oc get securedcluster stackrox-secured-cluster-services -n {{ ocp4_workload_trusted_application_pipeline_stackrox_namespace }} --ignore-not-found=true);
            if [[ ! -z "${RESPONSE}" ]]; then
              sleep 5;
              continue;
            else
              break;
            fi
          done

          INIT_BUNDLES=$(curl -k -u admin:{{ ocp4_workload_trusted_application_pipeline_common_password }} {{ ocp4_workload_trusted_application_pipeline_central_host }}/v1/cluster-init/init-bundles);
          INIT_BUNDLES_LENGTH=$(echo $INIT_BUNDLES | jq '.items | length');
          INIT_BUNDLE_NAME=prod-{{ lookup('password', d '/dev/null chars=ascii_lowercase,digits length=8') }};

          if [[ "${INIT_BUNDLES_LENGTH}" == "1" ]]; then
            INIT_BUNDLE_ID=$(echo $INIT_BUNDLES | jq -r '.items[0].id');
            CLUSTER_ID=$(echo $INIT_BUNDLES | jq -r '.items[0].impactedClusters[0].id');
            curl -u admin:{{ ocp4_workload_trusted_application_pipeline_common_password }} -kv -X PATCH {{ ocp4_workload_trusted_application_pipeline_central_host }}/v1/cluster-init/init-bundles/revoke --data '{"ids": ["'"$INIT_BUNDLE_ID"'"], "confirmImpactedClustersIds": ["'"$CLUSTER_ID"'"]}';
          fi

          curl -u admin:{{ ocp4_workload_trusted_application_pipeline_common_password }} -k -X POST {{ ocp4_workload_trusted_application_pipeline_central_host }}/v1/cluster-init/init-bundles --data '{"name": "'"$INIT_BUNDLE_NAME"'"}' -o bundle-output.json;
          cat bundle-output.json | jq -r '.kubectlBundle' | base64 --decode > bundle.yaml;
          oc apply -f bundle.yaml -n {{ ocp4_workload_trusted_application_pipeline_stackrox_namespace }};

          oc apply -f /configs/secured-cluster.yml -n {{ ocp4_workload_trusted_application_pipeline_stackrox_namespace }}

          trap : TERM INT; sleep infinity & wait;
        volumeMounts:
        - name: secured-cluster-config-vol
          mountPath: /configs
      serviceAccount: default
      volumes:
      - name: secured-cluster-config-vol
        configMap:
          name: secure-cluster-config
  strategy:
    type: Recreate
