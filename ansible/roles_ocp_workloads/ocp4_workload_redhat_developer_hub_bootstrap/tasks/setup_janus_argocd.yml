---
- name: Install GitOps Helm Chart
  kubernetes.core.helm:
    state: present
    name: argocd
    namespace: janus-argocd
    chart_ref: ~/demo-setup/charts/gitops-operator
    values:
      namespaces:
        - janus-argocd
        - openshift-gitops
      projects:
        - name: janus
          namespace: janus-argocd
          role: automation
    create_namespace: true
  register: r_helm_gitops
  until: r_helm_gitops is not failed
  retries: 10
  delay: 10

- name: Install ArgoCD CLI
  ansible.builtin.shell: |
    ARGOCD_VERSION={{ ocp4_workload_redhat_developer_hub_bootstrap_argocd_cli_version }}
    curl -sSL -o /tmp/argocd-${ARGOCD_VERSION} https://github.com/argoproj/argo-cd/releases/download/${ARGOCD_VERSION}/argocd-linux-amd64
    chmod +x /tmp/argocd-${ARGOCD_VERSION}
    sudo mv /tmp/argocd-${ARGOCD_VERSION} /usr/local/bin/argocd

- name: Set common password for ArgoCD
  block:
    - name: Modify argocd-secret
      ansible.builtin.shell: |
        ARGOCD_PASSWORD=$(argocd account bcrypt --password {{ ocp4_workload_redhat_developer_hub_bootstrap_argocd_password }})
        oc -n janus-argocd patch secret argocd-secret \
        -p '{"stringData": {
          "admin.password": "'$ARGOCD_PASSWORD'",
          "admin.passwordMtime": "'$(date +%FT%T%Z)'"
        }}'
        oc -n openshift-gitops patch secret argocd-secret \
        -p '{"stringData": {
          "admin.password": "'$ARGOCD_PASSWORD'",
          "admin.passwordMtime": "'$(date +%FT%T%Z)'"
        }}'
      register: r_password_reset
      until:
        - r_password_reset is not failed
      retries: 120
      delay: 10

    - name: Modify argocd-cluster
      kubernetes.core.k8s:
        validate_certs: false
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            namespace: "{{ item }}"
            name: argocd-cluster
          data:
            admin.password: "{{ ocp4_workload_redhat_developer_hub_bootstrap_argocd_password | b64encode }}"
      loop:
        - openshift-gitops
        - janus-argocd
      register: r_password_reset
      until:
        - r_password_reset is not failed
      retries: 120
      delay: 10

- name: Wait until default project is ready
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: AppProject
    name: default
    namespace: openshift-gitops
  register: r_defaul_proj
  until:
    - r_defaul_proj is defined
    - r_defaul_proj.resources is defined
    - r_defaul_proj.resources | length > 0
  retries: 120
  delay: 10
