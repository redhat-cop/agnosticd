---
- name: Install GitOps Helm Chart
  kubernetes.core.helm:
    state: present
    name: argocd
    namespace: janus-argocd
    chart_ref: ~/demo-setup/charts/gitops-operator
    values:
      namespaces:
        - janus-argocd
        - openshift-gitops
      projects:
        - name: janus
          namespace: janus-argocd
          role: automation
    create_namespace: true
  register: r_helm_gitops
  until: r_helm_gitops is not failed
  retries: 10
  delay: 10

- name: Set common password for ArgoCD
  k8s:
    validate_certs: false
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        namespace: "{{ item }}"
        name: argocd-cluster
      data:
        admin.password: "{{ common_password | b64encode }}"
  loop:
    - openshift-gitops
    - janus-argocd