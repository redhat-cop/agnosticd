---
- name: Create sonataflow pre-requisites
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item) | from_yaml }}"
  loop:
  - templates/namespace-sonataflow.yml.j2
  - templates/network-policy-sonataflow.yml.j2
  - templates/secret-sonataflow-pgsql.yml.j2

- name: Install postgresql for sonataflow
  ansible.builtin.shell: |
    git clone {{ ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_helm_chart }}
    cd orchestrator-helm-chart/postgresql
    helm repo add bitnami https://charts.bitnami.com/bitnami
    helm install sonataflow-psql bitnami/postgresql --version {{
    ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_pgsql_version }} -n {{
    ocp4_workload_redhat_developer_hub_bootstrap_sonataflow_namespace }} -f ./values.yaml

- name: Install Orchestrator Operator
  block:
  - name: Install Orchestrator Operator
    ansible.builtin.include_role:
      name: install_operator
    vars:
      install_operator_action: install
      install_operator_name: orchestrator-operator
      install_operator_namespace: openshift-operators
      install_operator_channel: "{{ ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_operator_channel }}"
      install_operator_catalog: redhat-operators
      install_operator_packagemanifest_name: orchestrator-operator
      install_operator_automatic_install_plan_approval: true
      install_operator_csv_nameprefix: orchestrator-operator

- name: Install Orchestrator
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'orchestrator-rhdh.yml.j2') | from_yaml }}"

- name: Add Orchestrator workflows repository
  ansible.builtin.shell: |
    helm repo add orchestrator-workflows {{ ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_workflows.repo }}

- name: Install Orchestrator workflows
  ansible.builtin.shell: |
    helm install {{ item.name }} {{ item.location }} -n {{
    ocp4_workload_redhat_developer_hub_bootstrap_sonataflow_namespace }}
  loop: "{{ ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_workflows.chart }}"
  register: r_orch_workflow
  until: r_orch_workflow is not failed
  retries: 120
  delay: 10