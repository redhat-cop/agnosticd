- name: Create rhdh namespaces for all users
  vars:
    _ocp4_workload_mad_roadshow_namespace: >-
      {{ ocp4_workload_mad_roadshow_rhdh_namespace_prefix }}{{
          ocp4_workload_mad_roadshow_gitea_user_prefix }}{{ n }}
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'apps/namespace.yaml.j2' ) | from_yaml }}"
  loop: "{{ range(1, ocp4_workload_mad_roadshow_gitea_user_count | int + 1) | list }}"
  loop_control:
    loop_var: n
    label: "{{ ocp4_workload_mad_roadshow_gitea_user_prefix }}{{ n }}"

- name: Set up RHDH - Plugins
  when: ocp4_workload_rhdh | bool
  block:
  - name: Setup RHDH Plugins - Namespace
    vars:
      _ocp4_workload_mad_roadshow_namespace: "{{ ocp4_workload_mad_roadshow_rhdh_namespace }}"
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', 'apps/namespace.yaml.j2' ) | from_yaml }}"

- name: Set up RHDH - Configs
  when: ocp4_workload_rhdh | bool
  block:
  - name: Setup RHDH Config for all users
    vars:
      _ocp4_workload_mad_roadshow_rhdh_app_name: "{{ ocp4_workload_mad_roadshow_rhdh_app_name_config }}"
      _ocp4_workload_mad_roadshow_namespace: "{{ ocp4_workload_mad_roadshow_rhdh_namespace }}"
      _ocp4_workload_mad_roadshow_rhdh_repo_path_config: "{{ ocp4_workload_mad_roadshow_rhdh_repo_path_config }}"
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', 'rhdh/application_configs.yaml.j2' ) | from_yaml }}"

- name: Set up RHDevSpaces
  when: ocp4_workload_rhdh | bool
  vars:
    _ocp4_workload_mad_roadshow_devspaces_app_name: "{{ ocp4_workload_mad_roadshow_devspaces_app_name }}"
    _ocp4_workload_mad_roadshow_devspaces_namespace: "{{ ocp4_workload_mad_roadshow_devspaces_namespace}}" 
  block:
  - name: Setup RH Dev Spaces Operator
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', 'devspaces/application.yaml.j2' ) | from_yaml }}"   


- name: Setup RHDH Plugins for all users
  vars:
    _ocp4_workload_rhdh_pull_secret_token: "{{  ocp4_workload_rhdh_pull_secret_token  }}"
    _ocp4_workload_mad_roadshow_rhdh_app_name_plugins: "{{ ocp4_workload_mad_roadshow_rhdh_app_name_plugins }}"
    _ocp4_workload_mad_roadshow_rhdh_repo_path_plugins: "{{  ocp4_workload_mad_roadshow_rhdh_repo_path_plugins }}"
    _ocp4_workload_mad_roadshow_namespace: "{{ ocp4_workload_mad_roadshow_rhdh_namespace }}"
    _ocp4_workload_mad_roadshow_rhdh_pull_secret: "{{ ocp4_workload_mad_roadshow_rhdh_pull_secret }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'rhdh/application_plugins.yaml.j2' ) | from_yaml }}" 

- name: Setup variables
  include_tasks:
    file: ./rhdh-setup-variables.yml

- name: Setup GITLAB dependencies
  include_tasks:
    file: ./rhdh-setup-gitlab.yml

- name: Setup RHSSO with DEVHUB
  vars:
    _ocp4_workload_mad_roadshow_rhdh_repo_path_sso : "{{ ocp4_workload_mad_roadshow_rhdh_repo_path_sso }}"
    _ocp4_workload_mad_roadshow_rhdh_app_name_sso: "{{ ocp4_workload_mad_roadshow_rhdh_app_name_sso }}"
    _ocp4_workload_mad_roadshow_rhdh_namespace_sso: "{{ ocp4_workload_mad_roadshow_rhdh_namespace_sso }}"
    _ocp4_workload_mad_roadshow_namespace: "{{ ocp4_workload_mad_roadshow_rhdh_namespace }}"
    include_tasks:
    file: ./rhdh-setup-rhsso.yml

- name: Create RHDH application
  vars:
    _ocp4_workload_mad_roadshow_rhdh_app_name: "{{ ocp4_workload_mad_roadshow_rhdh_app_name }}"
    _ocp4_workload_mad_roadshow_namespace: "{{ ocp4_workload_mad_roadshow_rhdh_namespace }}"
  kubernetes.core.k8s:
    state: present                     
    definition: "{{ lookup('template', './templates/rhdh/application_rhdh.yaml.j2' ) | from_yaml }}"
    

