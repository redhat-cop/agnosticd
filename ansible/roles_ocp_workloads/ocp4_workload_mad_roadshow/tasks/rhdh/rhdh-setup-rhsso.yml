---
- name: Create RHSSO application
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'rhdh/application_rhdh_sso.yaml.j2' ) | from_yaml }}"

- name: Retrieve rhdh realm client credentials
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: keycloak-client-secret-rhdh
    namespace: "{{ ocp4_workload_mad_roadshow_rhdh_namespace }}"
  register: r_realm_credentials
  retries: 120
  delay: 10
  until:
  - r_realm_credentials is defined
  - r_realm_credentials.resources is defined
  - r_realm_credentials.resources | length > 0
  - r_realm_credentials.resources[0].data is defined
  - r_realm_credentials.resources[0].data.CLIENT_ID is defined
  - r_realm_credentials.resources[0].data.CLIENT_ID | length > 0
  - r_realm_credentials.resources[0].data.CLIENT_SECRET is defined
  - r_realm_credentials.resources[0].data.CLIENT_SECRET | length > 0

- name: Decode realm credentials
  set_fact:
    ocp4_workload_redhat_developer_hub_keycloak_client_id: "{{ r_realm_credentials.resources[0].data.CLIENT_ID | b64decode }}"
    ocp4_workload_redhat_developer_hub_keycloak_client_secret: "{{ r_realm_credentials.resources[0].data.CLIENT_SECRET | b64decode }}"
    ocp4_workload_redhat_developer_hub_oauth2Proxy_cookieSecret: ""

- name: Create Openshift SSO via Keycloak
  block:
  - name: Create keycloak auth resources
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', 'rhdh/application_rhdh_sso.yaml.j2' ) | from_yaml }}"
      namespace: "{{ ocp4_workload_mad_roadshow_rhdh_namespace }}"

