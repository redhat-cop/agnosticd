---
- name: Remove permissions from user to the folder
  community.vmware.vmware_object_role_permission:
    validate_certs: "{{ ocp4_workload_virt_roadshow_vmware_enable_cert_validation | bool }}"
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    state: absent
    role: "Read-Only"
    principal: "{{ _ocp4_workload_virt_roadshow_vmware_vcenter_user }}@{{ vcenter_domain }}"
    recursive: "False"
    object_name: "{{ ocp4_workload_virt_roadshow_vmware_vcenter_folder }}"
    object_type: "Folder"
  register: r_vmware_object_role_permission
  until: r_vmware_object_role_permission is success
  retries: 5
  delay: 5
  ignore_errors: true

- name: Remove permissions to newly created user to existing VMs
  community.vmware.vmware_object_role_permission:
    validate_certs: "{{ ocp4_workload_virt_roadshow_vmware_enable_cert_validation | bool }}"
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    state: absent
    role: "Read-Only"
    principal: "{{ _ocp4_workload_virt_roadshow_vmware_vcenter_user }}@{{ vcenter_domain }}"
    recursive: False
    object_name: "{{ ocp4_workload_virt_roadshow_vmware_vcenter_folder }}/{{ vm }}-{{ _ocp4_workload_virt_roadshow_vmware_vm_user }}"
    object_type: "VirtualMachine"
  register: r_vmware_object_role_permission
  until: r_vmware_object_role_permission is success
  retries: 5
  delay: 5
  loop: 
    - database
    - winweb01
    - winweb02
  loop_control:
    loop_var: vm

# yamllint disable rule:line-length
- name: Run playbook on the AD jumphost to remove the user
  delegate_to: jumphost_ad
  ansible.builtin.command: |
    ansible-playbook
    /home/{{ vmware_ibm_ldap_jumphost_user }}/sandbox_ad_user.yaml
    -e state=absent
    -e '{"vmware_add_create_user":{"name":"{{ _ocp4_workload_virt_roadshow_vmware_vcenter_user }}","firstname":"{{ _ocp4_workload_virt_roadshow_vmware_vcenter_user }}","surname":"{{ _ocp4_workload_virt_roadshow_vmware_vcenter_user }}","password":"","group":"{{ ocp4_workload_virt_roadshow_vmware_vcenter_group }}"}}'
  ignore_errors: true
# yamllint enable rule:line-length
