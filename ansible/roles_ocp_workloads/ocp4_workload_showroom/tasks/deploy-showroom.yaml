- name: Setup Namespaces
  ansible.builtin.include_tasks: setup-namespaces.yaml

# update user-data.txt for expected values
- name: Write out user-data.yaml file with appropriate user data
  ansible.builtin.copy:
    dest: "/tmp/user-data.yaml"
    content: "{{ _showroom_vars | to_nice_yaml }}"

# chart_ref is complex, so _chart_ref defined in vars
- name: Deploy helm chart with values
  kubernetes.core.helm_template:
    chart_ref: showroom
    chart_repo_url: https://rhpds.github.io/showroom-deployer
    set_values:
      - value: "namespace.name={{ _showroom_namespace }}"
        value_type: "string"
      - value: "namespace.create=false"
        value_type: "string"
      - value: "guid={{ guid }}"
        value_type: "string"
      - value: "deployer.domain={{ _deployer_domain }}"
        value_type: "string"
      - value: "content.user_data=/tmp/user-data.yaml"
        value_type: "file"
      - value: "content.repoUrl={{ ocp4_workload_showroom_git_repo }}"
        value_type: "string"
  register: r_helm_templates

- name: Remove user-data.yaml
  ansible.builtin.file:
    state: absent
    path: "/tmp/user-data.yaml"

- name: Render unto kuberntes the helm manifests
  kubernetes.core.k8s:
    kubeconfig: "{{ _showroom_kubeconfig | default(omit) }}"
    definition: "{{ r_helm_templates.stdout | from_yaml_all }}"

- name: Report Variables
  ansible.builtin.include_tasks: report-variables.yaml
