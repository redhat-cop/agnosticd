---

- name: "Create ObjectBucketClaim {{ ocp4_workload_cloud_native_robot_user }}/{{ bucket_name }}"
  kubernetes.core.k8s:
    state: present
    definition: |
      apiVersion: objectbucket.io/v1alpha1
      kind: ObjectBucketClaim
      metadata:
        name: {{ bucket_name }}
        namespace: "{{ ocp4_workload_cloud_native_robot_user }}-ai"
      spec:
        additionalConfig:
          bucketclass: noobaa-default-bucket-class
        generateBucketName: model-store
        storageClassName: openshift-storage.noobaa.io

- name: "Check if ObjectBucketClaim {{ ocp4_workload_cloud_native_robot_user }}/{{ bucket_name }} is bound"
  kubernetes.core.k8s_info:
    api_version: objectbucket.io/v1alpha1
    kind: ObjectBucketClaim
    name: "{{ bucket_name }}"
    namespace:  "{{ ocp4_workload_cloud_native_robot_user }}-ai"
  register: obc
  retries: 5
  until: obc.resources[0].status.phase == "Bound"

- name: "Fetch Secret {{ ocp4_workload_cloud_native_robot_user }}/{{ bucket_name }}"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ bucket_name }}"
    namespace:  "{{ ocp4_workload_cloud_native_robot_user }}-ai"
  register: obc_secret


- name: "Fetch CnofigMap {{ ocp4_workload_cloud_native_robot_user }}/{{ bucket_name }}"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: "{{ bucket_name }}"
    namespace:  "{{ ocp4_workload_cloud_native_robot_user }}-ai"
  register: obc_cm

- name: "Create OpenShift AI DataConnection - {{ ocp4_workload_cloud_native_robot_user }}/{{ bucket_name }}"
  kubernetes.core.k8s:
    state: present
    definition: |
      apiVersion: v1
      kind: Secret
      metadata:
        annotations:
          opendatahub.io/connection-type: s3
          openshift.io/display-name: "{{ bucket_name }}"
        labels:
          opendatahub.io/dashboard: "true"
          opendatahub.io/managed: "true"
        name: {{ bucket_name }}-ai-connection
        namespace: "{{ ocp4_workload_cloud_native_robot_user }}-ai"
      type: Opaque
      stringData:
        AWS_ACCESS_KEY_ID: "{{ obc_secret.resources[0].data.AWS_ACCESS_KEY_ID | b64decode }}"
        AWS_DEFAULT_REGION: "us-east-1"
        AWS_S3_BUCKET:  "{{ obc_cm.resources[0].data.BUCKET_NAME  }}"
        AWS_S3_ENDPOINT: http://s3.openshift-storage.svc
        AWS_SECRET_ACCESS_KEY: "{{ obc_secret.resources[0].data.AWS_SECRET_ACCESS_KEY | b64decode }}"




