---
- name: Create rocketchat project
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'project_create.yaml.j2') | from_yaml }}"
  register: project_result
  until: project_result is succeeded
  retries: 10
  delay: 30

- name: output project results
  debug:
    var: project_result
    verbosity: 2

- name: Deploy Rocket Chat
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template',  item ) | from_yaml }}"
  loop:
  - rocket_chat_deployment_pvc1.yaml.j2
  - rocket_chat_deployment_pvc2.yaml.j2
  - rocket_chat_deployment_pvc3.yaml.j2
  - rocket_chat_deployment_service_db.yaml.j2
  - rocket_chat_deployment_service_rc.yaml.j2 
  - rocket_chat_deployment_dc_db.yaml.j2
  - rocket_chat_deployment_dc.yaml.j2
  - rocket_chat_deployment_route.yaml.j2
  register: route_result
  until: route_result is succeeded
  retries: 10
  delay: 30

- name: Print the results
  debug:
    var: route_result
    verbosity: 2

- name: Get rocketchat route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: rocket-chat # get from rocket_chat_deployment.yaml.j2 route creation task.
    namespace: "{{ ocp4_workload_rocket_chat_namespace }}"
  register: route_result
  until:
    - route_result.resources[0].spec.host is defined
    - route_result.resources[0].spec.host | length > 0
  retries: 10
  delay: 10

- name: Print rocketchat host
  debug:
    var: route_result.resources[0].spec.host

- name: Set RocketChat URL
  ansible.builtin.set_fact:
    _rocketchat_url: "https://{{ route_result.resources[0].spec.host }}"

- name: Get User ID and Auth Token
  uri:
    url: "{{ _rocketchat_url }}/api/v1/login"
    method: POST
    body_format: json
    headers:
      Content-Type: application/json
    body:
      user: admin
      password: admin
    return_content: yes
  register: response
  until: not response.failed 
  retries: 30
  delay: 30

- name: Extract User ID and AuthToken
  set_fact:
    _userId: "{{ response.content | regex_search('\"userId\":\"([^\"]+)', '\\1') }}"
    _authToken: "{{ response.content | regex_search('\"authToken\":\"([^\"]+)', '\\1') }}"

- name: Print userID and AuthToken
  debug:
    msg: |
      UserId: {{ _userId }}
      AuthToken: {{ _authToken }}

- name: Create clothing and utensils channels
  uri:
    url: "{{ _rocketchat_url }}/api/v1/channels.create"
    method: POST
    body_format: json
    headers:
      Content-Type: application/json
      X-Auth-Token: "{{ _authToken.0 }}"
      X-User-Id: "{{ _userId.0 }}"
    body:
      '{ 
          "name": "{{ item.roomName }}",
          "members": []
      }'
    return_content: yes
  loop: "{{ ocp4_workload_rocket_chat_user_vars }}"
  register: r_channel_result

- name: Create  pm_clothing and pm_utensils users
  uri:
    url: "{{ _rocketchat_url }}/api/v1/users.create"
    method: POST
    body_format: json
    headers:
      Content-Type: application/json
      X-Auth-Token: "{{ _authToken.0 }}"
      X-User-Id: "{{ _userId.0 }}"
    body:
      '{
        "name": "{{ item.user }}",
        "email": "{{ item.user }}@example.com",
        "password": "{{ item.user }}",
        "username": "{{ item.user }}" 
      }'
  loop: "{{ ocp4_workload_rocket_chat_user_vars }}"
  register: r_user_result

- name: Assign pm_clothing user full access to clothing channel
  uri:
    url: "{{ _rocketchat_url }}/api/v1/channels.setRoles"
    method: POST
    body_format: json
    headers:
      Content-Type: application/json
      X-Auth-Token: "{{ _authToken.0 }}"
      X-User-Id: "{{ _userId.0 }}"
    body:
     '{
      "roomName": "{{ item.roomName }}",
      "username": "{{ item.user }}"
      }'
  loop: "{{ ocp4_workload_rocket_chat_user_vars }}"

- name: Send message to the clothing channel
  uri:
    url: "{{ _rocketchat_url }}/api/v1/chat.postMessage"
    method: POST
    body_format: json
    headers:
      Content-Type: application/json
      X-Auth-Token: "{{ _authToken.0 }}"
      X-User-Id: "{{ _userId.0 }}"
    body:
      '{ 
          "channel": "#{{ item.roomName }}",
          "text": "{{ item.msg }}"
      }'
  loop: "{{ ocp4_workload_rocket_chat_user_vars }}"
