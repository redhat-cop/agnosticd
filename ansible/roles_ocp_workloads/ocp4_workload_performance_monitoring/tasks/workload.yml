- name: Check Required Parameters
  ansible.builtin.fail:
    msg: "This play requires 'num_users' to be defined"
  when:
    - num_users is not defined
    - num_users | int > 0

- name: User count debug
  ansible.builtin.debug:
    msg: "Debugging num_users {{ num_users }}"

- name: Create Usernames
  ansible.builtin.set_fact:
    users: "{{ users | default([]) + ['user'+item | string] }}"
  loop: "{{ range(1,((num_users | int) + 1)) | list }}"

# Set commonly used variables
- name: Get openshift console
  kubernetes.core.k8s_info:
    validate_certs: '{{ verify_tls }}'
    kind: Route
    name: console
    namespace: openshift-console
    api_version: route.openshift.io/v1
  register: openshift_console_route

- name: Set openshift console
  ansible.builtin.set_fact:
    console_url: "https://{{ openshift_console_route.resources[0].status.ingress[0].host }}"

- name: Define domain
  ansible.builtin.set_fact:
    domain: "{{ console_url | regex_replace('https://console-openshift-console.apps.') }}"

- name: Set Subdomain
  ansible.builtin.set_fact:
    route_subdomain: "apps.{{ domain }}"

- name: Config Users Namespaces
  ansible.builtin.include_tasks: config_users.yml
  loop: "{{ range(1, num_users | int + 1, 1)| list }}"
  when:
    - num_users|int > 0

- name: Install DevSpaces
  ansible.builtin.include_tasks: install_devspaces.yml

- name: Install Serverless
  ansible.builtin.include_tasks: install_devspaces.yml

- name: Install Tekton
  ansible.builtin.include_tasks: install_devspaces.yml

- name: Install Registration
  ansible.builtin.include_tasks: install_registration.yml
