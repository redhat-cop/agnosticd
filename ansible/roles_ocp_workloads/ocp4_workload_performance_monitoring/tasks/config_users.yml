- name: Process namespaces user{{ item }}
  kubernetes.core.k8s:
    validate_certs: '{{ verify_tls }}'
    api_version: v1
    kind: Namespace
    name: 'user{{ item }}-{{ ns }}'
    state: present
  register: _user_namespace
  retries: 10
  delay: 5
  until:
    - _user_namespace is succeeded
  loop_control:
    loop_var: ns
  loop:
    - stage
    - prod

- name: Create Role to access Terminal
  kubernetes.core.k8s:
    validate_certs: '{{ verify_tls }}'
    state: present
    resource_definition: "{{ lookup('template', 'pod-exec-role.yaml.j2') }}"


- name: Give access to projects user{{ item }}
  kubernetes.core.k8s:
    validate_certs: '{{ verify_tls }}'
    state: present
    resource_definition: "{{ lookup('template', 'user-rolebinding.yaml.j2') }}"
  loop:
    - user: 'user{{ item }}'
      namespace: 'user{{ item }}-stage'
      role: admin
    - user: 'user{{ item }}'
      namespace: 'user{{ item }}-prod'
      role: admin
  loop_control:
    loop_var: item_project
