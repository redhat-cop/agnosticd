- name: Set workshop_namespaces
  ansible.builtin.set_fact:
    workshop_namespaces:
      - stage
      - dev
      - hyperfoil


- name: Process namespaces for {{ user }}
  kubernetes.core.k8s:
    validate_certs: '{{ verify_tls }}'
    api_version: v1
    kind: Namespace
    name: '{{ user }}-{{ ns }}'
    state: present
  register: _user_namespace
  retries: 10
  delay: 5
  until:
    - _user_namespace is succeeded
  loop_control:
    loop_var: ns
  loop: '{{ workshop_namespaces }}'


- name: Evaluate Hyperfoil quota
  kubernetes.core.k8s:
    validate_certs: '{{ verify_tls }}'
    state: present
    api_version: v1
    kind: ResourceQuota
    definition:
      metadata:
        name: hyperfoil-resourcequota
        namespace: '{{ user }}-hyperfoil'
      spec:
        hard:
          pods: '4'
          requests.cpu: '1'
          requests.memory: 3Gi
          limits.cpu: '2'
          limits.memory: 3Gi


- name: Create Role to access Terminal
  kubernetes.core.k8s:
    validate_certs: '{{ verify_tls }}'
    state: present
    resource_definition: "{{ lookup('template', 'pod-exec-role.yaml.j2') }}"


- name: Give access to projects {{ item }}
  kubernetes.core.k8s:
    validate_certs: '{{ verify_tls }}'
    state: present
    resource_definition: "{{ lookup('template', 'user-rolebinding.yaml.j2') }}"
  loop: '{{ workshop_namespaces }}'
  loop_control:
    loop_var: ns
