---
- name: "Ensure nvidia_gpu namespace exists"
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: "{{ nvidia_gpu_operator_namespace }}"

- name: Create NVIDIA GPU operatorgroup
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', 'nvidia_gpu_operatorgroup.yaml') | from_yaml }}"
  register: operatorgroup_result
  retries: 10
  delay: 6

- name: debug NVIDIA GPU operatorgroup results
  debug:
    msg: "{{ operatorgroup_result }}"  

- name: Get NVIDIA GPU operator channel
  shell: >
    oc get packagemanifest gpu-operator-certified -n openshift-marketplace -o jsonpath='{.status.defaultChannel}'
  register: r_channel
  retries: 10
  delay: 6

- name: debug NVIDIA GPU operator channel
  debug:
    msg: "CHANNEL = {{ r_channel.stdout_lines }}"  

- name: Set operator CHANNEL variable
  ansible.builtin.set_fact:
    _ocp4_workload_nvidia_gpu_operator_channel: "{{ r_channel.stdout_lines }}"

- name: Get NVIDIA GPU operator csv 
  shell: >
    oc get packagemanifests/gpu-operator-certified -n openshift-marketplace -ojson | jq -r '.status.channels[] | select(.name == "'{{ _ocp4_workload_nvidia_gpu_operator_channel }}'") | .currentCSV'
  register: r_csv
  retries: 10
  delay: 6

- name: Set NVIDIA GPU operator csv 
  ansible.builtin.set_fact:
    _ocp4_workload_nvidia_gpu_operator_csv: "{{ r_csv }}"

- name: debug NVIDIA GPU operator csv 
  debug:
    msg: "CSV = {{ r_csv }}"  

- name: Create NVIDIA GPU subscription
  vars:
    nvidia_gpu_operator_channel: "{{ nvidia_gpu_operator_channel }}"
    nvidia_gpu_operator_starting_csv: "{{ nvidia_gpu_operator_starting_csv }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', 'nvidia_gpu_sub.yaml') | from_yaml }}"
  register: subscription_result
  retries: 20
  delay: 6

- name: debug NVIDIA GPU subscription
  debug:
    msg: "{{ subscription_result }}"

- name: 120 second pause for NVIDIA GPU operator setup
  pause:
    seconds: 120

- name: Setup NVIDIA GPU Cluster Policy
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', 'nvidia_gpu_clusterpolicy.json') | from_yaml }}"
