---
- name: Get current webhook
  uri:
    url: "{{ item.execution_environment_git_api }}/hooks"
    method: GET
    return_content: true
    validate_certs: false
    status_code: 200
    headers:
      Authorization: "Bearer {{ item.execution_environment_git_token }}"
      Accept: application/vnd.github+json
  register: r_hooks

- name: Create webhook
  when: r_hooks.json | length == 0
  uri:
    url: "{{ item.execution_environment_git_api }}/hooks"
    method: POST
    return_content: true
    validate_certs: false
    body: "{{ lookup('template', 'templates/webhook-post-body.json.j2') | to_nice_json }}"
    body_format: json
    status_code: 201
    headers:
      Authorization: "Bearer {{ item.execution_environment_git_token }}"
      Accept: application/vnd.github+json

- name: Create gittea token
  uri:
    url: https://gitea.apps.cluster-sdnfd.sandbox508.opentlc.com/api/v1/users/devops1/tokens
    user: devops1
    password: openshift
    method: POST
    body_format: json
    force_basic_auth: yes
    validate_certs: false
    status_code: 201
    body: >-
      {"name": "token1" }
1c51220d7ce42801d3405ae8e038f20ede97e74c

- name: Create gittea token
  uri:
    url: https://gitea.apps.cluster-sdnfd.sandbox508.opentlc.com/api/v1/repos/devops1/ee-ansible-test/hooks
    user: devops1
    password: openshift
    method: POST
    body_format: json
    force_basic_auth: yes
    validate_certs: false
    status_code: 201
    headers:
      Authorization: "Bearer {{ item.execution_environment_git_token }}"
      Accept: application/vnd.github+json
    body: >-
      {
        "name": "web",
        "active": true,
        "events": [
            "push"
        ],
        "type": "gitea",
        "config":{
            "url": "http://event-listener-ansible-ee-ansible-pipeline-test1.apps.cluster-sdnfd.sandbox508.opentlc.com",
            "secret": "123",
            "content_type": "json",
            "insecure_ssl": "0"
        }
      }