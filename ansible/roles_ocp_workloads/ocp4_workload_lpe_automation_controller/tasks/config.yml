---
# Upload manifest to activate automation controller
- name: Upload automationcontroller manfiest
  when: automation_controller_upload_manifest | default(false) | bool
  block:
    - name: Fetch automation controller manifest
      get_url:
        url: "{{ automationcontroller_manifest_url }}"
        dest: /tmp/automationcontroller_manifest.zip
        username: "{{ automationcontroller_asset_username | default(omit) }}"
        password: "{{ automationcontroller_asset_password | default(omit) }}"

    - name: Load automation controller manifest into register for injection
      slurp:
        src: /tmp/automationcontroller_manifest.zip
      register: r_automationcontroller_manifest_remote

    - name: Remove automation controller manifest from installer host
      file:
        path: /tmp/automationcontroller_manifest.zip
        state: absent

    - name: Inject automation controller license via manifest
      uri:
        url: "https://{{ automation_controller_hostname }}/api/v2/config/"
        method: POST
        user: "{{ automation_controller_admin_username | default('admin') }}"
        password: "{{ automation_controller_admin_password }}"
        body: >
          {
            "eula_accepted": true,
            "manifest":
            "{{
              r_automationcontroller_manifest_remote.content
            }}"
          }
        body_format: json
        validate_certs: false
        force_basic_auth: true
