---

### BEGIN WORKSHOP SETUP ###
- fail:
    msg: User count ({{ ocp4_workload_serverless_ml_workshop_user_count }}) < 1
  when: ocp4_workload_serverless_ml_workshop_user_count| int < 1

- name: Create Catalog Source for use with catalog snapshot
  k8s:
    state: present
    definition: "{{ lookup('template', './templates/catalogsource.j2' ) | from_yaml }}"

- name: Install OCS Operator
  include_tasks: ./install_ocs_operator.yaml

- name: Install CRW Operator
  include_tasks: ./install_crw_operator.yaml

- name: Install AMQ Streams Operator
  include_tasks: ./install_amqstreams_operator.yaml

- name: Install Serverless Operator
  include_tasks: ./install_serverless_operator.yaml

- name: Setting up workload for user
  debug:
    msg: "Setting up workload for {{ ocp4_workload_serverless_ml_workshop_user_count }} users"

- include_tasks: per_user_workload.yaml
  loop: "{{ range(1, 1 + (ocp4_workload_serverless_ml_workshop_user_count | int)) | list }}"
  loop_control:
    loop_var: t_user_num
  vars:
    t_user: user{{ t_user_num }}
    t_user_project: user{{ t_user_num }}
    t_user_serverless_project: user{{ t_user_num }}-istio

- name: Set up Homeroom for workshop users
  include_tasks: ./homeroom.yaml

### END WORKSHOP SETUP

# Leave this as the last task in the playbook.
# --------------------------------------------
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
