---
- name: Install Operator and configure external Ceph
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/{{ cluster_name }}/auth/kubeconfig
  block:
  - name: Set up ODF operator
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', item) | from_yaml }}"
    loop:
    - odf-ns.yaml
    - odf-og.yaml
    - odf-sub.yaml.j2

  - name: Wait for the CRD storagecluster to become available
    kubernetes.core.k8s_info:
      api_version: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: storageclusters.ocs.openshift.io
    register: r_crd_storageclusters
    retries: 200
    delay: 10
    until: r_crd_storageclusters.resources | list | length == 1

  - name: Set up StorageCluster
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', item) | from_yaml }}"
    register: r_storagecluster
    until: r_storagecluster is success
    retries: 30
    delay: 30
    loop:
    - secret.yaml.j2
    - storageclass.yaml.j2
    - storagecluster.yaml.j2

  - name: Wait for StorageCluster to be available
    kubernetes.core.k8s_info:
      api_version: ocs.openshift.io/v1
      kind: StorageCluster
      name: ocs-storagecluster
      namespace: openshift-storage
      wait: true
      wait_condition:
        reason: ReconcileCompleted
        status: "True"
        type: ReconcileComplete
      wait_sleep: 10
      wait_timeout: "{{ ocp4_workload_external_odf_storage_cluster_deploy_timeout }}"
    register: r_storage_cluster
    ignore_errors: true

  - name: Delete secrets if Storage Cluster status is not successful
    when: r_storage_cluster is failed
    block:
    - name: Delete secrets
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Secret
        name: "{{ item }}"
        namespace: openshift-storage
      loop:
      - rook-csi-rbd-node
      - rook-csi-rbd-provisioner

    - name: Wait for StorageCluster to be available again
      kubernetes.core.k8s_info:
        api_version: ocs.openshift.io/v1
        kind: StorageCluster
        name: ocs-storagecluster
        namespace: openshift-storage
        wait: true
        wait_condition:
          reason: ReconcileCompleted
          status: "True"
          type: ReconcileComplete
        wait_sleep: 10
        wait_timeout: "{{ ocp4_workload_external_odf_storage_cluster_deploy_timeout }}"

  - name: Create PVC for image registry
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', 'pvc-imageregistry.yaml') | from_yaml }}"
    register: r_pvc
    until: r_pvc is success
    retries: 30
    delay: 30

  - name: Configure registry
    kubernetes.core.k8s:
      state: patched
      api_version: imageregistry.operator.openshift.io/v1
      kind: Config
      name: cluster
      definition:
        spec:
          replicas: 1
          rolloutStrategy: Recreate
          storage:
            managementState: Managed
            pvc:
              claim: pvc-image-registry

  - name: Enable ODF console plugin
    kubernetes.core.k8s:
      state: patched
      api_version: operator.openshift.io/v1
      kind: Console
      name: cluster
      definition:
        spec:
          plugins:
          - odf-console
