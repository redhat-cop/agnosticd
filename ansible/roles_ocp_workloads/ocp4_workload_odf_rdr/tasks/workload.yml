---
# Implement your Workload deployment tasks here
- name: Setting up workload for user
  debug:
    msg: "Setting up workload for user ocp_username = {{ ocp_username }}"

- environment:
    KUBECONFIG: "{{ tmp_kubeconfig }}"
  block:
    - name: Wait until ODF is ready
      k8s_info:
        api_version: ocs.openshift.io/v1
        kind: StorageCluster
        name: ocs-storagecluster
        namespace: openshift-storage
      register: r_storagecluster
    - debug:
        msg: "{{ r_storagecluster }}"
      # until:
      #   - r_storagecluster.resources.0.status.phase  |bool
      # retries: 5
      # delay: 5

      # vars:
      #   _connection: "[?type=='SubmarinerConnectionDegraded'].status"
      #   _agent: "[?type=='SubmarinerAgentDegraded'].status"
      #   _gateway: "[?type=='SubmarinerGatewayNodesLabeled'].status"
      # until:
      #   - not r_submariner.resources.0.status.conditions |json_query(_connection) |join('') |bool
      #   - not r_submariner.resources.0.status.conditions |json_query(_agent) | join('') |bool
      #   - r_submariner.resources.0.status.conditions |json_query(_gateway) | join('') |bool
      # retries: 30
      # delay: 30

    # - name: Print query for primary
    #   vars:
    #     _connection: "[?type=='SubmarinerConnectionDegraded'].status"
    #     _agent: "[?type=='SubmarinerAgentDegraded'].status"
    #     _gateway: "[?type=='SubmarinerGatewayNodesLabeled'].status"
    #   debug:
    #     msg: |
    #       "{{ r_submariner.results.0.resources.0.status.conditions |json_query(_connection) | join('')  }}"
    #       "{{ r_submariner.results.0.resources.0.status.conditions |json_query(_agent) | join('') }}"
    #        "{{ r_submariner.results.0.resources.0.status.conditions |json_query(_gateway) | join('') }}"
    #     verbosity: 2
    #
    # - name: Print query for secondary
    #   vars:
    #     _connection: "[?type=='SubmarinerConnectionDegraded'].status"
    #     _agent: "[?type=='SubmarinerAgentDegraded'].status"
    #     _gateway: "[?type=='SubmarinerGatewayNodesLabeled'].status"
    #   debug:
    #     msg: |
    #       "{{ r_submariner.results.1.resources.0.status.conditions |json_query(_connection) | join('') }}"
    #       "{{ r_submariner.results.1.resources.0.status.conditions |json_query(_agent) | join('') }}"
    #        "{{ r_submariner.results.1.resources.0.status.conditions |json_query(_gateway) | join('') }}"
    #     verbosity: 2


# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent | bool
