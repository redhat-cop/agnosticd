---
- name: create ArgoCD instances for all users
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'argocd/applicationset.yaml.j2' ) | from_yaml }}"

- name: create pipelines for all users
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'tekton/applicationset.yaml.j2' ) | from_yaml }}"

  # yamllint disable rule:line-length
- name: create gitea webook for all users
  vars:
    _ocp4_workload_acc_new_app_dev_namespace: >-
      {{ ocp4_workload_acc_new_app_dev_tekton_namespace_prefix }}{{ocp4_workload_acc_new_app_dev_user_prefix }}{{ n }}
  ansible.builtin.uri:
    url: "{{ _ocp4_workload_acc_new_app_dev_gitea_url }}/api/v1/repos/{{ ocp4_workload_acc_new_app_dev_user_prefix }}{{ n }}/{{ ocp4_workload_acc_new_app_dev_demo_app_source }}/hooks"
    method: POST
    force_basic_auth: true
    user: "{{ ocp4_workload_acc_new_app_dev_user_prefix }}{{ n }}"
    password: "{{ ocp4_workload_acc_new_app_dev_gitea_user_password }}"
    headers:
      accept: application/json
    body_format: json
    body: |
      {
        "active": true,
        "branch_filter": "*",
        "config": {
          "url": "http://el-{{ _ocp4_workload_acc_new_app_dev_namespace }}.{{ _ocp4_workload_acc_new_app_dev_wildcard_domain }}",
          "http_method": "POST",
          "content_type": "json"
        },
        "events": [
          "push"
        ],
        "type": "gitea"
      }
    status_code: [201]
  loop: "{{ range(1, ocp4_workload_acc_new_app_dev_user_count | int + 1) | list }}"
  loop_control:
    loop_var: n
    label: "{{ ocp4_workload_acc_new_app_dev_user_prefix }}{{ n }}"
  # yamllint enable rule:line-length
