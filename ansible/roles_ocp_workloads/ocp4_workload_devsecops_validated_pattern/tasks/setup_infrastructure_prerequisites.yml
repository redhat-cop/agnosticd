---
- name: Set up namespace
  k8s:
    state: present
    definition: "{{ lookup('template',  'namespace-ci.yml.j2' ) | from_yaml }}"

- name: Retrieve Gitea instance
  kubernetes.core.k8s_info:
    api_version: gpte.opentlc.com/v1
    kind: Gitea
    name: gitea
    namespace: gitea
  register: r_gitea

- name: Set Gitea repo variables
  set_fact:
    _ocp4_workload_devsecops_validated_pattern_gitea_hostname: >-
      {{ r_gitea.resources[0].status.giteaHostname }}
    _ocp4_workload_devsecops_validated_pattern_gitea_route_url: >-
      {{ r_gitea.resources[0].status.giteaRoute }}
    _ocp4_workload_devsecops_validated_pattern_gitea_repo_globex_ui_url: >-
      {{ r_gitea.resources[0].spec.giteaSsl | bool | ternary( 'https', 'http' ) }}://{{
      ocp4_workload_devsecops_validated_pattern_gitea_username | urlencode }}:{{
      ocp4_workload_devsecops_validated_pattern_gitea_password | urlencode }}@{{
      r_gitea.resources[0].status.giteaHostname }}/{{
      ocp4_workload_devsecops_validated_pattern_gitea_username }}/globex-ui
    _ocp4_workload_devsecops_validated_pattern_gitea_repo_vault_url: >-
      {{ r_gitea.resources[0].spec.giteaSsl | bool | ternary( 'https', 'http' ) }}://{{
      ocp4_workload_devsecops_validated_pattern_gitea_username | urlencode }}:{{
      ocp4_workload_devsecops_validated_pattern_gitea_password | urlencode }}@{{
      r_gitea.resources[0].status.giteaHostname }}/{{
      ocp4_workload_devsecops_validated_pattern_gitea_username }}/hashicorp-vault
    _ocp4_workload_devsecops_validated_pattern_gitea_repo_devsecops_url: >-
      {{ r_gitea.resources[0].spec.giteaSsl | bool | ternary( 'https', 'http' ) }}://{{
      ocp4_workload_devsecops_validated_pattern_gitea_username | urlencode }}:{{
      ocp4_workload_devsecops_validated_pattern_gitea_password | urlencode }}@{{
      r_gitea.resources[0].status.giteaHostname }}/{{
      ocp4_workload_devsecops_validated_pattern_gitea_username }}/devsecops-validated-pattern

- name: Process acm common manifests
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - acm/common/acm-namespace.yml.j2
  - acm/common/acm-namespace-kafka.yml.j2
  - acm/common/acm-namespace-app.yml.j2
  - acm/common/acm-namespace-sonarqube.yml.j2
  - acm/common/acm-namespace-quay.yml.j2
  - acm/common/acm-channel.yml.j2

- name: Retrieve Bucket Class
  k8s_info:
    api_version: noobaa.io/v1alpha1
    kind: BucketClass
    namespace: openshift-storage
  register: r_bucket_class

- name: Assert that there is a Bucket Storage Class
  assert:
    that:
    - r_bucket_class.resources | length == 1
    fail_msg: Quay must be installed on a cluster with OpenShift Container Storage configured - and a Bucket Class deployed.

- name: Create (hub) operators
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - acm/infra/openshift-operators/acm-placement-rule.yml.j2
  - acm/infra/openshift-operators/acm-subscription.yml.j2
  - acm/infra/openshift-operators/acm-application.yml.j2
  vars:
    _environment: hub
    _purpose: "{{ ocp4_workload_devsecops_validated_pattern_hub_cluster.purpose }}"

- name: Create (dev) openshift operators
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - acm/infra/openshift-operators/acm-placement-rule.yml.j2
  - acm/infra/openshift-operators/acm-subscription.yml.j2
  - acm/infra/openshift-operators/acm-application.yml.j2
  vars:
    _environment: dev
    _purpose: "{{ ocp4_workload_devsecops_validated_pattern_dev_cluster.purpose }}"

- name: Create (prod) openshift operators
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - acm/infra/openshift-operators/acm-placement-rule.yml.j2
  - acm/infra/openshift-operators/acm-subscription.yml.j2
  - acm/infra/openshift-operators/acm-application.yml.j2
  vars:
    _environment: prod
    _purpose: "{{ ocp4_workload_devsecops_validated_pattern_prod_cluster.purpose }}"

- name: Wait for operators to install
  ansible.builtin.pause:
    minutes: 5