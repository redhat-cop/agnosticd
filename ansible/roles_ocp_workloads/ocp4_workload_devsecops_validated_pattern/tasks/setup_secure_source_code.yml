---
- name: Copy GPG Setup script to remote server
  ansible.builtin.copy:
    src: files/setup_gpg.sh
    dest: /tmp/setup_gpg.sh

- name: Get codeserver pod
  shell: |
    oc get pod -l app.kubernetes.io/name=codeserver -n codeserver --no-headers | awk '{print $1}'
  register: r_codeserver_pod

- name: Run GPG Setup script in codeserver container
  shell: |
    oc cp /tmp/setup_gpg.sh codeserver/{{ r_codeserver_pod.stdout }}:/tmp -c codeserver -n codeserver
    oc exec -n codeserver {{ r_codeserver_pod.stdout }} -c codeserver -- /bin/sh /tmp/setup_gpg.sh

- name: Get the GPG Key ID
  shell: |
    oc exec -n codeserver {{ r_codeserver_pod.stdout }} -c codeserver -- /bin/bash -c "gpg --list-keys --keyid-format LONG | grep 'pub ' | awk '{print $2}' | cut -d'/' -f2"
  register: r_gpg_key_id

- name: Export the GPG Public Key
  shell: |
    oc exec -n codeserver {{ r_codeserver_pod.stdout }} -c codeserver -- gpg --armor --export {{ r_gpg_key_id.stdout }}
  register: r_gpg_public_key

- name: Create GPG Key in Gitea
  uri:
    url: >-
      {{ _ocp4_workload_devsecops_validated_pattern_gitea_route_url }}/api/v1/user/gpg_keys
    user: "{{ ocp4_workload_devsecops_validated_pattern_gitea_username }}"
    password: "{{ ocp4_workload_devsecops_validated_pattern_gitea_password }}"
    method: POST
    validate_certs: false
    force_basic_auth: true
    status_code: 201
    body_format: json
    body:
      armored_public_key: "{{ r_gpg_public_key.stdout }}"
