---
- name: Retrieve Gitea instance
  kubernetes.core.k8s_info:
    api_version: gpte.opentlc.com/v1
    kind: Gitea
    name: "{{ ocp4_workload_coolstore_apac_summit_instance }}"
    namespace: "{{ ocp4_workload_coolstore_apac_summit_project }}"
  register: r_gitea

- name: Set Gitea repo variables
  set_fact:
    _ocp4_workload_coolstore_apac_summit_hostname: >-
      {{ r_gitea.resources[0].status.giteaHostname }}
    _ocp4_workload_coolstore_apac_summit_repo_route_url: >-
      {{ r_gitea.resources[0].status.giteaRoute }}
    _ocp4_workload_coolstore_apac_summit_repo_url: >-
      {{ r_gitea.resources[0].spec.giteaSsl | bool | ternary( 'https', 'http' ) }}://{{
      ocp4_workload_coolstore_apac_summit_user | urlencode }}:{{
      ocp4_workload_coolstore_apac_summit_user_password | urlencode }}@{{
      r_gitea.resources[0].status.giteaHostname }}/{{
      ocp4_workload_coolstore_apac_summit_user }}/{{ ocp4_workload_coolstore_apac_summit_repo }}
    _ocp4_workload_coolstore_apac_summit_repo_coolstore_argocd_repo_url: >-
      {{ r_gitea.resources[0].spec.giteaSsl | bool | ternary( 'https', 'http' ) }}://{{
      ocp4_workload_coolstore_apac_summit_user | urlencode }}:{{
      ocp4_workload_coolstore_apac_summit_user_password | urlencode }}@{{
      r_gitea.resources[0].status.giteaHostname }}/{{
      ocp4_workload_coolstore_apac_summit_user }}/{{ ocp4_workload_coolstore_apac_summit_repo_gitops }}


# - name: Set anonymous repo URL
#   set_fact:
#     _ocp4_workload_coolstore_apac_summit_repo_gitops_anonymous_url: >-
#       {{ _ocp4_workload_coolstore_apac_summit_repo_route_url }}/{{
#       ocp4_workload_coolstore_apac_summit_user }}/{{ ocp4_workload_coolstore_apac_summit_repo_gitops }}

# - name: Delete existing Gitea token if it exists
#   ansible.builtin.uri:
#     url: >-
#       https://{{ _ocp4_workload_coolstore_apac_summit_hostname
#       }}/api/v1/users/{{ ocp4_workload_coolstore_apac_summit_user
#       }}/tokens/{{ ocp4_workload_coolstore_apac_summit_repo_gitops }}
#     method: DELETE
#     status_code: [204, 404, 422]
#     user: "{{ ocp4_workload_coolstore_apac_summit_user }}"
#     password: "{{ ocp4_workload_coolstore_apac_summit_user_password }}"
#     force_basic_auth: true
#     validate_certs: false

# # Get Token for Gitea user
# # curl -XPOST -H "Content-Type: application/json"  -k -d '{"name":"industrial-edge"}'
# #      -u ${GITEA_USER}:openshift ${GITEA_URL}/api/v1/users/lab-user/tokens
# - name: Set up a Gitea token
#   ansible.builtin.uri:
#     url: >-
#       https://{{ _ocp4_workload_coolstore_apac_summit_hostname
#       }}/api/v1/users/{{ ocp4_workload_coolstore_apac_summit_user }}/tokens
#     method: POST
#     body: "{{ body }}"
#     body_format: json
#     status_code: 201
#     user: "{{ ocp4_workload_coolstore_apac_summit_user }}"
#     password: "{{ ocp4_workload_coolstore_apac_summit_user_password }}"
#     force_basic_auth: true
#     validate_certs: false
#   vars:
#     body:
#       name: "{{ ocp4_workload_coolstore_apac_summit_repo_gitops }}"
#   register: r_gitea_token

# - name: Set Gitea token variable
#   set_fact:
#     _ocp4_workload_coolstore_apac_summit_token: "{{ r_gitea_token.json.sha1 }}"

# - name: Print Gitea token
#   debug:
#     msg: "Using Gitea token: {{ _ocp4_workload_coolstore_apac_summit_token }}"

# # Don't loop with "~{{ ansible-user }}"
# - name: Make sure cloned repo directories do not exist
#   block:
#   - name: Remove inventory
#     ansible.builtin.file:
#       path: "{{ ocp4_workload_coolstore_apac_home_directory }}/{{ ocp4_workload_coolstore_apac_summit_repo }}"
#       state: absent

# - name: Set up .gitconfig
#   ansible.builtin.copy:
#     src: gitconfig
#     dest: "~{{ ansible_user}}/.gitconfig"
#     owner: "{{ ansible_user }}"
#     group: "{{ ansible_user }}"
#     mode: 0664

# # Don't loop with "~{{ ansible-user }}"
# - name: Clone application source code
#   block:
#   - name: Clone inventory repository
#     ansible.builtin.git:
#       accept_hostkey: true
#       force: true
#       repo: "{{ _ocp4_workload_coolstore_apac_summit_repo_inventory_url }}"
#       dest: "{{ ocp4_workload_coolstore_apac_home_directory }}/{{ ocp4_workload_coolstore_apac_summit_repo }}"
#       version: "{{ ocp4_workload_coolstore_apac_summit_repo_branch }}"
#     environment:
#       GIT_SSL_NO_VERIFY: "true"
#   - name: Clone gitops repository
#     ansible.builtin.git:
#       accept_hostkey: true
#       force: true
#       repo: "{{ _ocp4_workload_coolstore_apac_summit_repo_gitops_url }}"
#       dest: "{{ ocp4_workload_coolstore_apac_home_directory }}/{{ ocp4_workload_coolstore_apac_summit_repo_gitops }}"
#       version: "{{ ocp4_workload_coolstore_apac_summit_repo_gitops_branch }}"
#     environment:
#       GIT_SSL_NO_VERIFY: "true"

- name: Set Gitea token variable
  set_fact:
    _ocp4_workload_coolstore_apac_summit_web_ui_host: web-ui-{{ ocp4_workload_coolstore_apac_summit_coolstore_namespace }}.{{ocp4_base_domain}}

- name: Create k8s resources
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - cicd/namespace-ci-pipeline.yaml.j2
  - cicd/namespace-coolstore-pipeline.yaml.j2
  - cicd/gitea-secret.yaml.j2
  - cicd/gitea-token.yaml.j2
  - cicd/generate-tag.yaml.j2
  - cicd/update-kustomize-repo.yaml.j2
  - cicd/update-kustomize-repo-sso.yaml.j2
  - cicd/web-ui-ci-pipeline.yaml.j2
  - cicd/web-ui-ci-pipelinerun.yaml.j2

- name: Deploy ArgoCD applications
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - cicd/app-coolstore-ci.yaml.j2
  - cicd/app-coolstore-microservice.yaml.j2

- name: Wait until Event Listener Route exists in the cicd namespace
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    namespace: cicd
    name: gitops-webhook-event-listener-route
  register: r_webhook_route
  until: r_webhook_route.resources | length > 0
  delay: 10
  retries: 30

- name: Generate web hook secret if not defined
  when: ocp4_workload_coolstore_apac_summit_webhook_secret | length == 0
  set_fact:
    ocp4_workload_coolstore_apac_summit_webhook_secret: >-
      {{ lookup('password', '/dev/null length={{ ocp4_workload_coolstore_apac_summit_webhook_secret_length }} chars=ascii_letters,digits') }}

- name: Register event listeners in Gitea
  include_tasks: update-webhook.yml
  loop:
  - "{{ ocp4_workload_coolstore_apac_summit_repo_inventory }}"
  - "{{ ocp4_workload_coolstore_apac_summit_repo_gateway }}"
  - "{{ ocp4_workload_coolstore_apac_summit_repo_catalog }}"
  - "{{ ocp4_workload_coolstore_apac_summit_repo_object_detection }}"
  loop_control:
    loop_var: _ocp4_workload_coolstore_apac_webhook_repository
