apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: web-ui-ci-pipeline
  namespace: coolstore
spec:
  params:
    - default: 'image-registry.openshift-image-registry.svc:5000/coolstore/web-ui'
      name: IMAGE
      type: string
    - default: 'https://github.com/redhat-gpte-devopsautomation/coolstore-microservice.git'
      name: GIT_REPO_URL
      type: string
    - default: 'web-ui-coolstore.apps.cluster-92tg6.sandbox677.opentlc.com'
      name: COOLSTORE_WEB_URI
      type: string
  tasks:
    - name: build
      params:
        - name: SCRIPT
          value: |
            oc start-build web-ui --follow=true
      taskRef:
        kind: ClusterTask
        name: openshift-client
    - name: generate-tag
      runAfter:
        - build
      taskRef:
        kind: Task
        name: generate-tag
    - name: tag
      params:
        - name: SCRIPT
          value: >
            oc tag coolstore/web-ui:latest
            coolstore/web-ui:$(tasks.generate-tag.results.image-tag)
      runAfter:
        - generate-tag
      taskRef:
        kind: ClusterTask
        name: openshift-client
    - name: update-kustomize-repo
      params:
        - name: gitRepositoryUrl
          value: >-
            ${params.GIT_REPO_URL}
        - name: gitRepositoryRevision
          value: master
        - name: gitPath
          value: coolstore/overlays/prod
        - name: fileName
          value: deployment-patches.yaml
        - name: image
          value: 'image-registry.openshift-image-registry.svc:5000/coolstore/web-ui'
        - name: imageTag
          value: $(tasks.generate-tag.results.image-tag)
        - name: verbose
          value: 'true'
      runAfter:
        - tag
      taskRef:
        kind: Task
        name: update-kustomize-repo
    - name: update-kustomize-repo-sso
      params:
        - name: gitRepositoryUrl
          value: >-
            ${params.GIT_REPO_URL}
        - name: gitRepositoryRevision
          value: master
        - name: gitPath
          value: ci/overlays/prod
        - name: fileName
          value: deployment-patches.yaml
        - name: coolstore_web_uri
          value: ${params.COOLSTORE_WEB_URI}
        - name: verbose
          value: 'true'
      runAfter:
        - update-kustomize-repo
      taskRef:
        kind: Task
        name: update-kustomize-repo-sso
  workspaces:
    - name: workspace
