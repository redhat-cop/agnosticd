---
- name: Set ACM cluster variables
  set_fact:
    acm_cluster_name: "{{ item.managed_cluster_name }}"
    acm_cluster_kconf_path: "{{ item.managed_cluster_kconf_path }}"

- name: Create directory
  file:
    path: "{{ acm_cluster_kconf_path }}/{{ acm_cluster_name }}"
    state: directory

- name: Find kubeconfig secret
  shell: >-
    oc get secret -o name -n {{ acm_cluster_name }}
    -l hive.openshift.io/cluster-deployment-name={{ acm_cluster_name }}
    -l hive.openshift.io/secret-type=kubeconfig
  register: r_secret_kconf

- name: Extract kubeconfig
  command: >-
    oc extract -n "{{ acm_cluster_name }}"
    "{{ r_secret_kconf.stdout }}"
    --to={{ acm_cluster_kconf_path }}//{{ acm_cluster_name }}
    --confirm

- name: Proccess to modify
  slurp:
    path: "{{ acm_cluster_kconf_path }}/{{ acm_cluster_name }}/kubeconfig"
  register: r_kconf

- name: Decode kubeconfig
  set_fact:
    mycontext: "{{ r_kconf.content | b64decode | from_yaml }}"

- name: Decode kubeconfig
  set_fact:
    mycontext: "{{ r_kconf.content | b64decode | from_yaml }}"

- name: Change context name
  set_fact:
    mycontext: "{{ mycontext | combine(newcontext, recursive=True) }}"
  vars:
    newcontext:
      contexts:
        - name: "{{ acm_cluster_name }}"
          context:
            cluster: "{{ mycontext.contexts.0.context.cluster }}"
            user: "{{ acm_cluster_name }}-admin"
      users:
        - name: "{{ acm_cluster_name }}-admin"
          user: "{{ mycontext.users.0.user }}"

- name: Store kubeconfig
  copy:
    content: "{{ mycontext | to_nice_yaml }}"
    dest: "{{ acm_cluster_kconf_path }}/{{ acm_cluster_name }}/kubeconfig"

- name: set bashrc variable
  set_fact:
    bash_managed_cluster_kconf: >-
      {{ bash_managed_cluster_kconf | default('') +':'+ acm_cluster_kconf_path+acm_cluster_name+'/'+'kubeconfig'}}
