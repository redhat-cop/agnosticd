---
# Implement your workload removal tasks here
# ------------------------------------------

- name: Delete klusterlet addon config
  kubernetes.core.k8s:
    state: absent
    api_version: agent.open-cluster-management.io/v1
    kind: KlusterletAddonConfig
    name: "{{ ocp4_workload_deploy_hosted_cluster_name }}"
    namespace: "{{ ocp4_workload_deploy_hosted_cluster_name }}"

- name: Delete managed cluster
  kubernetes.core.k8s:
    state: absent
    api_version: cluster.open-cluster-management.io/v1
    kind: ManagedCluster
    name: "{{ ocp4_workload_deploy_hosted_cluster_name }}"

- name: Run hypershift CLI to destroy hosted cluster
  ansible.builtin.command: >-
    hypershift destroy cluster aws
      --name {{ ocp4_workload_deploy_hosted_cluster_name }}
      --infra-id {{ ocp4_workload_deploy_hosted_cluster_infra_ID }}
      --aws-creds /home/opentlc-mgr/.aws/credentials
      --namespace local-cluster
  register: r_hypershift_destroy

- name: Delete htpasswd-{{ guid }} secret
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: secret
    name: "htpasswd-{{ guid }}"

# Leave this as the last task in the playbook.
# --------------------------------------------
- name: remove_workload tasks complete
  debug:
    msg: "Remove Workload tasks completed successfully."
  when: not silent|bool
