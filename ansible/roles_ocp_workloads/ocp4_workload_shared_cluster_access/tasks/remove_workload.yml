---
- name: remove user from groups {{ ocp4_workload_shared_cluster_username }}
  when: ocp4_workload_shared_cluster_user_groups | length > 0
  ansible.builtin.command: "oc adm groups remove-users {{ item }} {{ ocp4_workload_shared_cluster_username }}"
  loop: "{{ ocp4_workload_shared_cluster_user_groups }}"

- name: get all namespaces for user {{ ocp4_workload_shared_cluster_username }}
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    label_selectors:
    - '!AAD'
    - '!usernamespace.gpte.redhat.com/user-uid'
  register: r_get_namespaces

- name: remove all namespaces for user {{ ocp4_workload_shared_cluster_username }}
  kubernetes.core.k8s:
    api_version: v1
    kind: namespace
    name: "{{ user_namespace }}"
    state: absent
  vars:
    user_namespace_query: >-
      [?@.metadata.annotations."openshift.io/requester"==`{{ ocp4_workload_shared_cluster_username | to_json }}`].metadata.name
  loop: >
    {{ r_get_namespaces.resources | default([]) | json_query(user_namespace_query) }}
  loop_control:
    loop_var: user_namespace

- name: remove ClusterResourceQuota
  when: ocp4_workload_shared_cluster_create_quota | bool
  kubernetes.core.k8s:
    state: absent
    definition: "{{ lookup('template', item) | from_yaml }}"
  loop:
  - ./templates/cluster_resource_quota.yaml.j2
