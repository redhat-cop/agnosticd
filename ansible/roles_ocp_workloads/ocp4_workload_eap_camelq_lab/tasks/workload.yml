---
- name: start soap app with podman
  containers.podman.podman_container:
    name: container
    image: "{{ ocp4_workload_eap_camelq_lab_soap_app_image }}"
    detach: true
    ports:
      - 8080:8080

- name: verify soap app with a test request
  ansible.builtin.uri:
    url: http://localhost:8080/services/s1
    method: GET
    body: |
      <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
        <soap:Body>
          <ns2:SubscriberRequest xmlns:ns2="http://www.example.org/s1/">
            <Id>dummy</Id>
          </ns2:SubscriberRequest>
        </soap:Body>
      </soap:Envelope>
  register: this
  until: this.status == 200
  retries: 3
  delay: 5

- name: enable podman.socket for the user
  ansible.builtin.file:
    src: /usr/lib/systemd/user/podman.socket
    dest: /home/{{ student_name }}/.config/systemd/user/sockets.target.wants/podman.socket
    state: link
    owner: "{{ student_name }}"
    group: "{{ student_group | default('users') }}"

- name: install skupper cli
  ansible.builtin.include_role:
    name: skupper.network.skupper_cli_install
  vars:
    skupper_cli:
      force: "True"

- name: export skupper bash variable
  ansible.builtin.blockinfile:
    path: /etc/profile
    marker: "# skupper platform variabler"
    block: "export SKUPPER_PLATFORM=podman"

- name: reboot required for podman
  ansible.builtin.reboot:
    connect_timeout: 300
    msg: "Rebooting now.."

- name: loginctl enable-linger
  ansible.builtin.command:
    argv:
      - loginctl
      - enable-linger
      - "{{ student_name }}"

- name: switch skupper platform
  ansible.builtin.command:
    argv:
      - /usr/local/bin/skupper
      - switch
