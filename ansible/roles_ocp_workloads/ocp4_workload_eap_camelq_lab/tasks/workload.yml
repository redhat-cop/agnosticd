---
- name: install service interconnect operator
  ansible.builtin.include_role:
    name: install_operator
  vars:
    install_operator_name: skupper-operator
    install_operator_channel: "{{ ocp4_workload_eap_camelq_lab_skupper_channel }}"
    install_operator_starting_csv: "{{ ocp4_workload_eap_camelq_lab_skupper_startingcsv }}"
    install_operator_catalogsource_setup: true
    install_operator_catalogsource_image: "{{ ocp4_workload_eap_camelq_lab_skupper_catalogsource_image }}"
    install_operator_catalogsource_image_tag: "{{ ocp4_workload_eap_camelq_lab_skupper_catalogsource_tag }}"

- name: enable podman.socket for the user
  become: true
  block:
    - name: create systemd user directory
      ansible.builtin.file:
        path: "/home/{{ student_name }}/{{ item }}"
        state: directory
        recurse: true
        owner: "{{ student_name }}"
        group: "{{ student_group | default('users') }}"
        mode: "755"
      loop:
        - .config
        - .config/systemd
        - .config/systemd/user
        - .config/systemd/user/sockets.target.wants
    - name: enable podman.socket for the user
      ansible.builtin.file:
        src: /usr/lib/systemd/user/podman.socket
        dest: /home/{{ student_name }}/.config/systemd/user/sockets.target.wants/podman.socket
        state: link
        owner: "{{ student_name }}"
        group: "{{ student_group | default('users') }}"
    - name: reboot required for podman
      ansible.builtin.reboot:
        connect_timeout: 300
        msg: "Rebooting now.."

- name: start soap app service with podman
  # become: true
  # become_user: "{{ student_name }}"
  block:
    - name: start soap app service with podman
      containers.podman.podman_container:
        name: container
        image: "{{ ocp4_workload_eap_camelq_lab_soap_app_image }}"
        detach: true
        ports:
          - 8080:8080
    - name: verify soap app with a test request
      ansible.builtin.uri:
        url: http://localhost:8080/services/s1
        method: GET
        body: |
          <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
            <soap:Body>
              <ns2:SubscriberRequest xmlns:ns2="http://www.example.org/s1/">
                <Id>dummy</Id>
              </ns2:SubscriberRequest>
            </soap:Body>
          </soap:Envelope>
      register: this
      until: this.status == 200
      retries: 3
      delay: 5

# - name: install skupper cli
#   ansible.builtin.include_role:
#     name: skupper.network.skupper_cli_install
#   vars:
#     skupper_cli:
#       force: "True"

- name: install skupper cli
  become: true
  become_user: "{{ student_name }}"
  ansible.builtin.shell: >-
    /usr/bin/curl https://raw.githubusercontent.com/RedHat-Middleware-Workshops/service-interconnect-lab-instructions/main/install.sh | sh

- name: export skupper bash variable
  become: true
  ansible.builtin.blockinfile:
    path: /etc/profile
    marker: "# skupper platform variabler"
    block: "export SKUPPER_PLATFORM=podman"

- name: loginctl enable-linger
  become: true
  ansible.builtin.command:
    argv:
      - loginctl
      - enable-linger
      - "{{ student_name }}"

# - name: switch skupper platform
#   ansible.builtin.command:
#     argv:
#       - /usr/local/bin/skupper
#       - switch
