- name: Wait for 3scale Master Route to be available
  k8s_facts:
    api_version: route.openshift.io/v1
    kind: Route
    namespace: "{{ ocp4_workload_lpe_3scale_namespace }}"
    label_selectors:
       - zync.3scale.net/route-to=system-master
  register: r_dc
  until:
    - r_dc is defined
    - r_dc.resources is defined
    - r_dc.resources | list | length > 0
  retries: 60
  delay: 15

- name: Get Master Account List
  uri:
    url: "https://master.{{ ocp4_workload_lpe_3scale_ocp_apps_domain }}/admin/api/accounts.json"
    method: GET
    validate_certs: no
    return_content: yes
    body_format: form-urlencoded
    body:
      access_token: '{{ ocp4_workload_lpe_3scale_master_access_token }}'
    status_code: [200]
  register: ocp4_workload_lpe_3scale_http_response

- set_fact:
    ocp4_workload_lpe_3scale_tenant_account_id: "{{ item['account']['id'] }}"
  when: (item['account']['admin_domain'] == "{{ ocp4_workload_lpe_3scale_org_name }}-admin.{{ ocp4_workload_lpe_3scale_ocp_apps_domain }}")
  loop: "{{ ocp4_workload_lpe_3scale_http_response.json.accounts}}"

- name: Get User List
  uri:
    url: "https://master.{{ ocp4_workload_lpe_3scale_ocp_apps_domain }}/admin/api/accounts/{{ ocp4_workload_lpe_3scale_tenant_account_id }}/users.json"
    method: GET
    validate_certs: no
    return_content: yes
    body_format: form-urlencoded
    body:
      access_token: '{{ ocp4_workload_lpe_3scale_master_access_token }}'
    status_code: [200]
  register: ocp4_workload_lpe_3scale_http_response

- set_fact:
    ocp4_workload_lpe_3scale_tenant_user_id: "{{ item['user']['id'] }}"
  when: (item['user']['username'] == "{{ ocp4_workload_lpe_3scale_tenant_admin_name_base }}")
  loop: "{{ ocp4_workload_lpe_3scale_http_response.json.users}}"

- name: Activate User
  uri:
    url: "https://master.{{ ocp4_workload_lpe_3scale_ocp_apps_domain }}/admin/api/accounts/{{ ocp4_workload_lpe_3scale_tenant_account_id }}/users/{{ ocp4_workload_lpe_3scale_tenant_user_id }}/activate.xml"
    method: PUT
    validate_certs: no
    return_content: yes
    body_format: form-urlencoded
    body: 
      access_token: '{{ ocp4_workload_lpe_3scale_master_access_token }}'
    status_code: [200,201]
