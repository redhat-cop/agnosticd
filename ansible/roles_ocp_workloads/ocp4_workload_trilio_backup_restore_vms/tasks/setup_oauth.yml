---
- name: Create Trilio OAuth Client
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', '/templates/tvk-trilio-keycloak-client.yml.j2') | from_yaml }}"
    namespace: "{{ ocp4_workload_trilio_backup_restore_vms_rhsso_namespace }}"

- name: Retrieve trilio realm client credentials
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: keycloak-client-secret-trilio
    namespace: "{{ ocp4_workload_trilio_backup_restore_vms_rhsso_namespace }}"
  register: r_client_credentials
  retries: 120
  delay: 10
  until:
  - r_client_credentials is defined
  - r_client_credentials.resources is defined
  - r_client_credentials.resources | length > 0
  - r_client_credentials.resources[0].data is defined
  - r_client_credentials.resources[0].data.CLIENT_ID is defined
  - r_client_credentials.resources[0].data.CLIENT_ID | length > 0
  - r_client_credentials.resources[0].data.CLIENT_SECRET is defined
  - r_client_credentials.resources[0].data.CLIENT_SECRET | length > 0

- name: Decode trilio client credentials
  ansible.builtin.set_fact:
    ocp4_workload_trilio_backup_restore_vms_trilio_client_id: "{{ r_client_credentials.resources[0].data.CLIENT_ID | b64decode }}"
    ocp4_workload_trilio_backup_restore_vms_trilio_client_secret: "{{ r_client_credentials.resources[0].data.CLIENT_SECRET | b64decode }}"

- name: Retrieve Ingress config
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Ingress
    name: cluster
  register: r_ingress_config

- name: Get OpenShift Apps Domain
  ansible.builtin.set_fact:
    ocp4_workload_trilio_backup_restore_vms_apps_domain: "{{ r_ingress_config.resources[0].spec.domain }}"

- name: Wait for Dex Secret creation
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: triliovault-dex
  register: r_triliovault-dex
  retries: 120
  delay: 10
  until:
  - r_triliovault-dex is defined
  - r_triliovault-dex.resources is defined
  - r_triliovault-dex.resources | length > 0

- name: Delete Dex Secret
  kubernetes.core.k8s:
    name: triliovault-dex
    api_version: v1
    kind: Secret
    state: absent
    namespace: "{{ ocp4_workload_trilio_backup_restore_vms_namespace }}"

- name: Create Trilio Vault Dex Secret
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', '/templates/tvk-triliovault-dex-secret.yml.j2') | from_yaml }}"
    namespace: "{{ ocp4_workload_trilio_backup_restore_vms_namespace }}"