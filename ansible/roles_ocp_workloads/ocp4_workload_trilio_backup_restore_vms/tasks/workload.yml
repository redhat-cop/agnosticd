---
# - name: Install Trilio Operator
#   ansible.builtin.include_role:
#     name: install_operator
#   vars:
#     install_operator_action: install
#     install_operator_name: k8s-triliovault
#     install_operator_namespace: "{{ ocp4_workload_trilio_backup_restore_vms_namespace }}"
#     install_operator_channel: "{{ ocp4_workload_trilio_backup_restore_vms_operator_channel }}"
#     install_operator_catalog: certified-operators
#     install_operator_automatic_install_plan_approval: true
#     install_operator_csv_nameprefix: k8s-triliovault-stable

# - name: Create Role Bindings for Trilio user
#   kubernetes.core.k8s:
#     state: present
#     definition: "{{ lookup('template', item) | from_yaml }}"
#     namespace: "{{ ocp4_workload_trilio_backup_restore_vms_namespace }}"
#   loop:
#   - templates/tvk-admin-trilio-system-role-binding.yaml.j2
#   - templates/tvk-admin-vmimported-role-binding.yaml.j2

# - name: Create Trilio Vault Manager
#   kubernetes.core.k8s:
#     state: present
#     definition: "{{ lookup('template', 'templates/tvk-trilio-vault-manager.yaml.j2') | from_yaml }}"
#     namespace: "{{ ocp4_workload_trilio_backup_restore_vms_namespace }}"

- name: Wait for CRD's to be created
  k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: "{{ item }}"
  register: r_trilio_crds
  retries: 120
  delay: 5
  until:
  - r_trilio_crds.resources | length > 0
  loop:
  - licenses.triliovault.trilio.io

- name: Create Trilio Resources
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item) | from_yaml }}"
    namespace: "{{ ocp4_workload_trilio_backup_restore_vms_namespace }}"
  loop:
  - templates/tvk-license-file.yaml.j2
  - templates/tvk-minio-s3-login-secret.yaml.j2

- name: Setup OAuth for Trilio
  ansible.builtin.include_tasks:
    file: ./setup_oauth.yml

- name: Create Trilio Console Plugin Resources
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item) | from_yaml }}"
    namespace: "{{ ocp4_workload_trilio_backup_restore_vms_namespace }}"
  loop:
  - templates/tvk-console-plugin-config-map.yaml.j2
  - templates/tvk-console-plugin-service.yaml.j2
  - templates/tvk-console-plugin-deployment.yaml.j2
  - templates/tvk-console-plugin.yaml.j2

- name: Create Trilio Console Plugin Entry
  ansible.builtin.shell: |
    existingPlugins=$(oc get consoles.operator.openshift.io cluster -o json | jq -c '.spec.plugins // []')
    mergedPlugins=$(jq --argjson existingPlugins "${existingPlugins}" --argjson consolePlugin '["tvk-console-plugin"]' -c  -n '$existingPlugins + $consolePlugin | unique')
    patchedPlugins=$(jq --argjson mergedPlugins $mergedPlugins -n -c  '{ "spec": { "plugins": $mergedPlugins } }')
    oc patch consoles.operator.openshift.io cluster --patch $patchedPlugins  --type=merge

- name: Create Trilio Console Plugin Entry
  become: true
  ansible.builtin.shell: |
    rm -rf /home/rosa/.aws/credentials