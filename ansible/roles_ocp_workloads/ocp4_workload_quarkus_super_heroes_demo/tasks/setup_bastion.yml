---
- name: Install Software
  become: true
  block:
  - name: Install Java packages to bastion
    package:
      state: present
      name:
      - "java-{{ ocp4_workload_quarkus_super_heroes_demo_setup_bastion_java_version }}-openjdk"
      - "java-{{ ocp4_workload_quarkus_super_heroes_demo_setup_bastion_java_version }}-openjdk-devel"
      - podman-docker

  - name: Create /usr/local/maven directory
    file:
      path: /usr/local/maven
      state: directory
      owner: root
      group: root
      mode: 0775

  - name: Download and unarchive Maven Distribution
    unarchive:
      src: "https://gpte-public.s3.amazonaws.com/apache-maven-{{ ocp4_workload_quarkus_super_heroes_demo_setup_bastion_maven_version }}-bin.tar.gz"
      remote_src: true
      dest: /usr/local/maven
      owner: root
      group: root
      extra_opts:
      - --strip=1

  - name: Set up mvn link
    file:
      state: link
      src: "/usr/local/maven/bin/mvn"
      dest: /usr/local/bin/mvn
      owner: root
      group: root

- name: Set up Podman docker
  blockinfile:
    dest: "/home/{{ ansible_user }}/.bashrc"
    insertafter: EOF
    marker: "# <!-- {mark} ANSIBLE MANAGED BLOCK (podman docker) -->"
    block: |
      export DOCKER_HOST=unix:///run/user/${UID}/podman/podman.sock
      export TESTCONTAINERS_RYUK_DISABLED=true

- name: Set up Podman socket
  systemd:
    scope: user
    name: podman.socket
    enabled: true
    force: true
    state: started

- name: Clone application source code
  ansible.builtin.git:
    accept_hostkey: true
    force: true
    repo: >-
      https://{{
      ocp4_workload_quarkus_super_heroes_demo_clone_repo_gitea_user | urlencode }}:{{
      ocp4_workload_quarkus_super_heroes_demo_clone_repo_gitea_password | urlencode }}@{{
      ocp4_workload_quarkus_super_heroes_demo_clone_repo_gitea_name }}.{{
      route_subdomain }}/{{
      ocp4_workload_quarkus_super_heroes_demo_clone_repo_gitea_user }}/{{ ocp4_workload_quarkus_super_heroes_demo_clone_repo_gitea_repo_name }}.git
    dest: "{{ ocp4_workload_quarkus_super_heroes_demo_clone_repo_destination }}"
    version: "{{ ocp4_workload_quarkus_super_heroes_demo_clone_repo_tag }}"

- name: Fix repository ownership
  ansible.builtin.file:
    state: directory
    recurse: true
    path: "{{ ocp4_workload_quarkus_super_heroes_demo_clone_repo_destination }}"
    owner: "{{ ansible_user }}"

- name: Prebuild projects to populate .m2 directory
  when: ocp4_workload_quarkus_super_heroes_demo_build_projects | default([]) | length > 0
  ansible.builtin.shell:
    cmd: "/usr/local/bin/mvn clean package -DskipTests"
    chdir: "{{ ocp4_workload_quarkus_super_heroes_demo_clone_repo_destination }}/{{ item }}"
  loop: "{{ ocp4_workload_quarkus_super_heroes_demo_build_projects | list }}"
