# Implement your Pre Workload deployment tasks here
- name: Usercount debug
  ansible.builtin.debug:
    msg: "Debugging num_users {{ num_users }}"

- name: Create usernames
  ansible.builtin.set_fact:
    users: "{{ users | default([]) + ['user' + item | string] }}"
  loop: "{{ range(1, ((num_users | int) + 1)) | list }}"

# Leave this as the last task in the playbook.
- name: Pre_workload tasks complete
  ansible.builtin.debug:
    msg: "Pre-Workload tasks completed successfully."
  when: not silent|bool

# Figure out paths
- name: Get OpenShift Apps Domain
  ansible.builtin.set_fact:
    route_subdomain: >-
      {{ query('kubernetes.core.k8s', api_version='config.openshift.io/v1', kind='Ingress', resource_name='cluster')
      | json_query('[0].spec.appsDomain') }}
- name: Get OpenShift Domain
  ansible.builtin.set_fact:
    route_subdomain: >-
      {{ query('kubernetes.core.k8s', api_version='config.openshift.io/v1', kind='Ingress', resource_name='cluster')
      | json_query('[0].spec.domain') }}
  when:
    - route_subdomain | length == 0

- name: Get OpenShift Console
  ansible.builtin.set_fact:
    console_url: >-
      {{ query('kubernetes.core.k8s', api_version='config.openshift.io/v1', kind='Console', resource_name='cluster')
      | json_query('[0].status.consoleURL') }}
- name: Get OpenShift API
  ansible.builtin.set_fact:
    api_url: >-
      {{ query('kubernetes.core.k8s', api_version='config.openshift.io/v1', kind='Infrastructure', resource_name='cluster')
      | json_query('[0].status.apiServerURL') }}
- name: Debug
  ansible.builtin.debug:
    msg:
      - "Console URL: {{ console_url }}"
      - "API URL: {{ api_url }}"
      - "Route Subdomain: {{ route_subdomain }}"
      - "Admin username: {{ ocp_username }}"

- name: Fetch OpenShift cluster version
  ansible.builtin.set_fact:
    openshift_version: >-
      {{ query('kubernetes.core.k8s', kind='ClusterOperator', resource_name='openshift-apiserver')
      | json_query('[0].status.versions[?name==`operator`].version | [0]') | split('.') | slice(2) | first | join('.') }}
  when: (openshift_version is not defined) or (openshift_version | length == 0)

- name: Debug
  ansible.builtin.debug:
    msg: "Setting up for OpenShift version: {{ openshift_version }}"
