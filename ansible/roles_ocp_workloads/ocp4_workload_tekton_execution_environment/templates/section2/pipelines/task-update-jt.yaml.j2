apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ _name_ }}-update-jt
spec:
  description: >-
    Add execution environment to automation controller
  workspaces:
    - name: source
  params:
    - description: automation controller api host url
      name: API_URL
      type: string
    - description: name of the execution environment
      name: JOB_TEMPLATE
      type: string
    - description: automation controller username
      name: USER
      type: string
    - description: automation controller password 
      name: PASSWORD
      type: string

  results:
    - description: execution environment creation result.
      name: post
  steps:
    - name: update-jt
      image: quay.io/rshah/jq
      workingDir: $(workspaces.source.path)
      resources: {}
      script: |
        #!/usr/bin/env bash
        set -x
        AC_EE_ID=$(cat ee_data.json | jq  .id)

        FIND_JT=$(curl -s -w "%{http_code}" -X GET \
          https://$(params.API_URL)/api/v2/job_templates/ \
          -H 'Content-Type: application/json' \
          -u '$(params.USER):$(params.PASSWORD)'
          )
        echo "find jt ${FIND_JT: -3}"
        JT_END_POINT=$(echo -n ${FIND_JT:: -3} |jq  -r '.results[] | select(.name == "$(params.JOB_TEMPLATE)") | .url'
        echo ${AC_EE_ID}
        echo ${JT_END_POINT}
        
        UPDATE_JT=$(curl -s -w "%{http_code}" -X PATCH \
          https://$(params.API_URL)${JT_END_POINT} \
          -H 'Content-Type: application/json' \
          -u '$(params.USER):$(params.PASSWORD)' \
          -d '{"execution_environment": ${AC_EE_ID} }'
        )
        echo "UPDATE jt ${UPDATE_JT: -3}"