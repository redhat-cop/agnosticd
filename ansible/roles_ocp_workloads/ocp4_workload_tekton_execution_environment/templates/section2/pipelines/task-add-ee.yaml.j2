apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ _name_ }}-add-ee
spec:
  description: >-
    Add execution environment to automation controller
  workspaces:
    - name: source
  params:
    - description: execution environment image pull policy
      name: POLICY
      default: missing
      type: string
    - description: execution environment credentials
      name: CREDENTIAL
      default: "null"
      type: string
    - description: execution environment organization
      name: ORGANIZATION
      default: "null"
      type: string
    - description: description of execution environment
      name: DESCRIPTION
      default: ""
      type: string
    - description: automation controller api host url
      name: API_URL
      type: string
    - description: name of the execution environment
      name: NAME
      type: string
    - description: automation controller username
      name: USER
      type: string
    - description: automation controller password 
      name: PASSWORD
      type: string
    - description: execution environment image url with tag
      name: IMAGE
      type: string
  results:
    - description: execution environment creation result.
      name: post
  steps:
    - name: add-ee
      image: >-
        docker.io/centos@sha256:a1801b843b1bfaf77c501e7a6d3f709401a1e0c83863037fa3aab063a7fdb9dc
      workingDir: $(workspaces.source.path)
      resources: {}
      script: |
        #!/usr/bin/env bash
        set -x

        curl_ouput=$(curl -X POST \
          https://$(params.API_URL)/api/v2/execution_environments/ \
          -H 'Content-Type: application/json' \
          -u '$(params.USER):$(params.PASSWORD)' \
          -d '{ 
              "name": "$(params.NAME)", 
              "description": "$(params.DESCRIPTION)", 
              "organization": $(params.ORGANIZATION),
              "image": "$(params.IMAGE)",
              "credential": $(params.CREDENTIAL),
              "pull": "$(params.POLICY)"
              }')
        
        if [ "${curl_ouput:0:10}" -eq '{"detail":' ]; then
          printf "%s" "${curl_ouput}"
          exit 100
        fi
        
        if [ "${curl_ouput:0:8}" -eq '{"name":' ]; then
          printf "%s" "${curl_ouput}"
          exit 100
        fi
        
        if [ "${curl_ouput:0:7}" -eq '</html>' ]; then
          printf "%s" "${curl_ouput}"
          exit 100
        fi
        
        printf "%s" '$(params.NAME) - execution environment has been created' > "$(results.post.path)"