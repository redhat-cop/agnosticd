---
- name: Create {{ ocp4_workload_portworx_namespace }} namespace
  kubernetes.core.k8s:
    name: "{{ ocp4_workload_portworx_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
  register: result
  until: result is not failed
  retries: 10
  delay: 6

- name: Create operatorgroup for {{ ocp4_workload_portworx_namespace }}
  kubernetes.core.k8s:
    state: present
    template: portworx_operatorgroup.j2
  register: result
  until: result is not failed
  retries: 10
  delay: 6

- name: Create {{ ocp4_workload_portworx_namespace }} subscription
  kubernetes.core.k8s:
    template: portworx_subscription.j2
    namespace: "{{ ocp4_workload_portworx_namespace }}"
    state: present
  register: result
  until: result is not failed
  retries: 10
  delay: 6

- name: Wait for the Subscription to be ready
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: " {{ ocp4_workload_portworx_sub_name}} "
    namespace: "{{ ocp4_workload_portworx_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: 'True'
    wait_sleep: 10
    wait_timeout: "{{ ocp4_workload_portworx_wait }}"

#- name: Sleep for {{ ocp4_workload_portworx_wait | int }} seconds
#  ansible.builtin.wait_for:
#    timeout: "{{ ocp4_workload_portworx_wait | int }}"

- name: Create {{ ocp4_workload_portworx_namespace }} storage cluster
  kubernetes.core.k8s:
    template: portworx_storagecluster.j2
    namespace: "{{ ocp4_workload_portworx_namespace }}"
    state: present
  register: result
  until: result is not failed
  retries: 10
  delay: 6

- name: Wait for Storagecluster to be in Running state
  kubernetes.core.k8s_info:
    api_version: core.libopenstorage.org/v1
    kind: StorageCluster
    name: "{{ ocp4_workload_portworx_storagecluster_name }} "
    namespace: "{{ ocp4_workload_portworx_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: 'True'
    wait_sleep: 10
    wait_timeout: "{{ ocp4_workload_porworx_sc_wait_timeout }}"

#- name: Wait for Portworx cluster to to start
#  shell:
#    # yamllint disable-line rule:line-length
#    cmd: "oc get stc -n {{ ocp4_workload_portworx_namespace }} | grep portworx | awk '{print $3}'"
#  register: r_stc
#  until: r_stc.stdout == "Running"
#  retries: 150
#  delay: 10

- name: workload Tasks Complete
  debug:
    msg: workload Tasks Complete
