---
- name: Create rekor server
  shell: |
    oc new-project rekor
    helm repo add sigstore https://sigstore.github.io/helm-charts
    helm repo update
    oc adm policy add-scc-to-user privileged system:serviceaccount:rekor:rekor-server
    oc adm policy add-scc-to-user privileged system:serviceaccount:rekor:rekor-createtree
    helm upgrade -i -n rekor rekor sigstore/rekor --version 1.3.13

- name: Wait for rekor service to be available
  kubernetes.core.k8s_info:
    kind: Service
    name: rekor-server
    namespace: rekor
  register: r_rekor
  retries: 120
  delay: 10
  until: r_rekor.resources | length > 0

- name: Create Rekor Route
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', templates/route-rekor.yml.j2 ) | from_yaml }}"