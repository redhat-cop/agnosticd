---
- name: Build git repo url
  set_fact:
    ocp4_workload_redhat_developer_hub_template_repo_url:
      https://{{ ocp4_workload_redhat_developer_hub_gitlab_root_user }}:{{
      ocp4_workload_redhat_developer_hub_gitlab_root_password }}@{{
      ocp4_workload_redhat_developer_hub_gitlab_host }}/{{
      ocp4_workload_redhat_developer_hub_backstage_gitlab_group }}/software-templates.git
- name: Clone software-templates
  ansible.builtin.git:
    accept_hostkey: true
    force: true
    repo: "{{ ocp4_workload_redhat_developer_hub_template_repo_url }}"
    dest: "~/software-templates"
    version: main
  environment:
    GIT_SSL_NO_VERIFY: "true"

- name: Fetch template from remote host
  include_tasks: fetch_and_apply_template.yml
  loop:
  - template.yaml
  vars:
    _folder: /home/ec2-user/software-templates/scaffolder-templates/quarkus-web-template
    gitlab_host: "{{ ocp4_workload_redhat_developer_hub_gitlab_host }}"
    gitlab_group: "{{ ocp4_workload_redhat_developer_hub_backstage_gitlab_group }}"
    cluster_subdomain: ".{{ ocp4_workload_redhat_developer_hub_apps_domain}}"
    gitlab_token: "{{ ocp4_workload_redhat_developer_hub_gitlab_root_token }}"
    gitlab_user: "{{ ocp4_workload_redhat_developer_hub_backstage_gitlab_user_username | default('janusidp') }}"
    gitlab_password: "{{ ocp4_workload_redhat_developer_hub_backstage_gitlab_user_password }}"

- name: Fetch template from remote host
  include_tasks: fetch_and_apply_template.yml
  loop:
  - showcase-templates.yaml
  vars:
    _folder: /home/ec2-user/software-templates
    gitlab_host: "{{ ocp4_workload_redhat_developer_hub_gitlab_host }}"
    gitlab_group: "{{ ocp4_workload_redhat_developer_hub_backstage_gitlab_group }}"

- name: Add new files to the repository
  command:
    chdir: >-
      /home/ec2-user/software-templates
    cmd: "git add ."
  ignore_errors: true

- name: Commit changes to the repository
  command:
    chdir: >-
      /home/ec2-user/software-templates
    cmd: >-
      git commit -a -m 'Updates for starting scenario.'
  ignore_errors: true

- name: Push all changes back to the project repository
  command:
    chdir: >-
      /home/ec2-user/software-templates
    cmd: >-
      git push {{ ocp4_workload_redhat_developer_hub_template_repo_url }}