---
- name: Create group
  ansible.builtin.uri:
    url: https://{{ ocp4_workload_redhat_developer_hub_gitlab_host }}/api/v4/groups
    method: POST
    body_format: form-urlencoded
    body:
      name: "{{ item.username }}"
      path: "{{ item.username }}"
      visibility: private
    headers:
      PRIVATE-TOKEN: "{{ ocp4_workload_redhat_developer_hub_gitlab_root_token }}"
    validate_certs: false
    status_code: 201
  register: r_group
  retries: 100
  delay: 5
  until: r_group.status == 201

- name: Add user to group
  ansible.builtin.uri:
    url: https://{{ ocp4_workload_redhat_developer_hub_gitlab_host }}/api/v4/groups/{{ r_group.json.id }}/members
    method: POST
    body_format: form-urlencoded
    body:
      user_id: "{{ item.id }}"
      access_level: 50
    headers:
      PRIVATE-TOKEN: "{{ ocp4_workload_redhat_developer_hub_gitlab_root_token }}"
    validate_certs: false
    status_code: 201
  register: r_group_user
  retries: 100
  delay: 5
  until: r_group_user.status == 201