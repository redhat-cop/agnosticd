---
- name: Retrieve ArgoCD credentials
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: openshift-gitops-cluster
    namespace: openshift-gitops
  register: r_argo_creds
  until:
  - r_argo_creds is defined
  - r_argo_creds.resources is defined
  - r_argo_creds.resources | length > 0

- name: Decode argo credentials
  set_fact:
    ocp4_workload_redhat_developer_hub_argocd_password: "{{ r_argo_creds.resources[0].data['admin.password'] | b64decode }}"

- name: Retrieve openshift gitops route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: openshift-gitops-server
    namespace: openshift-gitops
  register: r_argocd_route
  until:
  - r_argocd_route is defined
  - r_argocd_route.resources is defined
  - r_argocd_route.resources | length > 0

- name: Retrieve openshift gitops hostname
  set_fact:
    ocp4_workload_redhat_developer_hub_argocd_host: "{{ r_argocd_route.resources[0].spec.host }}"

- name: Create Backstage application
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'application-backstage.yml.j2' ) | from_yaml }}"