- name: Get all applications in any namespace with our label
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    label_selectors:
    - "demo.redhat.com/catalogItem"
  register: _all_apps

- name: Wait until status of all argocd Applications is healthy=true synced=true
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    label_selectors:
    - "demo.redhat.com/catalogItem"
    #name: "{{ item.metadata.name }}"
    #namespace: "{{ item.metadata.namespace }}"
  register: _each_app
  retries: "{{ ocp4_workload_gitops_bootstrap_application_health_retries }}"
  delay: 10
  until:
  - _each_app is defined
  - _each_app.resources is defined
  - _each_app.resources | length > 0
  - _each_app.resources[0].status is defined
  - _each_app.resources[0].status.health.status == "Healthy"
  - _each_app.resources[0].status.sync.status == "Synced"
  ignore_errors: "{{ ocp4_workload_gitops_bootstrap_application_health_ignore | bool }}"
  # loop: "{{ _all_apps.resources }}"
  # loop_control:
  #   label: "{{ item.metadata.name }}"
