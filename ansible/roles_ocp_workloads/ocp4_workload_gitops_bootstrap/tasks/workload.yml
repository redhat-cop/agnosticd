---
- name: get ingress controler
  kubernetes.core.k8s_info:
    kind: IngressController
    name: default
    namespace: openshift-ingress-operator
  register: r_ingress

- name: get openshift api url
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Infrastructure
    name: cluster
  register: r_infra

- name: set _ocp4_workload_gitops_bootstrap_deployer_values
  ansible.builtin.set_fact:
    _ocp4_workload_gitops_bootstrap_deployer_values:
      deployer:
        domain: "{{ r_ingress.resources[0].status.domain }}"
        apiUrl: "{{ r_infra.resources[0].status.apiServerURL }}"

- name: >
    Add all existing agnosticd_user_info.data to
    _ocp4_workload_gitops_bootstrap_deployer_values
  when: ocp4_workload_gitops_bootstrap_userdata_in_helm_values | default(true) | bool
  ansible.builtin.set_fact:
    _ocp4_workload_gitops_bootstrap_deployer_values: |
      {{ _ocp4_workload_gitops_bootstrap_deployer_values | combine( { "agnosticd_user_data": lookup('agnosticd_user_data', '*') }) }}

- name: print _ocp4_workload_gitops_bootstrap_deployer_values
  ansible.builtin.debug:
    msg: "{{ _ocp4_workload_gitops_bootstrap_deployer_values | to_yaml }}"

- name: create bootstrap argocd application
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'application.yaml.j2') | from_yaml }}"

- name: wait bootstrap argocd application is healthy and synced
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    name: bootstrap
    namespace: openshift-gitops
  register: argocd_bootstrap
  retries: "{{ ocp4_workload_gitops_bootstrap_health_retries }}"
  delay: 10
  until:
  - argocd_bootstrap is defined
  - argocd_bootstrap.resources is defined
  - argocd_bootstrap.resources | length > 0
  - argocd_bootstrap.resources[0].status is defined
  - argocd_bootstrap.resources[0].status.health.status == "Healthy"
  - argocd_bootstrap.resources[0].status.sync.status == "Synced"
  ignore_errors: "{{ ocp4_workload_gitops_bootstrap_health_ignore | bool }}"

- name: Pause for a minute while the bootstrap app deploys
  ansible.builtin.pause:
    seconds: 60

- name: Validate all applications with our label in any namespace are healthy and synced
  when: ocp4_workload_gitops_bootstrap_application_wait | bool
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    label_selectors:
    - "demo.redhat.com/application"
  register: _all_apps
  delay: 10
  retries: "{{ ocp4_workload_gitops_bootstrap_application_health_retries }}"
  until:
  - _all_apps is defined
  - _all_apps.resources is defined
  # json_query: length of list of resources found == length of list of those with good status
  - _all_apps.resources | json_query('length([?status.health.status==`Healthy`]) == length(@)')
  - _all_apps.resources | json_query('length([?status.sync.status==`Synced`]) == length(@)')

- name: retrieve configmaps with the demo.redhat.com/userinfo label
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    label_selectors:
    - "demo.redhat.com/userinfo"
  register: cm_userinfo

- name: save configmap userinfo in agnosticd_user_info
  agnosticd_user_info:
    data: >-
      {{ item.data | from_yaml }}
  loop: "{{ cm_userinfo.resources }}"
