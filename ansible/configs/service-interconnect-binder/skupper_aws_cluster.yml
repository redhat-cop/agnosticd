---
- name: Executing skupper init
  ansible.builtin.command:
    argv:
      - skupper
      - init
      - --platform
      - kubernetes
      - --namespace
      - aws
      - --enable-console 
      - --enable-flow-collector 
      - --console-auth 
      - unsecured
  register: initStatus

- name: Get skupper console url
  ansible.builtin.command:
    argv: 
      - skupper 
      - status
      - --platform
      - kubernetes
      - --namespace
      - aws
  register: _r_skupper_console

- debug:
    msg: "{{ _r_skupper_console.stdout.split() | last }}"

- name: Generate token command
  ansible.builtin.command:
    argv: 
      - skupper
      - token
      - create
      - --platform
      - kubernetes
      - --namespace
      - aws
      - secret_aws_vm.token

- name: Read secret_aws_vm.token
  ansible.builtin.slurp:
    src: secret_aws_vm.token
  register: _r_secret_aws_vm_token

- name: Generate token command
  ansible.builtin.command:
    argv: 
      - skupper
      - token
      - create
      - --platform
      - kubernetes
      - --namespace
      - aws
      - secret_aws_azure.token

- name: Read secret_aws_azure.token
  ansible.builtin.slurp:
    src: secret_aws_azure.token
  register: _r_secret_aws_azure_token


- name: Create database service
  ignore_errors: true
  ansible.builtin.command:
    argv: 
      - skupper
      - service
      - create
      - --platform
      - kubernetes
      - --namespace
      - aws
      - database
      - 5432

- name: Create payment processor service
  ignore_errors: true
  ansible.builtin.command:
    argv: 
      - skupper
      - service
      - create
      - --platform
      - kubernetes
      - --namespace
      - aws
      - payment-processor
      - 8080 
      - --protocol
      - http

- name: Print token secret_aws_vm.token
  debug:
    msg: "{{ _r_secret_aws_vm_token.content | b64decode }}"

- name: Print token secret_aws_azure.token
  debug:
    msg: "{{ _r_secret_aws_azure_token.content | b64decode }}"
