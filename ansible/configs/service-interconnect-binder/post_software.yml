# vim: set ft=yaml.ansible
---
- name: Step 005 Post Software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tags:
    - step005
    - post_software
  tasks:
    - name: Entering the open-service-interconnect-binder post_software.yml
      ansible.builtin.debug:
        msg: Entering the open-service-interconnect-binder post_software.yml

    ## -------------------------------------------
    ##  Setup AWS Cluster Connections
    ## -------------------------------------------
    - name: Add rhel_a host to inventory
      ansible.builtin.add_host:
        name: "{{ aws_a_provision_data.bastion_public_hostname }}"
        groups: aws_bastion
        ansible_connection: ssh
        ansible_ssh_private_key_file: "~/.ssh/opentlc_admin_backdoor.pem"
        ansible_user: "ec2-user"
        remote_user: "ec2-user"

    ## -------------------------------------------
    ##  Setup Azure Cluster Connections
    ## -------------------------------------------
    - name: Add rhel_a host to inventory
      ansible.builtin.add_host:
        name: "{{ azure_a_provision_data.bastion_public_hostname }}"
        groups: azure_bastion
        ansible_connection: ssh
        ansible_ssh_private_key_file: "~/.ssh/opentlc_admin_backdoor.pem"
        ansible_user: "ec2-user"
        remote_user: "ec2-user"

    ## -------------------------------------------
    ##  Setup RHEL Host Connections
    ## -------------------------------------------
    - name: Add rhel_a host to inventory
      ansible.builtin.add_host:
        name: "{{ rhel_a_provision_data.hostname }}"
        groups: rhel_bastion
        ansible_connection: ssh
        ansible_ssh_private_key_file: "~/.ssh/opentlc_admin_backdoor.pem"
        ansible_user: "ec2-user"
        remote_user: "ec2-user"

## -----------------------------------------------
##  Deploy Application pods on RHEL bastion
## -----------------------------------------------

- name: Login to RHEL bastion
  hosts: rhel_bastion
  become: true
  tasks:
    - name: Set up application pods on RHEL
      vars:
        student_name: "{{ rhel_a_provision_data.ssh_username }}"
        student_group: "{{ rhel_a_provision_data.ssh_username }}"
      ansible.builtin.include_tasks:
        file: pod_deployer.yml

    # - name: Enable lingering is needed
    #   ansible.builtin.command: >-
    #    loginctl enable-linger {{ rhel_a_provision_data.ssh_username }}

    - name: Download and Install Skupper on Host
      become_user: "{{ rhel_a_provision_data.ssh_username }}"
      ansible.builtin.shell:
        cmd: curl https://skupper.io/install.sh | sh

    - name: Reboot required for pod serivce
      ansible.builtin.reboot:
        connect_timeout: 300
        msg: "Rebooting now.."


- name: Step 005 Post Software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tags:
    - step005
    - post_software
  tasks:
    - name: Exiting the open-service-interconnect-binder post_software.yml
      ansible.builtin.debug:
        msg: Exiting the open-service-interconnect-binder post_software.yml
...
