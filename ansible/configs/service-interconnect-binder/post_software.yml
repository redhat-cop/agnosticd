# vim: set ft=yaml.ansible
---
- name: Step 005 Post Software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tags:
  - step005
  - post_software
  tasks:
  - name: Entering the open-service-interconnect-binder post_software.yml
    debug:
      msg: Entering the open-service-interconnect-binder post_software.yml

# ---------------------------------------------------------------------------
# Setup Cluster Connections
# ---------------------------------------------------------------------------
  - name: Add rhel_a host to inventory
    ansible.builtin.add_host:
      name: "{{ rhel_a_provision_data.bastion_public_hostname }}"
      groups: rhel_bastion
      ansible_connection: ssh
      ansible_ssh_private_key_file: "~/.ssh/opentlc_admin_backdoor.pem"
      ansible_user: "ec2-user"
      remote_user: "ec2-user"

- name: Login to RHEL bastion
  hosts: rhel_bastion
  become: true
  tasks:
  # - name: Create directory for the the role
  #   file:
  #     path: ~/.kube/
  #     state: directory

  # - name: Create file for the role
  #   file:
  #     path: ~/.kube/config
  #     state: touch

  # - name: Include Service Interconnect role
  #   vars:
  #     ACTION: create
  #     service_interconnect_pods_install: true
  #   include_role:
  #     name: ocp4_workload_service_interconnect
  - name: Set default platform python
    set_fact:
      ansible_python_interpreter: /usr/libexec/platform-python
      service_interconnect_bastion_username: ec2-user
      service_interconnect_pods_list:
      - name: portal-database
        image: quay.io/redhatintegration/patient-portal-database:devnation
        ports:
        - '5432:5432'
      - name: portal-payments
        hostname: processed-at-datacentre
        image: quay.io/redhatintegration/patient-portal-payment-processor:devnation
        ports:
        - '8080:8080'
  - name: Install epe-release
    ansible.builtin.yum:
      name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
      disable_gpg_check: true
      state: present

  - name: Install podman-compose
    ansible.builtin.yum:
      name: podman-compose
      state: present

  - name: Include podman task file
    include_tasks: pods.yml
    loop: "{{ service_interconnect_pods_list }}"

  - name: Download https://skupper.io/install.sh
    ansible.builtin.get_url:
      url: https://skupper.io/install.sh
      dest: /tmp/install.sh
      mode: '0775'

  - name: Exectute install.sh on remote
    ansible.builtin.command: /tmp/install.sh


- name: Step 005 Post Software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tags:
  - step005
  - post_software
  tasks:
  - name: Exiting the open-service-interconnect-binder post_software.yml
    debug:
      msg: Exiting the open-service-interconnect-binder post_software.yml
...
