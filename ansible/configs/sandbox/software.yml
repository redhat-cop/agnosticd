---
- name: Step software 1 
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
    - name: get AWS credentials from stack outputs
      set_fact:
        student_access_key_id: "{{ cloudformation_out_final.stack_outputs.StudentUserAccessKey }}"
        student_secret_access_key: "{{ cloudformation_out_final.stack_outputs.StudentUserSecretAccessKey }}"

- name: Step software 2
  hosts: bastions
  gather_facts: false
  become: false
  tasks:
    - name: Print connectivity info and credential location to user.info
      agnosticd_user_info:
        msg: "{{ item }}"
      loop:
        - ""
        - "SSH Access: ssh {{ student_name }}@clientvm.{{ guid }}{{ subdomain_base_suffix }}"
        - "SSH password: {{ student_password | default(hostvars[groups.bastions.0].student_password) }}"
        - ""
        - "Top level route53 domain: {{ subdomain_base_suffix }}"
        - ""
        - "WARNING: with great power comes great responsibility. We monitor usage."
        - "Your AWS programmatic access is preconfigured in /home/{{ student_name }}/.aws/credentials"

    - name: Install Packages
      become: true
      package:
        name:
          - unzip

    - name: Get awscli bundle
      get_url:
        url: https://s3.amazonaws.com/aws-cli/awscli-bundle.zip
        dest: /tmp/awscli-bundle.zip

    - name: Unzip awscli-bundle.zip
      unarchive:
        src: /tmp/awscli-bundle.zip
        dest: /tmp/
        remote_src: true

    - name: Install awscli
      command: /tmp/awscli-bundle/install -i /usr/local/aws -b /bin/aws
      args:
        creates: /usr/local/aws
      become: true

    - name: cleanup archive and tmp files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/awscli-bundle
        - /tmp/awscli-bundle.zip

    - name: Create .aws directory
      file:
        path: "/home/{{ student_name }}/.aws"
        state: directory
        owner: "{{ student_name }}"
        group: "{{ student_name }}"


    - name: Add aws credentials
      blockinfile:
        path: "/home/{{ student_name }}/.aws"
        block: |-
          [default]
          aws_access_key_id = {{ hostvars.localhost.student_access_key_id }}
          aws_secret_access_key = {{ hostvars.localhost.student_secret_access_key }}
        owner: "{{ student_name }}"
        group: "{{ student_name }}"
