---
- name: Step 00xxxxx software
  hosts: localhost
  gather_facts: False
  become: false
  tasks:
    - debug:
        msg: "Software tasks Started"

- name: Configuring Bastion Hosts
  hosts: bastions 
  become: true
  tags:
    - step004
    - bastion_tasks

  tasks:
    - name: Download noVNC
      ansible.builtin.get_url: 
        url: https://github.com/novnc/noVNC/archive/refs/tags/v{{ novnc_version }}.tar.gz
        dest: /usr/local/src/v{{ novnc_version }}.tar.gz

    - name: Unarchive noVNC
      ansible.builtin.unarchive:
        src: /usr/local/src/v{{ novnc_version }}.tar.gz
        dest: /usr/local/src/
        remote_src: yes

    - name: Copy novnc.service
      ansible.builtin.template:
        src: novnc.service
        dest: /etc/systemd/system/novnc.service

    - name: Enable and start service
      ansible.builtin.service:
        name: novnc
        state: started
        enabled: yes

    - name: 'Open port 6080  in firewalld'
      firewalld:
        port: "6080/tcp"
        permanent: yes
        state: enabled
        immediate: yes

    - name: Git clone https://github.com/miteshget/ansible-lightspeed.git
      ansible.builtin.git:
        repo: https://github.com/miteshget/ansible-lightspeed.git
        dest: /home/student/ansible-lightspeed
        version: main

    - name: Set vscode repository
      ansible.builtin.yum_repository:
        name: code
        description: Visual Studio Code
        file: vscode
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        enabled: true
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc
        gpgcheck: true

    - name: Update rhel host
      ansible.builtin.package:
        name: '*'
        state: latest

    - name: Install code package
      ansible.builtin.package:
        name: code
        state: latest



- name: Software flight-check
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    - debug:
        msg: "Software checks completed successfully"
