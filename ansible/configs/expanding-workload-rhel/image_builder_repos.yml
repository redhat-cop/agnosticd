---
- name: Setup Image Builder for Satellite
  hosts: bastions
  become: True
  gather_facts: False
  vars:
    baseos_baseurl: "https://labsat-ha.opentlc.com/pulp/repos/Red_Hat_GPTE_Labs/Library/rhel-9_0/content/dist/rhel9/9.0/x86_64/baseos/os"
    appstream_baseurl: "https://labsat-ha.opentlc.com/pulp/repos/Red_Hat_GPTE_Labs/Library/rhel-9_0/content/dist/rhel9/9.0/x86_64/appstream/os"
    enabled_services:
      - cockpit
      - osbuild-composer
    imagebuilder_packages:
      - osbuild-composer
      - composer-cli
      - cockpit-composer
      - bash-completion
  tasks:
    - name: Install Packages for Image-builder
      ansible.builtin.dnf:
        state: present
        name: "{{ imagebuilder_packages }}"
   
    - name: Create osbuild-composer/repositories directories
      ansible.builtin.file:
        path: /etc/osbuild-composer/repositories
        state: directory
        mode: '0755'

    - name: Copy osbuild-composer repo file from /usr/share/
      ansible.builtin.copy:
        remote_src: True
        src: /usr/share/osbuild-composer/repositories/rhel-90.json
        dest: /etc/osbuild-composer/repositories/rhel-90.json
        owner: root
        group: root
        mode: '0644'
    
    - name: Modify hard coded baseos content path
      ansible.builtin.replace:
        path: /etc/osbuild-composer/repositories/rhel-90.json
        regexp: 'https://cdn.redhat.com/content/dist/rhel9/9/x86_64/baseos/os'
        replace: "{{ baseos_baseurl }}"

    - name: Modify hard coded appstream content path
      ansible.builtin.replace:
        path: /etc/osbuild-composer/repositories/rhel-90.json
        regexp: 'https://cdn.redhat.com/content/dist/rhel9/9/x86_64/appstream/os'
        replace: "{{ appstream_baseurl }}"

    - name: Remove redhat-uep.pem file
      ansible.builtin.file:
        path: /etc/rhsm/ca/redhat-uep.pem
        state: absent
    
    - name: Create link to katello-ca-cert
      ansible.builtin.file:
        src: /etc/rhsm/ca/katello-server-ca.pem
        dest: /etc/rhsm/ca/redhat-uep.pem
        owner: root
        group: root
        state: link
    
    - name: Enable Related Services
      ansible.builtin.service:
        name: osbuild-composer
        state: started
        enabled: True
    
    - name: Reboot bastion for osbuild-composer
      ansible.builtin.reboot:

    - name: Restart cockpit after reboot
      ansible.builtin.service:
        name: cockpit
        state: started
