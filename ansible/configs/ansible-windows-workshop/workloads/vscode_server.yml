---
- name: Vscode configuration block
  when: install_vscode_server | bool
  block:
    - name: Install vscode server
      ansible.builtin.include_role:
        name: vscode-server

    - name: Clean up
      ansible.builtin.file:
        path: "/tmp/code-server.rpm"
        state: absent

    - name: ensure custom facts directory exists
      ansible.builtin.file:
        path: "/home/{{ student_name }}/.local/share/code-server/User/"
        recurse: true
        state: directory
        owner: "{{ student_name }}"

    - name: Apply code server defaults
      ansible.builtin.template:
        src: ./files/settings.json
        dest: "/home/{{ student_name }}/.local/share/code-server/User/settings.json"
        owner: "{{ student_name }}"

    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: /home/{{ student_name }}/.local/share/code-server/extensions/
        state: directory
        owner: "{{ student_name }}"
        group: "{{ student_name }}"

    - name: Download files for vscode
      ansible.builtin.get_url:
        url: "{{ item }}"
        dest: /home/{{ student_name }}/.local/share/code-server/extensions/
        owner: "{{ student_name }}"
        group: "{{ student_name }}"
      loop:
        - https://github.com/ansible/workshops/raw/devel/files/bierner.markdown-preview-github-styles-0.1.6.vsix
        - https://github.com/ansible/workshops/raw/devel/files/hnw.vscode-auto-open-markdown-preview-0.0.4.vsix
        - https://github.com/ansible/workshops/raw/devel/files/redhat.ansible-0.4.5.vsix
      register: download_extension
      until: download_extension is not failed
      retries: 5

    - name: install ansible and markdown extensions
      become_user: "{{ student_name }}"
      ansible.builtin.command: "/bin/code-server --install-extension /home/{{ student_name }}/.local/share/code-server/extensions/{{ item }}"
      loop:
        - bierner.markdown-preview-github-styles-0.1.6.vsix
        - hnw.vscode-auto-open-markdown-preview-0.0.4.vsix
        - redhat.ansible-0.4.5.vsix
      ignore_errors: true
      register: install_extension
      until: install_extension is not failed
      retries: 5

    - name: restart code-server
      ansible.builtin.systemd:
        name: code-server
        state: restarted

    - name: Insert vscode proxy conf in nginx
      when: install_automationcontroller | bool
      ansible.builtin.blockinfile:
        path: /etc/nginx/conf.d/automation-controller.nginx.conf
        marker: "    # ANSIBLE MANAGED BLOCK"
        insertbefore: '.*location \/ \{.*'
        block: "{{ lookup('file', './files/vscode_nginx.conf') }}"

    - name: Restart nginx
      when: install_automationcontroller | bool
      ansible.builtin.service:
        name: nginx
        state: restarted
