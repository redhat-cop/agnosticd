---
- name: Init AWS account for ROSA HCP
  ansible.builtin.command: >-
    /usr/local/bin/rosa init

- name: Get available regions for ROSA
  ansible.builtin.command: /usr/local/bin/rosa list regions --output json
  register: r_rosa_regions

- name: Find regions that support ROSA with Hosted Control Planes
  set_fact:
    rosa_hcp_regions: "{{ r_rosa_regions.stdout | from_json | json_query(query) }}"
  vars:
    query: "[?supports_hypershift == `true`].id"

- name: Print regions supporting HCP Rosa
  ansible.builtin.debug:
    msg: "{{ rosa_hcp_regions }}"

- name: Check if requested region is supported
  when: not aws_region in rosa_hcp_regions
  ansible.builtin.fail:
    msg: "Requested region '{{ aws_region }}' is not supported by ROSA for Hosted Control Planes."

- name: Get list of available ROSA HCP versions
  ansible.builtin.command: >-
    /usr/local/bin/rosa list versions -o json
  register: r_rosa_versions

- name: Set default facts for ROSA HCP version
  ansible.builtin.set_fact:
    rosa_version_to_install: ""
    rosa_ocp_cli_version: "{{ r_rosa_versions.stdout | from_json | json_query(query) }}"
  vars:
    query: "[?default==`true`]"

- name: Set ROSA HCP version to install to specific version
  when:
  - rosa_version | default("") | length > 0
  - rosa_version | default("") != "latest"
  ansible.builtin.set_fact:
    rosa_version_to_install: "{{ rosa_version }}"
    rosa_ocp_cli_version: "{{ rosa_version }}"

- name: Set ROSA HCP version to latest available
  when: rosa_version | default("") == "latest"
  ansible.builtin.set_fact:
    rosa_version_to_install: "{{ (r_rosa_versions.stdout | from_json) [0].raw_id }}"
    rosa_ocp_cli_version: "{{ (r_rosa_versions.stdout | from_json) [0].raw_id }}"

- name: Print ROSA HCP version to install
  ansible.builtin.debug:
    msg: "{{ item }}"
  loop:
  - "ROSA HCP Version to be installed: '{{ rosa_version_to_install }}'."
  - "OCP CLI to be installed:      '{{ rosa_ocp_cli_version}}'."

- name: Clone ROSA HCP terraform files
  ansible.builtin.git:
    accept_hostkey: true
    repo: "{{ rosa_terraform_repo }}"
    dest: "~{{ ansible_user }}/terraform-vpc"
    version: "{{ rosa_terraform_repo_branch }}"

- name: Run terraform init
  ansible.builtin.command:
    cmd: /usr/local/bin/terraform init
    chdir: "~{{ ansible_user }}/terraform-vpc"

- name: Run terraform plan
  ansible.builtin.command:
    cmd: >-
      /usr/local/bin/terraform plan
        -out rosa.tfplan
        -var region={{ aws_region }}
        -var cluster_name=rosa-{{ guid }}
    chdir: "~{{ ansible_user }}/terraform-vpc"

- name: Run terraform apply
  ansible.builtin.command:
    cmd: >-
      /usr/local/bin/terraform apply rosa.tfplan
    chdir: "~{{ ansible_user }}/terraform-vpc"

- name: Get created subnets
  ansible.builtin.command:
    cmd: >-
      /usr/local/bin/terraform output -raw cluster-subnets-string
    chdir: "~{{ ansible_user }}/terraform-vpc"
  register: r_subnets

- name: Save created subnets in a fact
  ansible.builtin.set_fact:
    rosa_subnets: "{{ r_subnets.stdout }}"

- name: Create ROSA HCP account roles
  ansible.builtin.command: >-
    /usr/local/bin/rosa create account-roles
      --hosted-cp
      --region {{ aws_region }}
      --force-policy-creation
      --mode auto
      --yes

- name: Create ROSA HCP OIDC config
  ansible.builtin.command: >-
    /usr/local/bin/rosa create oidc-config
      --region {{ aws_region }}
      --mode=auto
      --yes
      --output json
  register: r_oidc_config

- name: Save OIDC ID in a fact
  ansible.builtin.set_fact:
    rosa_oidc_id: "{{ (r_oidc_config.stdout | from_json).id }}"

- name: Print facts
  ansible.builtin.debug:
    msg: "Subnets: {{ rosa_subnets }}, OIDC ID: {{ rosa_oidc_id }}"

- name: Create ROSA HCP operator roles
  ansible.builtin.command: >-
    /usr/local/bin/rosa create operator-roles
      --hosted-cp \
      --mode auto \
      --yes \
      --region {{ aws_region }}
      --prefix rosa-{{ guid }} \
      --oidc-config-id {{ rosa_oidc_id }} \
      --installer-role-arn arn:aws:iam::{{ hostvars.localhost.sandbox_account_id }}:role/ManagedOpenShift-HCP-ROSA-Installer-Role

- name: Create ROSA HCP Cluster with default OpenShift version
  when: rosa_version_to_install | default("") | length == 0
  ansible.builtin.command: >-
    /usr/local/bin/rosa create cluster \
      --cluster-name=rosa-{{ guid }} \
      --sts \
      --mode=auto \
      --yes \
      --hosted-cp \
      --region {{ aws_region }} \
      --operator-roles-prefix rosa-{{ guid }} \
      --oidc-config-id {{ rosa_oidc_id }} \
      --subnet-ids={{ rosa_subnets }}
  register: r_rosa_create_status
  until: r_rosa_create_status.rc == 0
  retries: 10
  delay: 60

- name: Create ROSA HCP Cluster with latest or specific OpenShift version
  when: rosa_version_to_install | default("") | length > 0
  ansible.builtin.command: >-
    /usr/local/bin/rosa create cluster \
      --cluster-name=rosa-{{ guid }} \
      --sts \
      --mode=auto \
      --yes \
      --hosted-cp \
      --version {{ rosa_version_to_install }} \
      --region {{ aws_region }} \
      --operator-roles-prefix rosa-{{ guid }} \
      --oidc-config-id {{ rosa_oidc_id }} \
      --subnet-ids={{ rosa_subnets }}
  register: r_rosa_create_status
  until: r_rosa_create_status.rc == 0
  retries: 10
  delay: 60

- name: Wait for ROSA HCP installer completion
  ansible.builtin.command: >-
    /usr/local/bin/rosa describe cluster
    --cluster {{ rosa_cluster_name }}
    -o json
  register: r_rosa_installer_status
  until:
  - (r_rosa_installer_status.stdout | from_json).status is defined
  - (r_rosa_installer_status.stdout | from_json).status.state is defined
  - (r_rosa_installer_status.stdout | from_json).status.state == "ready"
  retries: 120
  delay: 60

- name: Create ROSA HCP admin user
  ansible.builtin.shell: "/usr/local/bin/rosa create admin --cluster {{ rosa_cluster_name }} | grep 'oc login' | awk '{print $7}'"
  register: r_rosa_admin_result

- name: Save ROSA HCP admin password
  ansible.builtin.set_fact:
    rosa_admin_password: "{{ r_rosa_admin_result.stdout }}"

- name: Print cluster-admin password
  ansible.builtin.debug:
    msg: "Password for cluster-admin is '{{ rosa_admin_password }}'"

- name: Wait for ROSA HCP console URL to be available
  ansible.builtin.command: >-
    /usr/local/bin/rosa describe cluster
    --cluster {{ rosa_cluster_name }}
    -o json
  register: r_rosa_installer_status
  until:
  - (r_rosa_installer_status.stdout | from_json).console is defined
  - (r_rosa_installer_status.stdout | from_json).console.url is defined
  retries: 60
  delay: 60

- name: Get ROSA HCP API URL
  ansible.builtin.set_fact:
    rosa_api_url: "{{ (r_rosa_installer_status.stdout | from_json).api.url }}"

- name: Get ROSA HCP console URL
  ansible.builtin.set_fact:
    rosa_console_url: "{{ (r_rosa_installer_status.stdout | from_json).console.url }}"
