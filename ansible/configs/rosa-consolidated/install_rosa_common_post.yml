---
- name: Get ROSA API URL
  ansible.builtin.set_fact:
    rosa_api_url: "{{ (r_rosa_installer_status.stdout | from_json).api.url }}"

- name: Get ROSA console URL
  ansible.builtin.set_fact:
    rosa_console_url: "{{ (r_rosa_installer_status.stdout | from_json).console.url }}"

- name: Create ROSA admin user when no username specified
  when:
  - rosa_setup_cluster_admin | default(false) | bool
  - rosa_cluster_admin_username | default('') | length == 0
  block:
  - name: Create ROSA admin user
    ansible.builtin.shell: "/usr/local/bin/rosa create admin --cluster {{ rosa_cluster_name }} | grep 'oc login' | awk '{print $7}'"
    register: r_rosa_admin_result

  - name: Save ROSA admin user
    ansible.builtin.set_fact:
      _rosa_cluster_admin: cluster-admin

  - name: Save ROSA admin user password
    ansible.builtin.set_fact:
      _rosa_cluster_admin_password: "{{ r_rosa_admin_result.stdout }}"

  - name: Print cluster-admin password
    ansible.builtin.debug:
      msg: "Password for cluster-admin is '{{ _rosa_cluster_admin_password }}'"

- name: Remove kubeadmin secret
  when: remove_kubeadmin_secret | default(false) | bool
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Secret
    name: kubeadmin
    namespace: kube-system
