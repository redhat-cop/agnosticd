---

- name: "Get ami: {{ os.name }}"
  ec2_ami_info:
    owners: "{{ os.image.owners | default(omit) }}"
    filters:
      name: "{{ os.image.filter }}"
      architecture: "{{ os.image.architecture | default(omit) }}"
  register: amis
  when: os.image.ami_fact_names | length > 0

- name: "Save ami: {{ os.name }}"
  set_fact:
    "{{ item }}": >
      {{ amis.images | selectattr('name', 'defined') | sort(attribute='creation_date') | last | default({"image_id": "not-found"}) }}
  loop: "{{ os.image.ami_fact_names }}"
