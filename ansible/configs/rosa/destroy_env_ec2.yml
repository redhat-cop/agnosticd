---
- name: Destroy EC2
  hosts: bastions
  gather_facts: false
  become: false
  environment:
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  tasks:
  - name: Destroy ROSA Cluster
    command: "/usr/local/bin/rosa delete cluster -y --cluster={{ rosa_cluster_name }}"

  - name: Wait for ROSA deletion to complete
    command: "/usr/local/bin/rosa describe cluster -c {{ rosa_cluster_name }}"
    register: rosa_cluster_status
    ignore_errors: true
    until: rosa_cluster_status.rc != 0
    retries: 60
    delay: 60

  - name: Make sure ROSA cluster is gone
    fail:
      msg: "The ROSA cluster still exists after one hour of trying to delete.  Please look at it manually."
    when: rosa_cluster_status.rc == 0

- import_playbook: ../../setup_runtime.yml

- name: Destroy environment on AWS
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  environment:
    AWS_ACCESS_KEY_ID: "{{aws_access_key_id}}"
    AWS_SECRET_ACCESS_KEY: "{{aws_secret_access_key}}"
    AWS_DEFAULT_REGION: "{{aws_region_final|d(aws_region)}}"
  tasks:
  - name: Create infra key
    include_role:
      name: infra-ec2-ssh-key
    when:
    - install_infra_ssh_key | default(false) | bool

- name: Import default cloud provider destroy playbook
  import_playbook: "../../cloud_providers/{{ cloud_provider }}_destroy_env.yml"
