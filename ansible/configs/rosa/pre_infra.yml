---
- name: Step 000 - Pre Infrastructure
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tags:
  - step000
  - pre_infrastructure
  tasks:
  - debug:
      msg: "Step 000 Pre Infrastructure"

  - name: Call infra-local-create-ssh-key role
    when: set_env_authorized_key | bool
    import_role:
      name: infra-local-create-ssh_key
    tags:
    - generate_env_keys

  - name: Ensure variables are set
    assert:
      that:
      - rosa_token is defined
      - rosa_token | default("") | length > 0
      fail_msg: rosa_token variable must be defined
      success_msg: rosa_token variable is defined

  - name: AWS Pre Infrastructure tasks
    when: cloud_provider == 'ec2'
    block:
    - name: Create EC2 Infra Key
      when: install_infra_ssh_key | default(false) | bool
      include_role:
        name: infra-ec2-ssh-key

- name: Set student Console password
  set_fact:
    student_console_password: >-
      {{ lookup('password', '/dev/null length=12') -}}
      {{- lookup('password', '/dev/null length=1 chars=digits') }}

- name: Get the current caller identity information
  environment:
    AWS_ACCESS_KEY_ID: "{{aws_access_key_id}}"
    AWS_SECRET_ACCESS_KEY: "{{aws_secret_access_key}}"
    AWS_DEFAULT_REGION: "{{aws_region_final|d(aws_region)}}"
  aws_caller_info:
  register: _caller_info

- name: Set  account ID
  set_fact:
    sandbox_account_id: "{{ _caller_info.account }}"

