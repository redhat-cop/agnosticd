- name: Setup k8s virtualenv
  vars:
    ansible_become: true
    host_virtualenv_path: /opt/virtualenvs/k8s
    host_virtualenv_requirements: [requirements_k8s.txt]
  ansible.builtin.include_role:
    name: host_virtualenv

- name: Set ansible python interpreter to k8s virtualenv
  ansible.builtin.set_fact:
    ansible_python_interpreter: /opt/virtualenvs/k8s/bin/python

- name: Run authentication
  community.okd.k8s_auth:
    host: "{{ rosa_api_url.stdout }}"
    username: cluster-admin
    password: "{{ rosa_admin_result.stdout }}"
    validate_certs: false
  register: _r_kube_auth
  retries: 30
  delay: 120
  until:
  - _r_kube_auth is defined
  - _r_kube_auth.k8s_auth is defined
  - _r_kube_auth.k8s_auth.api_key is defined

- name: Create a directory for kubeconfig if it does not exist
  ansible.builtin.file:
    path: ~/.kube
    state: directory
    mode: 0755

- name: generate kubeconfig
  ansible.builtin.template:
    src: templates/kubeconfig.j2
    dest: ~/.kube/config

- name: Deploy Bookbag
  when: deploy_bookbag | bool
  ansible.builtin.include_role:
    name: bookbag
  vars:
    ACTION: create
