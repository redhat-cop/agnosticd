# vim: set ft=yaml.ansible
---
- name: Step 005 Post Software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tags:
    - step005
    - post_software
  tasks:
    - name: Entering the roadshow-binder post_software
      ansible.builtin.debug:
        msg:
          - Entering the roadshow-binder post_software

    - name: Add bastion private keys to output_dir
      ansible.builtin.copy:
        content: "{{ item.ssh_private_key }}\n"
        dest: "{{ output_dir }}/{{ item.key_name }}_sshkey.pem"
        mode: '0400'
      loop:
        - key_name: roadshow_cluster
          ssh_private_key: "{{ cnv_prov_data.ssh_provision_key }}"

    - name: Add Clusters to run time inventory - add bastions to hosts
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        groups: "{{ item.group }}"
        ansible_ssh_private_key_file: "{{ output_dir }}/{{ item.key_name }}_sshkey.pem"
        ansible_user: cloud-user
        remote_user: cloud-user
        ansible_ssh_extra_args: "-o StrictHostKeyChecking=no"
      loop:
        - name: "{{ cnv_prov_data.bastion_public_hostname }}"
          key_name: roadshow_cluster
          group: bastions

# Deploy Workloads
- name: Step 005.2 - Deploy Infra and Student Workloads
  ansible.builtin.include_tasks: workloads.yml

- name: Exiting the roadshow-binder post_software.yml
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
    - name: Exiting the roadshow-binder post_software.yml
      ansible.builtin.debug:
        msg:
          - Exiting the roadshow-binder post_software.yml
