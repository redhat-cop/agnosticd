---

- name: Check that student_password is set
  fail:
    msg: "'student_password' needs to be set"
  when:
    - student_password is not defined

- name: Create user
  user:
    name: "{{ student_name }}"
    password: "{{ student_password|password_hash('sha512') }}"
    comment: GTPE Student
    group: users
    groups: "{{ 'wheel' if student_sudo | bool else '' }}"
    shell: /bin/bash
    state: present

- name: Add student public key
  authorized_key:
    user: "{{ student_name }}"
    key: "{{ student_key }}"
  when: student_key is defined

- name: Enable password authentication
  lineinfile:
    line: PasswordAuthentication yes
    regexp: '^ *PasswordAuthentication'
    path: /etc/ssh/sshd_config

- name: Allow passwordless sudo
  lineinfile:
    path: '/etc/sudoers'
    state: present
    line: "{{ student_name }}         ALL=(ALL)       NOPASSWD: ALL"
    insertafter: "'^{{ remote_user | default(ansible_user) }}"
  when: student_sudo | bool

- name: Restart sshd
  service:
    name: sshd
    state: restarted
