---
- name: Step 004 infra
  hosts: all
  gather_facts: true
  tags:
    - step004
    - deploy_software
  tasks:
    - name: Process software workloads
      loop: "{{ agnosticd_software_workloads | default([]) }}"
      loop_control:
        loop_var: _workload
        label: "{{ _workload.name }}"
      include_role:
        name: "{{ _workload.name }}"
        defaults_from: "{{ _workload.defaults_from | default('main') }}"
        handlers_from: "{{ _workload.defaults_from | default('main') }}"
        tasks_from: "{{ _workload.tasks_from | default('main') }}"
        vars_from: "{{ _workload.vars_from | default('main') }}"
      when:
        - "'group' not in _workload or _workload.group in group_names"
