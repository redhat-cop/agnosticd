- name: Step 00xxxxx post software
  hosts: support
  gather_facts: False
  become: yes
  tasks:
    - debug:
        msg: "Post-Software tasks Started"

- name: Step lab post software deployment
  hosts: bastions
  gather_facts: False
  become: yes
  tags:
    - opentlc_bastion_tasks
  tasks:
    - import_role:
        name: "bastion-opentlc-ipa"
      when: install_ipa_client|bool
    - import_role:
        name: "tower-license-copy"

    - name: Push git lab files to git repo
      import_role:
         name: git-copy-files

# sssd bug, fixed by restart
    - name: restart sssd
      service:
        name: sssd
        state: restarted
      when: install_ipa_client

- hosts: towers
  become: yes
  roles:
    - setup-postfix


- name: Deploy workload(s) role on bastion of the shared cluster
  hosts: localhost
  connection: local
  gather_facts: false
  tags:
    - step005
  tasks:
    - name: Save user info
      agnosticd_user_info:
        data:
          student_ssh_password: >-
            {{ student_password | default(hostvars[groups.bastions.0].student_password) }}
          student_ssh_command: >-
            ssh {{ student_name }}@bastion.{{ guid }}.{{ osp_cluster_dns_zone }}
    - debug:
        msg: "Post-Software checks completed successfully"
