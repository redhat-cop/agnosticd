---
- name: Destroy environment on OpenShift CNV
  hosts: localhost
  gather_facts: false
  tasks:
  - name: Remove ocp workloads
    when: remove_workloads | default("") | length > 0
    block:
    - name: Invoke roles to remove ocp workloads
      ansible.builtin.include_role:
        name: "{{ workload_loop_var }}"
      vars:
        ocp_username: "system:admin"
        ACTION: "remove"
        silent: false
      loop: "{{ remove_workloads }}"
      loop_control:
        loop_var: workload_loop_var

  - name: Find and delete all VMs on the cluster
    when: delete_vms_on_destroy | default(false) | bool
    block:
    - name: Sanity Check that OpenShift Virtualization is deployed on the cluster
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
        name: "virtualmachines.kubevirt.io"
      register: r_vm_crd
    
    - name: Only delete VMs if OpenShift Virtualization is installed
      when:
      - r_vm_crd.resources is defined
      - r_vm_crd.resources | length == 1
      block:
      - name: Find all VMs on the cluster
        kubernetes.core.k8s_info:
          api_version: kubevirt.io/v1
          kind: VirtualMachine
        register: r_vms
      
      - name: Delete all VMs on the cluster
        when: 
        - r_vms.resources is defined
        - r_vms.resources | length > 0
        kubernetes.core.k8s:
          state: absent
          api_version: kubevirt.io/v1
          kind: VirtualMachine
          name: "{{ vm.metadata.name }}"
          namespace: "{{ vm.metadata.name }}"
        loop: "{{ r_vms.resources }}"
        loop_control:
          loop_var: vm

  - name: Run host-ocp4-assisted-destroy role
    ansible.builtin.include_role:
      name: host-ocp4-assisted-destroy

- name: Import default cloud provider destroy playbook
  import_playbook: "../../cloud_providers/{{ cloud_provider }}_destroy_env.yml"
