---
# Post Start actions for OCP 4 Cluster configs
- name: Run recover cluster actions
  hosts: bastions
  run_once: true
  become: false
  gather_facts: false
  tasks:
    - name: Set Ansible Python interpreter to k8s virtualenv
      set_fact:
        ansible_python_interpreter: /opt/virtualenvs/k8s/bin/python

    - name: Perform actions on start
      when: ACTION == 'start'
      block:
        - name: Test the bastion host is available, if not skip approve csr and pod cleanup
          wait_for_connection:
            timeout: 60
          register: bwait
          ignore_errors: true

        - when: bwait is successful
          block:
            - name: Approve CertificateSigningRequests
              include_role:
                name: ocp4_approve_certificate_signing_requests
