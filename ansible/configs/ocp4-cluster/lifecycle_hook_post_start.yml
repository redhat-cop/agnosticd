---
# Post Start actions for OCP 4 Cluster configs

- name: Build inventory
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
  - when: cloud_provider == 'ec2'
    name: Run infra-ec2-create-inventory Role
    include_role:
      name: infra-ec2-create-inventory

  - when: cloud_provider == 'osp'
    name: Run infra-osp-create-inventory Role
    include_role:
      name: infra-osp-create-inventory

  - when: cloud_provider == 'azure'
    name: Run infra-azure-create-inventory Role
    include_role:
      name: infra-azure-create-inventory

  - name: Run Common SSH Config Generator Role
    include_role:
      name: infra-common-ssh-config-generate
    when: "'bastions' in groups"

- name: Set ansible_ssh_extra_args
  hosts:
  - all:!windows:!network
  gather_facts: false
  any_errors_fatal: true
  ignore_errors: false
  tasks:
  - name: Set facts for remote access
    set_fact:
      ansible_ssh_extra_args: >-
        {{ ansible_ssh_extra_args|d() }}
        -F {{hostvars.localhost.output_dir}}/{{ env_type }}_{{ guid }}_ssh_conf

- name: Run recover cluster actions
  hosts: bastions
  run_once: true
  become: false
  gather_facts: false
  tasks:
  - name: Set Ansible Python interpreter to k8s virtualenv
    set_fact:
      ansible_python_interpreter: /opt/virtualenvs/k8s/bin/python

  - name: Perform actions on start
    when: ACTION == 'start'
    block:
    - name: Approve CertificateSigningRequests
      include_role:
        name: ocp4_approve_certificate_signing_requests

    - name: Cleanup failed pods
      include_role:
        name: ocp_cleanup_failed_pods
