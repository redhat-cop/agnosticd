---
- name: Import default destroy playbook
  import_playbook: ../../cloud_providers/{{cloud_provider}}_destroy_env.yml

- name: OCP CRC DNS setup
  hosts: localhost
  gather_facts: false
  tasks:
    - set_fact:
        crc_find_ip_query: "{{ r_osp_facts | json_query(ansible_facts.openstack_servers[?name=='stfcrc'].public_v4 | [0]) }}"

    - name: Add DNS entry for OpenShift API and console
      nsupdate:
        server: "{{ osp_cluster_dns_server }}"
        zone: "{{ osp_cluster_dns_zone }}"
        record: "{{ item.dns }}.{{ guid }}"
        type: A
        ttl: 5
        port: "{{ osp_cluster_dns_port | d('53') }}"
        value: "{{ item.name }}"
        key_name: "{{ ddns_key_name }}"
        key_secret: "{{ ddns_key_secret }}"
        state: absent
      loop:
        - name: "{{ crc_find_ip_query }}"
          dns: "api.stfcrc"
        - name: "{{ crc_find_ip_query }}"
          dns: "console-openshift-console.stfcrc"
        - name: "{{ crc_find_ip_query }}"
          dns: "*.apps-crc.stfcrc"
      loop_control:
        label: item.name