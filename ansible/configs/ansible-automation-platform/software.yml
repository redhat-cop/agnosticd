---
- name: Step 00xxxxx software
  hosts: localhost
  gather_facts: False
  become: false
  tasks:
    - debug:
        msg: "Software tasks Started"

- hosts: all
  gather_facts: yes
  tasks:
    - name: Dump all variables
      local_action:
        module: template
        src: dumpall.j2
        dest: /tmp/ansible_dump.all
      run_once: true
      when: dump_vars|default(false)|bool

- name: Install Ansible automation controller
  hosts: bastions[0]
  gather_facts: false
  become: true

  tasks:

    - name: Install code-server (config role)
      include_role:
        name: vscode-server_cfg

    - name: Download Manifest for Controller
      get_url:
        url: "{{ controller_manifest.url }}"
        dest: /tmp
        username: "{{ controller_manifest.username }}"
        password: "{{ controller_manifest.password }}"

    - name: Install Ansible automation controller (config role)
      include_role:
        name: deploy_automationcontroller_cfg

- name: Install license and LE certs on autoctl nodes
  hosts: automationcontroller
  gather_facts: false
  become: true

  tasks:

    - name: License autoctl nodes (config role)
      include_role:
        name: tower-license-injector_cfg
      run_once: true

    - name: call issue_cert role (config role)
      include_role:
        name: automation_controller_issue_cert_cfg

    ## Execution environments

    # - name: Login to redhat registry
    #   become_user: "{{ item }}"
    #   containers.podman.podman_login:
    #     username: '{{ redhat_username }}'
    #     password: '{{ redhat_password }}'
    #     registry: registry.redhat.io
    #   loop:
    #   - awx
    #   - "{{ username }}"

    # - name: Pull an image
    #   become_user: "{{ item[0] }}"
    #   containers.podman.podman_image:
    #     name: "{{ item[1] }}"
    #   with_nested:
    #   - [ "awx" , "{{ username }}" ]
    #   - [ "registry.redhat.io/ansible-automation-platform-20-early-access/ee-supported-rhel8" , "registry.redhat.io/ansible-automation-platform-20-early-access/ee-29-rhel8" , "registry.redhat.io/ansible-automation-platform-20-early-access/ee-minimal-rhel8" ]

    - name: create container registry credential
      awx.awx.credential:
        name: registry.redhat.io credential
        organization: Default
        credential_type: Container Registry
        controller_host: "https://{{ ansible_host }}"
        controller_username: admin
        controller_password: "{{ deploy_automationcontroller_admin_password }}"
        validate_certs: false
        inputs:
          username: "{{ registry_username }}"
          password: "{{ registry_password }}"
          host: "registry.redhat.io"

    - name: update default EE to use credential
      awx.awx.execution_environment:
        name: "Default execution environment"
        image: "registry.redhat.io/ansible-automation-platform-20-early-access/ee-supported-rhel8:2.0.0"
        pull: missing
        credential: "registry.redhat.io credential"
        controller_username: admin
        controller_password: "{{ deploy_automationcontroller_admin_password }}"
        controller_host: "https://{{ ansible_host }}"
        validate_certs: false
      register: ee_check
      until: ee_check is not failed
      retries: 4
      delay: 5

    ### end of execution environments

- name: Software flight-check
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    - debug:
        msg: "Software checks completed successfully"
