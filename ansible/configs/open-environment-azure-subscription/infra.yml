---
- name: Step 001 infra
  hosts: localhost
  gather_facts: false
  become: false
  tasks:
    - debug:
        msg: "Infra tasks Started {{ subscription_id }}"

    - name: Set facts for proper subscription
      ansible.builtin.set_fact:
        azure_subscription_id: "{{ subscription_id }}"
        az_resource_group: "openenv-{{ guid }}"

# must be indented as is, or fails on "import_playbook has extra params"
- name: Deploy a bastion, if desired
  when: ( install_aro | default(false) | bool )
    or ( azure_deploy_bastion | default(false) | bool )
  import_playbook: "../../cloud_providers/azure_infrastructure_deployment.yml"
  vars:
    azure_subscription_id: "{{ subscription_id }}"

- name: Install OC client and helm
  when: ( install_aro | default(false) | bool )
    or ( azure_deploy_bastion | default(false) | bool )
  hosts: bastions
  become: true
  gather_facts: false
  tasks:
    - name: Install OC client
      when: install_aro | bool
      block:
        - name: Set URL for OpenShift GA release
          set_fact:
            ocp4_client_url: >-
              {{ '{0}/ocp/{1}/openshift-client-linux-{1}.tar.gz'.format(
                ocp4_installer_root_url | default("https://mirror.openshift.com/pub/openshift-v4/clients"),
                az_aro_version
              ) }}

        - name: Ensure ocp4_client_url is set
          assert:
            that: ocp4_client_url | default('') | length > 0

        - name: Install OpenShift CLI
          become: true
          unarchive:
            src: "{{ ocp4_client_url }}"
            remote_src: true
            dest: /usr/bin
            mode: 0775
            owner: root
            group: root
          retries: 10
          register: r_client
          until: r_client is success
          delay: 30

        - name: Set URL for helm
          set_fact:
            helm_url: >-
              {{ '{0}/helm/latest/helm-linux-amd64.tar.gz'.format(
                ocp4_installer_root_url | default("https://mirror.openshift.com/pub/openshift-v4/clients")
              ) }}

        - name: Install helm command
          become: true
          unarchive:
            src: "{{ helm_url }}"
            remote_src: true
            dest: /usr/bin
            mode: 0775
            owner: root
            group: root
          retries: 10
          register: r_client
          until: r_client is success
          delay: 30

- name: Infra Tasks
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - debug:
        msg: "Infra tasks completed successfully"
