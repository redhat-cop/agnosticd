---
# - name: Configure bastion hosts with Repositories and Common Files
#   hosts: bastions
#   become: true
#   gather_facts: false
#   roles:
#     - when: repo_method is defined
#       role: set-repositories

#     - when: install_common | bool
#       role: common

#     - when: install_bastion_lite | bool
#       role: bastion-lite

#     - when: install_control_user | bool
#       role: control-user


- name: Configure Satellite server
  hosts: satellites
  become: true
  gather_facts: false
  tasks:
    - name: Create selinux autorelabel file
      file:
        path: /.autorelabel
        state: touch

    - name: Replace private ip in /etc/hosts
      replace:
        path: /etc/hosts
        regexp: ".*satellite.example.com.*"
        replace: "{{ ansible_facts.default_ipv4.address }} satellite.example.com"

    # Todo: Add condition to reboot satellite node
    - name: Reboot satellite node 
      block:
        - name: Reboot satellite node
          reboot:
            connect_timeout: 300
            msg: "Satellite node is rebooting now."
            pre_reboot_delay: 60
            post_reboot_delay: 10
            
        - name: Update network facts after reboot
          setup:
            gather_subset:
              - 'network'
              - 'virtual'

    - name: Refresh subscription manifest
      command: >-
        hammer subscription
        refresh-manifest
        --organization="{{satellite_org}}"
      async: 600
      poll: 30Â  


# - name: Install Pre Software workloads
#   hosts: bastions
#   become: true
#   tasks:
#     - name: Deploy Pre Software workloads
#       when: pre_software_workloads_for_bastion | default("") | length > 0
#       include_role:
#         name: "{{ _pre_bastion }}"
#       loop: "{{ pre_software_workloads_for_bastion }}"
#       loop_control:
#         loop_var: _pre_bastion

# - name: Install Pre Software workloads for nodes
#   hosts: rhel_nodes
#   become: true
#   tasks:
#     - name: Deploy Pre Software workloads
#       when: pre_software_workloads_for_nodes | default("") | length > 0
#       include_role:
#         name: "{{ _pre_rhel_nodes }}"
#       loop: "{{ pre_software_workloads_for_nodes }}"
#       loop_control:
#         loop_var: _pre_rhel_nodes

# - name: Install Pre Software workloads for nodes
#   hosts: centos_nodes
#   become: true
#   tasks:
#     - name: Deploy Pre Software workloads
#       when: pre_software_workloads_for_nodes | default("") | length > 0
#       include_role:
#         name: "{{ _pre_centos_nodes }}"
#       loop: "{{ pre_software_workloads_for_nodes }}"
#       loop_control:
#         loop_var: _pre_centos_nodes
