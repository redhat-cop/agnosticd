- name: Step 000 Pre Infrastructure
  hosts: localhost
  connection: local
  become: false
  tags:
  - step001
  - pre_infrastructure
  environment:
    OS_AUTH_URL: "{{ osp_auth_url }}"
    OS_USERNAME: "{{ osp_auth_username }}"
    OS_PASSWORD: "{{ osp_auth_password }}"
    OS_PROJECT_NAME: "admin"
    OS_PROJECT_DOMAIN_ID: "{{ osp_auth_project_domain }}"
    OS_USER_DOMAIN_NAME: "{{ osp_auth_user_domain }}"
  tasks:
    - debug:
        msg: "Step 000 Pre Infrastructure - Dummy action"
    
    - name: Create project for user
      os_project:
        name: "{{ osp_project_name }}"
        state: present
        description: Project for user {{ opentlc_user }}
        enabled: True
        domain_id: "Default"
        endpoint_type: public
      register: _r_osp_project_name
    
    # - name: Grant access to user on new project
    #   os_user_role:
    #     state: present
    #     user: "{{ opentlc_user }}"
    #     role: "{{ item }}"
    #     project: "{{ osp_project_name }}"
    #   with_items:
    #   - "_member_"
    #   - "swiftoperator"
    
    - name: Grant access to admin account on new project
      os_user_role:
        state: present
        user: "{{ admin_user }}"
        role: "admin"
        project: "{{ osp_project_name }}"
    
    - name: Set quotas on new project
      os_quota:
        name: "{{ osp_project_name }}"
        instances: "{{ quota_num_instances }}"
        cores: "{{ quota_num_cores }}"
        ram: "{{ quota_memory }}" #in MB
        volumes: "{{ quota_num_volumes }}"
        gigabytes: "{{ quota_volumes_gigs }}" #volume storage
        #loadbalancer: #when Octavia is available
        #pool: #when Octavia is available
        network: "{{ quota_networks }}"
        subnet: "{{ quota_subnets }}"
        router: "{{ quota_routers }}"
        floatingip: "{{ quota_fip }}"
        security_group: "{{ quota_sg }}"
        security_group_rule: "{{ quota_sg_rules }}"
    
    # - name: Create keypair for user
    #   os_keypair:
    #     name: "{{ opentlc_user }}-keypair"
    #     state: present
    #     public_key: "{{ user_pub_key }}"

      
