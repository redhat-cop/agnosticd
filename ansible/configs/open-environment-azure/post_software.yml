---
- name: Step 000 Post Software
  hosts: localhost
  connection: local
  become: false
  tags:
    - step001
    - post_software
  tasks:
    - debug:
        msg: "Step 000 Post Software - Starting"

    - name: Print Sandbox Information
      agnosticd_user_info:
        msg: "{{ item }}"
      loop:
        - "The resource group 'openenv-{{ guid }}' was created in our Azure organization."
        - "If you have previously accepted an invitation your environment should be available at https://portal.azure.com"
        - "Your Azure account should be SSO enabled, so please log into the portal with your Red Hat Credentials"
        - "Your account now has full access to this resource group.  All resources must be in this resource group or you will see permission denied errors."
        - "When this OPEN environment is deleted, the resource group will be removed and all data will be irrecovably removed."
        - "Please regularly back up your data and script your changes in case you need to rebuild."
        - "Please see this page for more information: https://www.opentlc.com/azure/openenv_documentation.html"
    - name: Print Password
      when: azpass is defined
      agnosticd_user_info:
        msg: "{{ item }}"
      loop:
        - ""
        - "An application, service principal, and resource group all named 'openenv-{{ guid }}' were created in our Azure organization."
        - "Service principal/app 'openenv-{{ guid }}' information:"
        - "Password: {{ azpass }}"
        - "Application/Client ID: {{ azapp['applications'][0].app_id }}"
        - "Object ID: {{ azapp['applications'][0].object_id }}"
        - "Tenant ID: {{ azure_tenant }}"
        - "Subscription ID: {{ azure_subscription_id }}"

    - name: Print ARO Info
      when:
        - az_aro_pass is defined
        - azaroappinfo is defined
      agnosticd_user_info:
        msg: "{{ item }}"
      loop:
        - ""
        - "When creating ARO clusters, you must specify the following credentials in the az aro create command using this preconfigured service principal:"
        - "Name: api://openenv-aro-{{ guid }}"
        - "App ID: {{ azaroappinfo.stdout | from_json | json_query('appId') }}"
        - "Password: {{ az_aro_pass }}"
        - ""
        - "Example ARO installation commands:"
        - "az login --service-principal -u {{ azapp['applications'][0].app_id }} -p '{{ azpass }}' --tenant {{ azure_tenant }}"
        - "az network vnet create --resource-group openenv-{{ guid }} --name aro-vnet-{{ guid }} --address-prefixes 10.0.0.0/22"
        - "az network vnet subnet create --resource-group openenv-{{ guid }} --vnet-name aro-vnet-{{ guid }} --name master-subnet --address-prefixes 10.0.0.0/23 --service-endpoints Microsoft.ContainerRegistry"
        - "az network vnet subnet create --resource-group openenv-{{ guid }} --vnet-name aro-vnet-{{ guid }} --name worker-subnet --address-prefixes 10.0.2.0/23 --service-endpoints Microsoft.ContainerRegistry"
        - "az network vnet subnet update --name master-subnet --resource-group openenv-{{ guid }} --vnet-name aro-vnet-{{ guid }} --disable-private-link-service-network-policies true"
        - "az aro create --resource-group openenv-{{ guid }} --name aro-cluster-{{ guid }} --vnet aro-vnet-{{ guid }} --master-subnet master-subnet --worker-subnet worker-subnet --client-id {{ azaroappinfo.stdout | from_json | json_query('appId') }} --client-secret '{{ az_aro_pass }}' --pull-secret @/path/to/pull-secret.txt"

- name: Step 002 Post Software
  hosts: localhost
  connection: local
  become: false
  tags:
    - step001
    - post_software
  tasks:
    - debug:
        msg: "Step 002 Post Software - Completed"

- name: Software flight-check
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    - debug:
        msg: "Post-Software checks completed successfully"
