---
- import_playbook: ../../include_vars.yml

- name: Cleanup and Delete all Infrastructure for the ROKS cluster
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - debug:
        msg: "Cleaning up Networking, Storage, and ROKS cluster"

- name: Logging into IBM Cloud
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    - name: Get bearer token
      uri:
        url: "{{ ibm_cloud_api_iam_url }}"
        method: POST
        body_format: form-urlencoded
        body: "grant_type=urn%3Aibm%3Aparams%3Aoauth%3Agrant-type%3Aapikey&apikey={{ ibm_admin_api_key }}"
      register: r_token
      tags: create-token
    - name: Set fact for bearer token
      set_fact:
        ibm_access_token: "{{ r_token.json.access_token }}"
      tags: store-token

- name: Cleanup and Delete all Infrastructure for the ROKS cluster
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    # Processing delete for ROKS Cluster
    - name: Delete ROKS cluster
      uri:
        url: "{{ ibm_cloud_api_container_v1_url }}/{{ guid }}-rhpds?{{ ibm_cloud_api_roks_del_uri_parameters }}"
        method: DELETE
        status_code: 204,404
        headers:
          Authorization: Bearer {{ ibm_access_token }}
      tags: delete-roks

- name: Cleanup and Delete all Infrastructure for the ROKS cluster
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - debug:
        msg: "IBM-ROKS is all cleaned up"
