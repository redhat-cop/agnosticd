bastion_instance_type: "t2.medium"
tower_instance_type: "t2.xlarge"
s4hana_instance_type: "r4.xlarge"
hana_instance_type: "r4.2xlarge"

bastion_instance_image: RHEL81
tower_instance_image: RHEL81
s4hana_instance_image: RHEL81
hana_instance_image: RHEL81

ansible_user: ec2-user
remote_user: ec2-user


bastion_public_dns: "bastion.{{subdomain_base}}."
bastion_public_dns_chomped: "bastion.{{subdomain_base}}"
tower_public_dns: "tower.{{subdomain_base}}."
tower_public_dns_chomped: "tower.{{subdomain_base}}"

aws_public_subnet_cidr: "192.168.0.0/24"

cloudformation_retries: 2

rootfs_size_bastion: 200
rootfs_size_tower: 200
rootfs_size_s4hana: 200
rootfs_size_hana: 200

security_groups:
  - name: WebSG
    rules:
      - name: HTTPPorts
        description: "HTTP Public"
        from_port: 80
        to_port: 80
        protocol: tcp
        cidr: "0.0.0.0/0"
        rule_type: Ingress

      - name: HTTPSPorts
        description: "HTTP Public"
        from_port: 443
        to_port: 443
        protocol: tcp
        cidr: "0.0.0.0/0"
        rule_type: Ingress

  - name: HostSG
    rules:
      - name: FromHostSG
        description: "Allow everything from HostSG nodes"
        from_port: 0
        to_port: 65535
        protocol: -1
        from_group: HostSG
        rule_type: Ingress

instances:
- name: "bastion"
  count: 1
  unique: true
  public_dns: true
  dns_loadbalancer: true
  floating_ip: true
  image: "{{ bastion_instance_image }}"
  flavor:
    ec2: "{{ bastion_instance_type }}"
  tags:
    - key: "AnsibleGroup"
      value: "bastions"
    - key: "ostype"
      value: "linux"
    - key: ansible_python_interpreter
      value: /usr/libexec/platform-python
  rootfs_size: "{{ rootfs_size_bastion }}"
  volumes:
    - name: /dev/sdf
      size: 100
  security_groups:
    - HostSG
    - BastionSG

- name: "tower"
  count: 1
  unique: true
  public_dns: true
  dns_loadbalancer: true
  floating_ip: true
  image: "{{ tower_instance_image }}"
  flavor:
    ec2: "{{ tower_instance_type }}"
  tags:
    - key: "AnsibleGroup"
      value: "towers"
    - key: "ostype"
      value: "linux"
    - key: ansible_python_interpreter
      value: /usr/libexec/platform-python
  rootfs_size: "{{ rootfs_size_tower }}"
  security_groups:
    - HostSG
    - BastionSG
    - WebSG

- name: "s4hana"
  count: 1
  unique: true
  public_dns: false
  dns_loadbalancer: false
  floating_ip: false
  image: "{{ s4hana_instance_image }}"
  flavor:
    ec2: "{{ s4hana_instance_type }}"
  tags:
  - key: "AnsibleGroup"
    value: "s4hanas"
  - key: "ostype"
    value: "linux"
  - key: ansible_python_interpreter
    value: /usr/libexec/platform-python
  rootfs_size: "{{ rootfs_size_s4hana }}"
  volumes:
    - name: /dev/sdf
      size: 200
  security_groups:
  - HostSG

- name: "hana"
  count: 2
  unique: false
  public_dns: false
  dns_loadbalancer: false
  floating_ip: false
  image: "{{ hana_instance_image }}"
  flavor:
    ec2: "{{ hana_instance_type }}"
  tags:
  - key: "AnsibleGroup"
    value: "hanas"
  - key: "ostype"
    value: "linux"
  - key: ansible_python_interpreter
    value: /usr/libexec/platform-python
  rootfs_size: "{{ rootfs_size_hana }}"
  volumes:
    - name: /dev/sdf
      size: 500
  security_groups:
  - HostSG

common_packages:
  - unzip
  - bash-completion
  - tmux
  - bind-utils
  - wget
  - git
  - vim-enhanced
  - at

### Ansible Tower default variables ###

ansible_tower:
  admin_username: "admin"
  admin_password: "{{ ansible_tower_password }}"
  url: "https://localhost"
  validate_certs: false
  install:
    license_file: "/tmp/license.json"
  inventories:
    - name: "sap-hosts"
      variables: '---\nsap_preconfigure_modify_etc_hosts: true\nsap_preconfigure_fail_if_reboot_required: \"no\"\nsap_domain: \"labs.local\"\nsap_hostagent_installation_type: \"rpm\"\nsap_hostagent_rpm_remote_path: \"/software/SAPHOSTAGENT\"\nsap_hostagent_rpm_file_name: \"saphostagentrpm_44-20009394.rpm\"'
      description: "SAP HANA and S/4HANA"
      organization: "Default"
      hosts:
      - name: "hana1"
        description: "Primary SAP HANA Host"
        variables: '---\nstorage_pools:\n  - name: sap\n    disks:\n      - xvdf\n    volumes:\n      - name: data\n        size: \"128 GiB\"\n        mount_point: \"/hana/data\"\n        state: present\n      - name: log\n        size: \"64 GiB\"\n        mount_point: \"/hana/log\"\n        state: present\n      - name: shared\n        size: \"256 GiB\"\n        mount_point: \"/hana/shared\"\n        state: present\n      - name: sap\n        size: \"50 GiB\"\n        mount_point: \"/usr/sap\"\n        state: present\nsap_hana_deployment_bundle_path: /software/HANA_installation\nsap_hana_deployment_bundle_sar_file_name: IMDB_SERVER20_046_0-80002031.SAR\nsap_hana_deployment_sapcar_path: /software/SAPCAR\nsap_hana_deployment_sapcar_file_name: SAPCAR_1311-80000935.EXE\nsap_hana_deployment_root_password: \"R3dh4t123!\"\nsap_hana_deployment_sapadm_password: \"R3dh4t123!\"\nsap_hana_deployment_hana_sid: RHE\nsap_hana_deployment_hana_instance_number: \"00\"\nsap_hana_deployment_hana_env_type: development\nsap_hana_deployment_hana_mem_restrict: \"n\"\nsap_hana_deployment_common_master_password: \"R3dh4t123!\"\nsap_hana_deployment_sidadm_password: \"R3dh4t123!\"\nsap_hana_deployment_hana_db_system_password: \"R3dh4t123!\"\nsap_hana_deployment_ase_user_password: \"R3dh4t123!\"\nsap_hana_deployment_apply_license: false'
      - name: "hana2"
        description: "Primary SAP HANA Host"
        variables: '---\nstorage_pools:\n  - name: sap\n    disks:\n      - xvdf\n    volumes:\n      - name: data\n        size: \"128 GiB\"\n        mount_point: \"/hana/data\"\n        state: present\n      - name: log\n        size: \"64 GiB\"\n        mount_point: \"/hana/log\"\n        state: present\n      - name: shared\n        size: \"256 GiB\"\n        mount_point: \"/hana/shared\"\n        state: present\n      - name: sap\n        size: \"50 GiB\"\n        mount_point: \"/usr/sap\"\n        state: present\nsap_hana_deployment_bundle_path: /software/HANA_installation\nsap_hana_deployment_bundle_sar_file_name: IMDB_SERVER20_046_0-80002031.SAR\nsap_hana_deployment_sapcar_path: /software/SAPCAR\nsap_hana_deployment_sapcar_file_name: SAPCAR_1311-80000935.EXE\nsap_hana_deployment_root_password: \"R3dh4t123!\"\nsap_hana_deployment_sapadm_password: \"R3dh4t123!\"\nsap_hana_deployment_hana_sid: RHE\nsap_hana_deployment_hana_instance_number: \"00\"\nsap_hana_deployment_hana_env_type: development\nsap_hana_deployment_hana_mem_restrict: \"n\"\nsap_hana_deployment_common_master_password: \"R3dh4t123!\"\nsap_hana_deployment_sidadm_password: \"R3dh4t123!\"\nsap_hana_deployment_hana_db_system_password: \"R3dh4t123!\"\nsap_hana_deployment_ase_user_password: \"R3dh4t123!\"\nsap_hana_deployment_apply_license: false'
      - name: "s4hana"
        description: "SAP S/4HANA Host"
        variables: '---\nstorage_pools:\n  - name: sap\n    disks:\n      - xvdf\n    volumes:\n      - name: sap\n        size: \"50 GiB\"\n        mount_point: \"/usr/sap\"\n        state: present\n      - name: sapmnt\n        size: \"20 GiB\"\n        mount_point: \"/usr/sapmnt\"\n        state: present\n      - name: swap\n        size: \"20 GiB\"\n        state: present\n\nsap_s4hana_deployment_product_id: \"NW_ABAP_OneHost:S4HANA1909.CORE.HDB.ABAP\"\nsap_s4hana_deployment_sapcar_path: \"/software/SAPCAR\"\nsap_s4hana_deployment_sapcar_file_name: \"SAPCAR_1311-80000935.EXE\"\nsap_s4hana_deployment_swpm_path: \"/software/S4HANA_installation\"\nsap_s4hana_deployment_swpm_sar_file_name: \"SWPM20SP04_6-80003424.SAR\"\nsap_s4hana_deployment_db_schema_password: \"R3dh4t123!\"\nsap_s4hana_deployment_db_schema_abap_password: \"R3dh4t123!\"\nsap_s4hana_deployment_master_password: \"R3dh4t123!\"\nsap_s4hana_deployment_hana_systemdb_password: \"R3dh4t123!\"\nsap_s4hana_deployment_sid: \"RHE\"\nsap_s4hana_deployment_db_host: \"hana1\"\nsap_s4hana_deployment_db_sid: \"RHE\"\nsap_s4hana_deployment_hana_instance_nr: \"00\"\nsap_s4hana_deployment_hana_system_password: \"R3dh4t123!\"\nsap_s4hana_deployment_parallel_jobs_nr: \"30\"\nsap_s4hana_deployment_db_sidadm_password: \"R3dh4t123!\"\nsap_s4hana_deployment_igs_path: \"/software/S4HANA_installation\"\nsap_s4hana_deployment_igs_file_name: \"igsexe_9-80003187.sar\"\nsap_s4hana_deployment_igs_helper_path: \"/software/S4HANA_installation\"\nsap_s4hana_deployment_igs_helper_file_name: \"igshelper_17-10010245.sar\"\nsap_s4hana_deployment_kernel_dependent_path: \"/software/S4HANA_installation\"\nsap_s4hana_deployment_kernel_dependent_file_name: \"SAPEXEDB_201-80003385.SAR\"\nsap_s4hana_deployment_kernel_independent_path: \"/software/S4HANA_installation\"\nsap_s4hana_deployment_kernel_independent_file_name: \"SAPEXE_201-80003386.SAR\"\nsap_s4hana_deployment_software_path: \"/software/S4HANA_installation\"\nsap_s4hana_deployment_sapadm_password: \"R3dh4t123!\"\nsap_s4hana_deployment_sap_sidadm_password: \"R3dh4t123!\"'
      groups:
      - name: "sap"
        hosts:
        - name: "hana1"
        - name: "hana2"
        - name: "s4hana"
  projects:
    - name: "sap-rhsm"
      description: "SAP RHSM"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "sap-rhsm"
      organization: "Default"
    - name: "storage"
      description: "SAP Storage"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "storage"
      organization: "Default"
    - name: "sap-preconfigure"
      description: "SAP Preconfigure"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "sap-preconfigure"
      organization: "Default"
    - name: "sap-hostagent"
      description: "SAP HostAgent"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "sap-hostagent"
      organization: "Default"
    - name: "sap-hana-preconfigure"
      description: "SAP HANA Preconfigure"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "sap-hana-preconfigure"
      organization: "Default"
    - name: "sap-hana-deployment"
      description: "SAP HANA Deployment"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "sap-hana-deployment"
      organization: "Default"
    - name: "sap-netweaver-preconfigure"
      description: "SAP NetWeaver Preconfigure"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "sap-netweaver-preconfigure"
      organization: "Default"
    - name: "sap-s4hana-deployment"
      description: "SAP S/4HANA Deployment"
      scm_type: "git"
      scm_url: "https://github.com/redhat-sap/sap-tower-projects.git"
      scm_branch: "sap-s4hana-deployment"
      organization: "Default"
  job_templates:
    - name: "sap-repositories"
      description: "Enable RHEL for SAP Solutions Repos"
      inventory: "sap-hosts"
      project: "sap-rhsm"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
    - name: "sap-storage"
      description: "Configure required File Systems for HANA and S/4HANA"
      inventory: "sap-hosts"
      project: "storage"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
    - name: "sap-preconfigure"
      description: "Apply specific OS requirements to deploy SAP Workloads"
      inventory: "sap-hosts"
      project: "sap-preconfigure"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
    - name: "sap-hostagent"
      description: "Deploy SAP Host Agent"
      inventory: "sap-hosts"
      project: "sap-hostagent"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
    - name: "sap-hana-preconfigure"
      description: "Apply specific OS requirements to deploy SAP HANA"
      inventory: "sap-hosts"
      inventory_limit_pattern: "hana-{{ guid }}"
      project: "sap-hana-preconfigure"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
    - name: "sap-hana-deployment"
      description: "Deploy SAP HANA"
      inventory: "sap-hosts"
      inventory_limit_pattern: "hana-{{ guid }}"
      project: "sap-hana-deployment"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
    - name: "sap-netweaver-preconfigure"
      description: "Apply specific OS requirements to deploy SAP S/4HANA"
      inventory: "sap-hosts"
      inventory_limit_pattern: "s4hana-{{ guid }}"
      project: "sap-netweaver-preconfigure"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
    - name: "sap-s4hana-deployment"
      description: "Deploy SAP S/4HANA"
      inventory: "sap-hosts"
      inventory_limit_pattern: "s4hana-{{ guid }}"
      project: "sap-s4hana-deployment"
      playbook: "play.yml"
      enable_privilege_escalation: true
      credentials:
        - "ssh-key"
  credentials:
  - name: "ssh-key"
    description: "SAP Hosts SSH Key"
    organization: "Default"
    credential_type: "Machine"
    inputs:
      username: "ec2-user"
      ssh_key_data: "{{lookup('file', '{{ output_dir}}/{{ guid }}key') }}"

workflow_schema: |
  - job_template: 'sap-repositories'
    success_nodes:
    - job_template: 'sap-storage'
      success_nodes:
      - job_template: 'sap-hostagent'
        success_nodes:
        - job_template: 'sap-preconfigure'
          success_nodes:
          - job_template: 'sap-hana-preconfigure'
            success_nodes:
            - job_template: 'sap-hana-deployment'
              success_nodes:
              - job_template: 'sap-s4hana-deployment'
          - job_template: 'sap-netweaver-preconfigure'