- name: Step 005 - Show me what you got !
  hosts: bastions
  become: false
  gather_facts: false
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/scripts/ocp/auth/kubeconfig
  tasks:
  - debug:
      msg: "Post-Software Steps starting"

  - name: Get kubeadmin password
    when: kni_auto_install
    slurp:
      path: /home/{{ ansible_user }}/scripts/ocp/auth/kubeadmin-password
    register: kubeadminr

  - name: Get console route
    when: kni_auto_install
    environment:
      KUBECONFIG: /home/{{ ansible_user }}/scripts/ocp/auth/kubeconfig
    command: oc get route -n openshift-console console -o json
    register: routeconsole
    retries: 10
    delay: 30
    until: routeconsole is succeeded
    ignore_errors: yes

  - name: Get Webconsole URL
    when: kni_auto_install
    environment:
      KUBECONFIG: /home/{{ ansible_user }}/scripts/ocp/auth/kubeconfig
    command: oc whoami --show-console
    register: webconsole_url

  - name: Get API URL
    when: kni_auto_install
    environment:
      KUBECONFIG: /home/{{ ansible_user }}/scripts/ocp/auth/kubeconfig
    command: oc whoami --show-server
    register: api_url

  - name: Print Connection Information
    when: kni_auto_install
    debug:
      msg: "{{ item }}"
    with_items:
      - "user.info: Openshift Master Console: https://console-openshift-console.apps.{{ guid }}.{{ osp_cluster_dns_zone }}"
      - "user.info: kubeadmin user Password : {{ kubeadminr }}"
      - "user.info: Openshift API for command line 'oc' client: {{ api_url.stdout | trim }}"


- name: PostSoftware flight-check
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    - debug:
        msg: "Post-Software checks completed successfully"
