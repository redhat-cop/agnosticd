#!/bin/bash
OSP_PROJECT="{{ osp_project_name }}"
GUID="{{ guid }}"

export KUBECONFIG=/home/cloud-user/scripts/ocp/auth/kubeconfig

prepare() {
oc create namespace openshift-storage
sleep 5
for i in 0..2
do
  oc label node worker-$i cluster.ocs.openshift.io/openshift-storage=''
done

oc new-project local-storage

cat << EOF > $(pwd)/local-storage-block.yaml
apiVersion: local.storage.openshift.io/v1
kind: LocalVolume
metadata:
  name: local-block
  namespace: local-storage
spec:
  nodeSelector:
    nodeSelectorTerms:
    - matchExpressions:
        - key: cluster.ocs.openshift.io/openshift-storage
          operator: In
          values:
          - ""
  storageClassDevices:
    - storageClassName: localblock
      volumeMode: Block
      devicePaths:
EOF

for VOL in $( openstack --os-cloud=$OSP_PROJECT volume list |cut -d\| -f2|sed 's/ //g' )
do
  ID=$(echo ${VOL:0:20}| sed 's/-//g')
  echo "        - /dev/disk/by-id/virtio-$(ID)" >> $(pwd)/local-storage-block.yaml
done

echo "Now please connect to your openshift UI and setup Local Storage operator"
exit 0
}

install() {

oc create -f local-storage-file.yaml
sleep 30
oc create -f cluster-servive-metal.yaml
exit 0
}

case $1 in
  prep) prepare ;;
  setup) install ;;
  *) echo "Usage : $0 prep | setup"
     echo "prep to prepare the namespaces"
     echo "setup to install ocs"
     exit 0 ;;
esac
