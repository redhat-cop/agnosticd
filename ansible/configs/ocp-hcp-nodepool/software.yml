---
- name: Deploy software
  hosts: ocp_bastions
  become: false
  gather_facts: false
  tags:
    - step004
  tasks:
    - name: Configure nodepool
      module_defaults:
        group/k8s:
          host: "{{ sandbox_openshift_api_url }}"
          api_key: "{{ k8s_auth_results.k8s_auth.api_key | default(sandbox_openshift_api_key) }}"
          validate_certs: false
      block:
        - name: Get HostedCluster information
          kubernetes.core.k8s_info:
            api_version: hypershift.openshift.io/v1beta1
            kind: HostedCluster
            name: "hcp-{{ guid.split('-')[0] }}"
            namespace: "{{ namespace }}"
          register: r_hostedcluster

        - name: Create the NodePool
          kubernetes.core.k8s:
            definition: "{{ lookup('ansible.builtin.template', 'nodepool.yaml') }}"
            wait: true
            wait_timeout: 300
          vars:
            namespace: "{{ sandbox_openshift_namespace }}"
            _ocp_image: "{{ r_hostedcluster.resources[0].spec.release.image }}"
