---
- name: Step 000 Software
  hosts: localhost
  connection: local
  become: false
  tags:
    - step001
    - software
  tasks:
    - name: "Software tasks Started"
      ansible.builtin.debug:
        msg: "Software tasks Started"

- name: Software deployment
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - actual_sausage_making
  tasks:
    ## Authenticating
    - name: Authorizing with IBM CLoud using Sandbox credentials
      ansible.builtin.include_tasks: auth_sandbox.yml

    ## Getting Exact OpenShift version to deploy
    - name: Get full OpenShift version
      ansible.builtin.uri:
        url: "{{ ibm_cloud_api_openshift_version_url }}"
        method: GET
        status_code: 200
      register: r_openshift_version_list
      tags: get-versions
      until: r_openshift_version_list.status == 200
      retries: 10
      delay: 6

    - name: Displaying the JSON output of the API call if verbosity 2+
      ansible.builtin.debug:
        var: r_openshift_version_list.json.openshift
        verbosity: 2

    - name: Does the requested version exist?
      ansible.builtin.set_fact:
        rhoic_desired_version_exists: >-
          {{ r_openshift_version_list.json.openshift | json_query(jmesquery) }}
      vars:
        jmesquery: >-
          [?major==`{{ rhoic_openshift_version_major }}`
            && minor==`{{ rhoic_openshift_version_minor }}`]

    - name: If requested version DOES NOT exist, use default
      when: rhoic_desired_version_exists | length == 0
      block:

        - name: Set fact for RHOIC version = Default, step 1
          ansible.builtin.set_fact:
            rhoic_openshift_version_list: >-
              {{ r_openshift_version_list.json.openshift
                  | json_query(jmesquery)
                  | join('') }}
          vars:
            jmesquery: "[?default == `true`].[major, minor, patch]"

        - name: Set fact for RHOIC version = Default, step 2
          ansible.builtin.set_fact:
            rhoic_openshift_version: >-
              {{ rhoic_openshift_version_list | join('.') }}_openshift

    - name: If requested version DOES exist, use it
      when: rhoic_desired_version_exists | length > 0
      block:

        - name: Set fact for RHOIC patch version = Desired, step 1
          ansible.builtin.set_fact:
            rhoic_openshift_version_patch: >-
              {{ r_openshift_version_list.json.openshift
                  | json_query(jmesquery) }}
          vars:
            jmesquery: >-
              [?major==`{{ rhoic_openshift_version_major }}`
                && minor==`{{ rhoic_openshift_version_minor }}`].patch

        - name: Set fact for RHOIC version = Desired, step 2
          ansible.builtin.set_fact:
            rhoic_openshift_version: >-
              {{ rhoic_openshift_version_major }}.{{
                 rhoic_openshift_version_minor }}.{{
                 rhoic_openshift_version_patch[0] }}_openshift

    - ansible.builtin.debug:
        var: rhoic_openshift_version

- name: Building the Cloud Object Storage and RHOIC Cluster
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    # Authenticated from last section in this playbook
    # Create Workspace to support RHOIC
    - name: Create a new workspace
      ansible.builtin.uri:
        url: "{{ ibm_cloud_schematics_url }}"
        method: POST
        status_code: 201
        headers:
          Authorization: "Bearer {{ ibm_access_token }}"
        body_format: json
        body:
          name: "{{ rhoic_cluster_name }}"
          type:
            - "{{ terraform_version }}"
          location: "{{ rhoic_region }}"
          description: "Creating Cloud Object Storage and the RHOIC cluster"
          tags: []
          template_repo:
            url: "{{ terraform_rhoic }}"
          template_data:
            - folder: "."
              type: "{{ terraform_version }}"
              variablestore:
                - name: ibmcloud_api_key
                  value: "{{ sandbox_master_api_key }}"
                  secure: true
                - name: ibmcloud_region
                  value: "{{ rhoic_region }}"
                - name: ibmcloud_zone
                  value: "{{ rhoic_region_dc }}"
                - name: resource_group
                  value: "{{ rhoic_resource_group_name }}"
                - name: vpc_name
                  value: "{{ rhoic_vpc_name }}"
                - name: subnet_name
                  value: "{{ rhoic_subnet_name }}"
                - name: pgw_name
                  value: "{{ rhoic_pgw_name }}"
                - name: cos_name
                  value: "{{ rhoic_cos_name }}"
                - name: cluster_name
                  value: "{{ rhoic_cluster_name }}"
                - name: cluster_version
                  value: "{{ rhoic_openshift_version }}"
                - name: cluster_flavor
                  value: "{{ rhoic_compute_type }}"
                - name: cluster_worker_count
                  value: "{{ rhoic_compute_count }}"
      register: r_ws_rhoic_create
      tags: create-ws-rhoic
      until: r_ws_rhoic_create.status == 201
      retries: 10
      delay: 10

    - name: Get a list of workspaces
      ansible.builtin.uri:
        url: "{{ ibm_cloud_schematics_url }}"
        method: GET
        status_code: 200
        headers:
          Authorization: "{{ ibm_access_token }}"
      register: r_ws_list
      tags: retrieve-ws-list
      until: r_ws_list.status == 200
      retries: 10
      delay: 10

    - name: Setting the rhoic_ws_id variable
      ansible.builtin.set_fact:
        rhoic_ws_id: "{{ item.id }}"
      with_items: "{{ r_ws_list.json.workspaces }}"
      when: item.name == rhoic_cluster_name

    - name: Pausing for 60 seconds for lock to be released
      ansible.builtin.pause:
        seconds: 60

    - name: Making the plan that IBM Schematics will run
      ansible.builtin.uri:
        url: "{{ ibm_cloud_schematics_url }}/{{ rhoic_ws_id }}/plan"
        method: POST
        status_code: 202
        headers:
          Authorization: "Bearer {{ ibm_access_token }}"
          refresh_token: "{{ ibm_refresh_token }}"
      register: r_ws_rhoic_plan
      tags: plan-ws-rhoic
      until: r_ws_rhoic_plan.status == 202
      retries: 10
      delay: 30

    - name: Waiting for the plan to finish creating
      ansible.builtin.uri:
        url: "{{ ibm_cloud_schematics_url }}/{{ rhoic_ws_id }}"
        method: GET
        status_code: 200
        headers:
          Authorization: "Bearer {{ ibm_access_token }}"
      register: r_ws_detail
      tags: retrieve-ws
      until:
      - r_ws_detail.json.status is defined
      - r_ws_detail.json.status != "INPROGRESS"
      retries: 30
      delay: 30

    - name: Pausing for 30 seconds for lock to be released
      ansible.builtin.pause:
        seconds: 30

    - name: Applying the plan
      ansible.builtin.uri:
        url: "{{ ibm_cloud_schematics_url }}/{{ rhoic_ws_id }}/apply"
        method: PUT
        status_code: 202
        headers:
          Authorization: "Bearer {{ ibm_access_token }}"
          refresh_token: "{{ ibm_refresh_token }}"
      register: r_ws_rhoic_apply
      tags: apply-ws-rhoic
      until: r_ws_rhoic_apply.status == 202
      retries: 30
      delay: 10

      # TODO: is there no way to check for the RHOIC cluster build?
    - name: Pausing for 30 minutes to allow the RHOIC cluster to build
      ansible.builtin.pause:
        minutes: 30

    # Re-Authenticating because token only good for 60 minutes
    # and we don't want it to expire
    - name: Authorizing with IBM CLoud using Sandbox credentials
      ansible.builtin.include_tasks: auth_sandbox.yml

    # Waiting for the control plane to finish building
    # IBM Cloud Schematics times out at 90 minutes so this is a hard limit
    - name: Waiting for the plan to be active
      ansible.builtin.uri:
        url: "{{ ibm_cloud_schematics_url }}/{{ rhoic_ws_id }}"
        method: GET
        status_code: 200
        headers:
          Authorization: "Bearer {{ ibm_access_token }}"
      register: r_ws_detail
      tags: retrieve-ws
      until:
      - r_ws_detail.json.status is defined
      - r_ws_detail.json.status == "ACTIVE"
      retries: 45
      delay: 60

    # Re-Authenticating because token only good for 60 minutes
    # and we don't want it to expire
    - name: Authorizing with IBM CLoud using Sandbox credentials
      ansible.builtin.include_tasks: auth_sandbox.yml

    # First loop waiting for a finishes cluster
    # it finishes in this timeframe 80% of the time
    - name: Gathering RHOIC Cluster information
      ansible.builtin.uri:
        url: >-
          {{ ibm_cloud_api_container_v2_url }}/getCluster?cluster={{
             rhoic_cluster_name }}
        method: GET
        status_code: 200
        headers:
          Authorization: Bearer {{ ibm_access_token }}
      register: r_existing_rhoic
      tags: retrieve-rhoic
      until:
      - r_existing_rhoic.json.state is defined
      - r_existing_rhoic.json.state == "normal"
      retries: 55
      delay: 60
      ignore_errors: true

    # Re-Authenticating because token only good for 60 minutes
    # and we don't want it to expire
    - name: Authorizing with IBM CLoud using Sandbox credentials
      ansible.builtin.include_tasks: auth_sandbox.yml

    # Second loop waiting for a finishes cluster
    # it finishes in this timeframe 99% of the time
    - name: Gathering RHOIC Cluster information
      ansible.builtin.uri:
        url: >-
          {{ ibm_cloud_api_container_v2_url }}/getCluster?cluster={{
             rhoic_cluster_name }}
        method: GET
        status_code: 200
        headers:
          Authorization: Bearer {{ ibm_access_token }}
      register: r_existing_rhoic
      tags: retrieve-rhoic
      until:
      - r_existing_rhoic.json.state is defined
      - r_existing_rhoic.json.state == "normal"
      retries: 45
      delay: 60

    - name: Displaying RHOIC cluster details if verbosity 2+
      ansible.builtin.debug:
        var: r_existing_rhoic
        #verbosity: 2
        #

    # Third loop waiting for ingress to become healthy, necessary for workloads
    - name: Wait for RHOIC ingress to be healthy
      ansible.builtin.uri:
        url: >-
          {{ ibm_cloud_api_container_v2_url }}/getCluster?cluster={{
             rhoic_cluster_name }}
        method: GET
        status_code: 200
        headers:
          Authorization: Bearer {{ ibm_access_token }}
      register: r_existing_rhoic_status
      tags: retrieve-rhoic
      until:
      - r_existing_rhoic_status.json.ingress.status is defined
      - r_existing_rhoic_status.json.ingress.status == "healthy"
      retries: 100
      delay: 60

    - name: Get admin Kubeconfig
      ansible.builtin.uri:
        url: >-
          {{ ibm_cloud_api_container_v2_url }}/getKubeconfig?admin=true&endpointType=&format=json&network=false&cluster={{
             rhoic_cluster_name }}
        method: GET
        status_code: 200
        headers:
          Authorization: Bearer {{ ibm_access_token }}
      register: r_rhoic_kubeconfig

    - ansible.builtin.copy:
        dest: "{{ output_dir }}/kubeconfig"
        content: "{{ r_rhoic_kubeconfig.json | to_yaml }}"

- name: Software flight-check
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    - ansible.builtin.debug:
        msg: "Software checks completed successfully"
