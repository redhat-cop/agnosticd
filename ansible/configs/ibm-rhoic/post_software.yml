---
- name: Step 005 - Post software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
  - name: Print post software
    ansible.builtin.debug:
      msg: "Post-Software Steps starting"

  - name: Authorizing with IBM CLoud using Sandbox credentials
    ansible.builtin.include_tasks: auth_sandbox.yml

- name: Step 005 - Post software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  environment:
    KUBECONFIG: "{{ output_dir }}/kubeconfig"
  tasks:
  - name: Setup cluster-admin service account
    when: openshift_cluster_admin_service_account_enable | bool
    ansible.builtin.include_role:
      name: openshift_cluster_admin_service_account

- name: Step 005.2 - Deploy Workloads
  ansible.builtin.import_playbook: workloads.yml

- name: Step 005.5 Print Student Info
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
  - name: Setting the email variable if it is not defined so user.info won't fail
    ansible.builtin.set_fact:
      email: "no-valid-email-set"
    when:
    - email is not defined
    - requester_email is not defined

  - name: Creating Cloud URL
    ansible.builtin.set_fact:
      rhoic_console_url: >-
        {{ ibm_cloud_kubernetes_console_url }}/{{
           r_existing_rhoic.json.id }}/overview?platformType=openshift&region={{
           r_existing_rhoic.json.region }}&resourceGroup={{
           r_existing_rhoic.json.resourceGroup }}

  - name: Passing user_data
    agnosticd_user_info:
      data:
        rhoic_sandbox_account_name: "{{ sandbox_account_name }}"
        rhoic_console_url: "{{ rhoic_console_url }}"
        rhoic_openshift_version: "{{ rhoic_openshift_version }}"
        sandbox_sid_apikey: "{{ sandbox_sid_apikey }}"
        email: "{{ requester_email | default( email ) }}"
        sandbox_account_id: "{{ sandbox_account_id }}"
        sandbox_account_name: "{{ sandbox_account_name }}"

  - name: Passing user_info
    agnosticd_user_info:
      msg: |
        The information below can be used to access your Red Hat OpenShift on IBM Cloud Sandbox environment.
        IBM Cloud User: {{ requester_email | default(email) }}
        IBM Cloud Sandbox: {{ sandbox_account_name }}
        IBM Cloud Console: https://cloud.ibm.com/
        OpenShift Cluster Info (IBM Cloud): {{ rhoic_console_url }}
           - This link requires you to have already accepted the IBM Cloud invitation
             which is in your email inbox. You also must have switched to the correct sandbox.
        RHOIC RHPDS Lab Guide (README IMPORTANT!): https://red.ht/RHOICRHPDS

- name: Post Software flight-check
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
  - name: "Post-Software checks completed successfully"
    ansible.builtin.debug:
      msg: "Post-Software checks completed successfully"
