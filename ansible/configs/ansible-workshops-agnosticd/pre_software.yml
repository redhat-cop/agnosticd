---

- name: Step 003 Pre Software
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  environment: &aws_environment
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key }}"
    AWS_REGION: "{{ aws_region }}"
  tasks:
    - debug:
        msg: "Step 003 Pre Software local"


- name: Configure nginx on attendance host
  hosts: attendance
  become: true
  gather_facts: true
  environment: *aws_environment
  tasks:
    - block:
        - include_role:
            name: ansible.workshops.workshop_attendance_nginx
        - include_role:
            name: ansible.workshops.workshop_attendance
      when: attendance|bool

- name: Configure common options on managed nodes and control nodes
  hosts: "managed_nodes:control_nodes"
  gather_facts: false
  become: true
  environment: *aws_environment
  tasks:
    - include_role:
        name: ansible.workshops.user_accounts
    - include_role:
        name: ansible.workshops.common

- name: Configure /etc/hosts
  hosts: 'managed_nodes:control_nodes'
  gather_facts: true
  become: true
  environment: *aws_environment
  tasks:
    - name: setup /etc/hosts file per student
      copy:
        src: "{{ output_dir }}/{{ username }}-etchosts.txt"
        dest: "/etc/hosts"
        owner: "{{ username }}"
        group: "{{ username }}"

- name: configure ansible control node
  hosts: '*ansible-1'
  gather_facts: true
  become: true
  environment: *aws_environment
  tasks:
    - include_role:
        name: ansible.workshops.control_node

    - include_role:
        name: ansible.workshops.code_server
      when:
        - code_server is defined
        - code_server
        - controllerinstall is defined
        - controllerinstall

- name: replicate venvs to cluster nodes
  hosts: '*ansible-2,*ansible-3'
  gather_facts: false
  become: true
  environment: *aws_environment
  tasks:
    - include_role:
        name: ansible.workshops.control_node
        tasks_from: 15_package_dependencies
      when: create_cluster|bool

    - include_role:
        name: ansible.workshops.control_node
        tasks_from: venv
      when: create_cluster|bool


- name: add dns entires for all student control nodes
  hosts: '*ansible-1'
  become: true
  gather_facts: false
  environment: *aws_environment
  tasks:
    - include_role:
        name: ansible.workshops.aws_dns
      when:
        - dns_type is defined
        - dns_type == "aws"
        - controllerinstall is defined
        - controllerinstall
  tags: control_node

- name: populate ansible tower
  hosts: '*ansible-1'
  become: true
  gather_facts: false
  environment: *aws_environment

  tasks:
    - name: run populate_tower role
      include_role:
        name: ansible.workshops.populate_controller
      when:
        - controllerinstall is defined
        - controllerinstall|bool
