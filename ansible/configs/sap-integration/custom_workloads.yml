- name: Set Ansible Python interpreter to k8s virtualenv
  set_fact:
    ansible_python_interpreter: /opt/virtualenvs/k8s/bin/python

- name: Create openshift-storage namespace
  k8s:
    state: present
    src: files/k8s/ns_storage.yml

- name: Label nodes for OCS
  shell: >
    for n in $(oc get nodes | grep worker 
    | awk {'print $1'}); do oc label node $n 
    cluster.ocs.openshift.io/openshift-storage='';done

- name: Create ocs operatorgroup
  k8s:
    state: present
    src: files/k8s/ocs_operatorgroup.yml

- name: Create ocs subscription
  k8s:
    state: present
    src: files/k8s/ocs_subscription.yml

- name: Create ocs cluster
  k8s:
    state: present
    src: files/k8s/storage_cluster.yml

- name: Patch default Storage Class
  shell: >
    oc patch storageclass standard
    -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'

- name: Patch default Storage Class
  shell: >
    oc patch storageclass ocs-storagecluster-cephfs
    -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

- name: Create fuse online namespace
  k8s:
    state: present
    src: files/k8s/ns_fuse.yml

- name: Create secret for image pull
  k8s:
    state: present
    src: files/k8s/syndesis-pull-secret.yml

- name: Create fuse operatorgroup
  k8s:
    state: present
    src: files/k8s/fuse_operatorgroup.yml

- name: Create fuse subscription
  k8s:
    state: present
    src: files/k8s/fuse_subscription.yml

- name: Link secret for syndesis
  shel: >
    oc project fuse-online &&
    oc secrets link syndesis-operator syndesis-pull-secret --for=pull

- name: Create Syndesis resource
  k8s:
    state: present
    src: files/k8s/fuse_syndesis.yml

