apiVersion: camel.apache.org/v1
kind: Integration
metadata:
  name: sap-odata
  namespace: sap-serverless
spec:
  configuration:
  - type: property
    value: camel.component.olingo4.configuration.serviceUri=https\://sapes5.sapdevcenter.com/sap/opu/odata4/sap/ze2e001/default/sap/ze2e001_salesorder/0001/
  sources:
  - content: "// camel-k: language=java property-file=sap.properties \n\nimport org.apache.camel.builder.RouteBuilder;\n\nimport java.util.Map;\nimport java.util.HashMap;\n\npublic class SapOdata extends RouteBuilder {\n\n  Map<String, String> tempMap = new HashMap<String, String>();\n    \n\n  @Override\n  public void configure() throws Exception {\n\n  from(\"knative:channel/ordercheck\")\n    .log(\"FROM EVENTING --- [${body}]\")\n    .unmarshal().json()\n    .setHeader(\"CamelOlingo4.keyPredicate\", simple(\"'${body[text]}'\"))\n    .choice()\n      .when(header(\"CamelOlingo4.keyPredicate\").regex(\"\\'\\\\d{9}\\'\"))\n        .log(\"validate OK\")\n        .to(\"direct:runsap\")\n    .end()\n    \n    \n  ;\n\n  from(\"direct:runsap\")\n    .bean(this, \"create(\\\"${body[text]}\\\")\")\n    .to(\"olingo4://read/SalesOrder\")\n    .split(simple(\"${body.properties}\"))\n      .choice()\n        .when(simple(\"${body.name} == 'Customer' \"))\n          .bean(this, \"aggregate(\\\"CUSTOMER\\\",'${body.value}')\")\n        .when(simple(\"${body.name} == 'Transactioncurrency' \"))\n          .bean(this, \"aggregate(\\\"CURRENCY\\\",'${body.value}')\")\n        .when(simple(\"${body.name} == 'Grossamountintransaccurrency' \"))\n          .bean(this, \"aggregate(\\\"SUM\\\",'${body.value}')\")\n        .when(simple(\"${body.name} == 'Taxamountintransactioncurrency' \"))\n          .bean(this, \"aggregate(\\\"PRICE\\\",'${body.value}')\")\n      .end()\n    .end()\n    .setBody(method(this, \"getSalesOrder()\"))\n    .marshal().json()\n    .log(\"${body}\")\n    .to(\"knative://channel/returntxt\")\n  ;\n\n  from(\"direct:incorrect\")\n    .setBody().constant(\"{\\\"error\\\":\\\"UNKNOWN SALESORDER FORMAT!!\\\"}\")\n    .log(\"${body}\")\n  ;  \n    \n\n  }\n\n  public void create(String salesorder) {\n\n    tempMap= new HashMap<String, String>();\n    tempMap.put(\"SALESORDER\", salesorder);\n    \n  }\n\n\n  public void aggregate(String name, String value) {\n    tempMap.put(name, value);\n    \n  }\n\n  public Map<String, String> getSalesOrder() {\n    \n    return tempMap;\n  }\n}\n"
    name: SapOdata.java