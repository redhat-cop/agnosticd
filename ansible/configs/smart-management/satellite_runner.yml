---
- name: Create Project for runner
  tower_project:
    name: "satellite-runner-project"
    description: "project for satellite-runner"
    organization: "gpte"
    scm_url: "{{ satellite_runner_source }}"
    scm_type: "git"
    scm_credential: "Satellite Runner"
    scm_branch:  "master"
    scm_update_on_launch: "True"
    state: "present"
    tower_host: "{{ tower_hostname }}"  
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"

- name: Sleep to allow tower projects to update
  wait_for:
    timeout: 30

- name: Create Inventory For Local Environment
  tower_inventory:
    name: "Local Environment"
    description: "Lab environment systems"
    organization: "gpte"
    state: "present"
    tower_host: "{{ tower_hostname }}"  
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"

- name: Add tower inventory source
  tower_inventory_source:
    name: "Local Environment"
    description: "Loacl environment from git"
    inventory: "Local Environment"
    credential: "Satellite Runner"
    source: "scm"
    source_project: "Satellite Runner"
    source_path: "inventory.yml"
    state: "present"
    update_on_launch: "yes"
    tower_host: "{{ tower_hostname }}"
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"

- name: Create Job Template for Secrets
  tower_job_template:
    name: "Secrets Creator"
    job_type: "run"
    organization: "gpte"
    inventory: "Local Environment"
    project: "satellite-runner-project"
    playbook: "secrets_creation.yml"
    credentials:
      - "SSH Admin Key"
    state: "present"
    tower_host: "{{ tower_hostname }}"
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"
    ask_variables_on_launch: True

- name: Create random manifest name
  set_fact:
    __manifest_guid: "{{ lookup('password', '/dev/null length=5 chars=ascii_letters,digits') }}"

- name: Launch template to create secrets
  tower_job_launch:
    name: "Secrets Creator"
    extra_vars:
      guid: "{{ guid | default(__manifest_guid) }}" 
    register: secrets_job

- name: wait for job
  tower_job_wait:
    job_id: "{{ secrets_job.id }}"
    timeout: 120

- name: Create Job Template for Manifest
  tower_job_template:
    name: "Manifest Creator"
    job_type: "run"
    organization: "gpte"
    inventory: "Local Environment"
    project: "satellite-runner-project"
    playbook: "manifest_creator.yml"
    credentials:
      - "SSH Admin Key" 
      - "rhsm_credentials"
    state: "present"
    tower_host: "{{ tower_hostname }}"
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"
    ask_variables_on_launch: True

- name: Launch Template to Create Manifest
  tower_job_launch:
    name: "Manifest Creator"
    extra_vars:
      guid: "{{ guid | default(__manifest_guid) }}" 
    register: manifest_job

- name: wait for job
  tower_job_wait:
    job_id: "{{ manifest_job.id }}"
    timeout: 120

- name: Delete Job Templates for Manifest and Secrets
  vars:
    __delete_templates:
      - Manifest Creator
      - Secrets Creator
  tower_job_template:
    name: "{{ __template }}"
    state: "absent"
    tower_host: "{{ tower_hostname }}"
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"
  loop: "{{ __delete_templates }}"
  loop_control:
    loop_var: __template

- name: Delete rhsm-credentials
  vars:
    __delete_credentials:
      - "rhsm_credentials"
      - "Satellite Runner"
  tower_credential:
    name: "{{ __credential }}"
    state: "absent"
    tower_host: "{{ tower_hostname }}"
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"
  loop: "{{ __delete_credentials }}"
  loop_control:
    loop_var: __credential

- name: Delete Satellite Runner Project
  tower_project:
    name: "satellite-runner-project"
    state: "absent"
    tower_host: "{{ tower_hostname }}"
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"

- name: Delete Inventory For Local Environment
  tower_inventory:
    name: "Local Environment"
    state: "absent"
    tower_host: "{{ tower_hostname }}"  
    tower_username: "{{ tower_admin_username | default('admin') }}"
    tower_password: "{{ tower_admin_password }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(false) }}"