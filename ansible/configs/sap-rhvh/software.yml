---
- name: Step 00xxxxx software
  hosts: localhost
  gather_facts: False
  become: false
  tasks:
    - debug:
        msg: "Software tasks Started"

- name: Ensure NFS Server is installed, SAP Software Device Mounted and Ansible Installed
  hosts: bastions
  become: True
  gather_facts: True
  tasks:

    - name: Ensure NFS directory exists
      file:
        path: "/nfs"
        state: directory

    - name: Mount up device by UUID
      mount:
        path: /nfs
        src: /dev/vdb
        fstype: xfs
        state: present

    - name: 'Ensure required packages are installed'
      package:
        name: '{{ item }}'
        state: installed
      with_items:
      - nfs-utils
      - firewalld

    - name: 'Ensure firewalld is running'
      service:
        name: firewalld
        state: started
        enabled: yes

    - name: 'Open Firewall for NFS use'
      firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      with_items:
      - 111/tcp
      - 111/udp
      - 2049/tcp
      - 2049/udp

    - name: "Ensure export file contains the directory to be shared"
      lineinfile:
        path: /etc/exports
        state: present
        regexp: "^/nfs"
        line: "/nfs *(insecure,rw,no_root_squash,no_wdelay,sync)"

    - name: 'Ensure nfs-server is restarted and running'
      service:
        name: nfs-server
        state: restarted
        enabled: yes

    - name: Ensure Ansible is installed
      yum:
        name: ansible
        state: latest

# - name: Prepare Ansible inventories for RHHI and ssh_config 
#   hosts: rhvhs
#   become: True
#   gather_facts: True
#   tasks:

#     - name: Add Gluster Inventory
#       template:
#         src: "./files/rhhi-playbooks/gluster_inventory.j2"
#         dest: "/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/gluster_inventory.yml"
#         force: yes

#     - name: Add Extra Variables for Hosted Engine
#       template:
#         src: "./files/rhhi-playbooks/he_gluster_vars.j2"
#         dest: "/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/he_gluster_vars.json"
#         force: yes

#     - name: Enable only Gluster playbook
#       template:
#         src: "./files/rhhi-playbooks/hc_deployment.j2"
#         dest: "/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/hc_deployment.yml"
#         force: yes

#     - name: Ignore HostKeyChecking
#       blockinfile:
#         path: /etc/ssh/ssh_config
#         block: |
#           # Ignore localhost
#           Host localhost
#               StrictHostKeyChecking no
#           # Ignore RHVH servers
#           Host rhvh*
#               StrictHostKeyChecking no

- name: Install packages for RHV Manager
  hosts: rhvms
  become: True
  gather_facts: False
  tasks:

    - name: Ensure rhvm package is isntalled
      yum:
        name: rhvm
        state: latest

- name: Software flight-check
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - post_flight_check
  tasks:
    - debug:
        msg: "Software checks completed successfully"

