---
- name: Step 000 Pre Software
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tags:
  - step003
  - pre_software
  tasks:
  - name: Write kubeconfig if configured
    when:
    - ocp_workloads_kubeconfig_path is undefined
    - openshift_api_ca_cert is defined
    - openshift_api_key is defined
    - openshift_api_url is defined
    vars:
      __kubeconfig_path: >-
        {%- if ansible_connection == 'local' -%}
        {{ output_dir }}/kubeconfig
        {%- else -%}
        /tmp/kubeconfig
        {%- endif -%}
    block:
    - name: Write kubeconfig to output dir
      copy:
        dest: "{{ __kubeconfig_path }}"
        content: |
          apiVersion: v1
          kind: Config
          clusters:
          - name: cluster
            cluster:
              certificate-authority-data: {{ openshift_api_ca_cert | b64encode }}
              server: {{ openshift_api_url | to_json }}
          contexts:
          - name: context
            context:
              cluster: cluster
              namespace: default
              user: user
          current-context: context
          users:
          - name: user
            user:
              token: {{ openshift_api_key | to_json }}

    - name: Set ocp_workloads_kubeconfig_path
      set_fact:
        ocp_workloads_kubeconfig_path: "{{ __kubeconfig_path }}"
