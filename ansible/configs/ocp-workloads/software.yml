---
- name: Deploy software
  hosts: ocp_bastions
  become: false
  gather_facts: false
  tags:
  - step004
  tasks:
  - name: Set up combined ocp_workloads dictionary
    ansible.builtin.set_fact:
      config_ocp_workloads: >-
        {{ config_ocp_workloads_defaults
        | combine( config_ocp_workloads_vars    | default( {} ),
                   config_ocp_workloads_secrets | default( {} ), recursive=true)
        }}

  - name: Print combined role variables
    ansible.builtin.debug:
      var: config_ocp_workloads
      verbosity: 2

  - name: Check if desired virtualenv is available on the host
    ansible.builtin.stat:
      path: "{{ config_ocp_workloads.virtualenv_path }}/bin/python"
    register: r_virtualenv

  - name: Set Ansible Python interpreter to virtualenv
    when: r_virtualenv.stat.exists
    ansible.builtin.set_fact:
      ansible_python_interpreter: "{{ config_ocp_workloads.virtualenv_path }}/bin/python"

  - name: Set common facts OpenShift cluster
    ansible.builtin.include_role:
      name: host-ocp4-set-facts

  - name: Install infra_workloads
    tags:
    - infra_workloads
    loop: "{{ infra_workloads }}"
    loop_control:
      loop_var: __workload_role
    ansible.builtin.include_role:
      name: "{{ __workload_role }}"
    vars:
      ocp_username: system:admin
      ACTION: provision

  - name: Run a single workload
    when: ocp_workload is defined
    ansible.builtin.include_role:
      name: "{{ ocp_workload }}"
    vars:
      ACTION: create

  - name: Run a list of workloads
    when:
    - ocp_workloads is defined
    - ocp_workloads | length > 0
    loop: "{{ ocp_workloads }}"
    loop_control:
      loop_var: _ocp_workload
    ansible.builtin.include_role:
      name: "{{ _ocp_workload }}"
    vars:
      ACTION: create
