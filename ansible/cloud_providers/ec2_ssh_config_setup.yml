- name: SSH config setup
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  vars_files:
    - "{{ ANSIBLE_REPO_PATH }}/configs/{{ env_type }}/env_vars.yml"
    - "{{ ANSIBLE_REPO_PATH }}/configs/{{ env_type }}/env_secret_vars.yml"
  tags:
    - create_ssh_config
  tasks:
  - name: Store bastion hostname as a fact
    set_fact:
      bastion_ip:       "{{ hostvars[ groups[ ('tag_' ~ env_type ~ '_' ~ guid ~ '_bastion') | replace('-', '_') ].0 ]['ec2_ip_address'] }}"
      bastion_hostname: "{{ hostvars[ groups[ ('tag_' ~ env_type ~ '_' ~ guid ~ '_bastion') | replace('-', '_') ].0 ]['ec2_public_dns_name'] }}"

  - name: Create empty local ssh config as defined by deploy_local_ssh_config_location
    file:
      dest: "{{ ANSIBLE_REPO_PATH }}/workdir/{{ env_type }}_{{ guid }}_ssh_conf"
      state: touch

  - name: Add bastion proxy config (hostname) to workdir ssh config file
    blockinfile:
      dest: "{{ ANSIBLE_REPO_PATH }}/workdir/{{ env_type }}_{{ guid }}_ssh_conf"
      marker: "##### {mark} ADDED BASTION PROXY HOST HOSTNAME {{ env_type }}-{{ guid }} ######"
      content: |
          Host {{ bastion_hostname }}
            Hostname {{ bastion_hostname }}
            IdentityFile ~/.ssh/{{ key_name }}.pem
            IdentitiesOnly yes
            User {{ remote_user }}
            ControlMaster auto
            ControlPath /tmp/%h-%r
            ControlPersist 5m
            StrictHostKeyChecking no
    tags:
      - bastion_proxy_config_main

  - name: Add bastion proxy config (ip address) to workdir ssh config file
    blockinfile:
      dest: "{{ ANSIBLE_REPO_PATH }}/workdir/{{ env_type }}_{{ guid }}_ssh_conf"
      marker: "##### {mark} ADDED BASTION PROXY HOST IP {{ env_type }}-{{ guid }} ######"
      content: |
          Host {{ bastion_ip }}
            Hostname {{ bastion_ip }}
            IdentityFile ~/.ssh/{{ key_name }}.pem
            IdentitiesOnly yes
            User {{ remote_user }}
            ControlMaster auto
            ControlPath /tmp/%h-%r
            ControlPersist 5m
            StrictHostKeyChecking no
    tags:
      - bastion_proxy_config_main

  - name: Add all hosts (hostname) to workdir ssh config file
    blockinfile:
      dest: "{{ ANSIBLE_REPO_PATH }}/workdir/{{ env_type }}_{{ guid }}_ssh_conf"
      marker: "##### {mark} ADDED Node Proxy Config IP {{ item }} {{ env_type }}-{{ guid }} ######"
      block: |
          Host {{ hostvars[item].ec2_ip_address }}
            Hostname {{ hostvars[item].ec2_ip_address }}
            User {{ remote_user }}
            IdentityFile ~/.ssh/{{ key_name }}.pem
            ProxyCommand ssh -F {{ inventory_dir }}/../workdir/{{ env_type }}_{{ guid }}_ssh_conf {{ remote_user }}@{{ bastion_hostname }} -W %h:%p
            StrictHostKeyChecking no
    with_items:
      - "{{ groups[('tag_' ~ env_type ~ '_' ~ guid ~ '_proxied_host_true') | replace('-', '_')] }}"
    tags:
      - bastion_proxy_config_hosts

  - name: Add all hosts (ip address) to workdir ssh config file
    blockinfile:
      dest: "{{ ANSIBLE_REPO_PATH }}/workdir/{{ env_type }}_{{ guid }}_ssh_conf"
      marker: "##### {mark} ADDED Node Proxy Config Hostname {{ item }} {{ env_type }}-{{ guid }} ######"
      block: |
          Host {{ hostvars[item].ec2_public_dns_name }}
            Hostname {{ hostvars[item].ec2_public_dns_name }}
            User {{ remote_user }}
            IdentityFile ~/.ssh/{{ key_name }}.pem
            ProxyCommand ssh -F {{ inventory_dir }}/../workdir/{{ env_type }}_{{ guid }}_ssh_conf {{ remote_user }}@{{ bastion_hostname }} -W %h:%p
            StrictHostKeyChecking no
    with_items:
      - "{{ groups[('tag_' ~ env_type ~ '_' ~ guid ~ '_proxied_host_true') | replace('-', '_')] }}"
    tags:
      - bastion_proxy_config_hosts
