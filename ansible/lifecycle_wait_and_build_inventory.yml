---
- name: Build inventory
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - name: Run infra-{{ cloud_provider }}-create-inventory Role
      include_role:
        name: infra-{{ cloud_provider }}-create-inventory


# include global vars again, for all hosts
- import_playbook: include_vars.yml
  tags:
    - create_inventory
    - must

- name: Set ansible_ssh_extra_args and wait for connection
  hosts:
    - all:!windows:!network
  gather_facts: false
  any_errors_fatal: true
  ignore_errors: false
  tasks:
    - name: Set facts for remote access
      set_fact:
        ansible_ssh_extra_args: >-
          {{ ansible_ssh_extra_args|d() }}
          -F {{hostvars.localhost.output_dir}}/{{ env_type }}_{{ guid }}_ssh_conf

    - name: Run infra-generic-wait_for_linux_hosts Role
      include_role:
        name: infra-generic-wait_for_linux_hosts
