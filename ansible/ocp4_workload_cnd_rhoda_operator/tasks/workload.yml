---
# Implement your Workload deployment tasks here
- name: Create the projects
  kubernetes.core.k8s:
    state: present
    kind: Namespace
    name: "{{ item }}"
  loop: "{{ ocp4_workload_cnd_rhoda_namespace_list }}"

#- name: Create the modh puller secret in all ODS namespaces
#  kubernetes.core.k8s:
#    state: present
#    namespace: "{{ item }}"
#    definition: "{{ lookup('template', './templates/pullsecret.yaml.j2' ) | from_yaml }}"
#  loop: "{{ ocp4_workload_cnd_rhoda_namespace_list }}"
#
#- name: Create rhoda Pagerduty Secret
#  kubernetes.core.k8s:
#    state: present
#    definition: "{{ lookup('template', 'pagerduty-secret.yaml.j2' ) }}"

- name: Install RHODA Operator Catalog
  include_role:
    name: install_operator
  vars:
    install_operator_action: install
    install_operator_name: rhoda-operator
    install_operator_namespace: "{{ ocp4_workload_cnd_rhoda_namespace }}"
    install_operator_channel: "{{ ocp4_workload_cnd_rhoda_operator_subscription_channel }}"
    install_operator_catalog: "{{ ocp4_workload_cnd_rhoda_catalogsource_name }}"
    install_operator_packagemanifest_name: "{{ ocp4_workload_cnd_rhoda_install_operator_name }}"
    install_operator_automatic_install_plan_approval: true
    install_operator_csv_nameprefix: rhoda-operator
    install_operator_starting_csv: ""
    install_operator_catalogsource_setup: true
    install_operator_catalogsource_name: "{{ ocp4_workload_cnd_rhoda_catalogsource_name }}"
    install_operator_catalogsource_namespace: "{{ ocp4_workload_cnd_rhoda_catalogsource_namespace }}"
    install_operator_catalogsource_image: "{{ ocp4_workload_cnd_rhoda_catalog_snapshot_image }}"
    install_operator_catalogsource_image_tag: "{{ ocp4_workload_cnd_rhoda_catalog_snapshot_image_tag }}"
    install_operator_catalogsource_pullsecrets:
    - addon-managed-odh-pullsecret

- name: Create OpenShift Apicurio Projects
  k8s:
    state: present
    definition:
      apiVersion: project.openshift.io/v1
      kind: Project
      metadata:
        name: 'user{{ item }}{{ ocp4_workload_cnd_rhoda_operator_namespace }}'
  loop: "{{ range(1, ocp4_workload_authentication_htpasswd_user_count | int + 1, 1) | list }}"

- name: give user admin privileges in namespace
  k8s:
    state: present
    namespace: "user{{ item }}{{ ocp4_workload_cnd_rhoda_operator_namespace }}"
    definition: "{{ lookup('template', role_path ~ '/templates/namespace-admin-rb.j2' ) | from_yaml }}"
  loop: "{{ range(1, ocp4_workload_authentication_htpasswd_user_count | int + 1, 1) | list }}"

- name: Install RHODA Operator
  include_role:
    name: install_operator
  vars:
    install_operator_action: install
    install_operator_name: dbaas-operator
    install_operator_namespace: "user{{ item }}{{ ocp4_workload_cnd_rhoda_operator_namespace }}"
    install_operator_manage_namespaces:
      - "user{{ item }}{{ ocp4_workload_cnd_rhoda_operator_namespace }}"
    install_operator_channel: "{{ ocp4_workload_cnd_rhoda_operator_channel }}"
    install_operator_catalog: 
    install_operator_automatic_install_plan_approval: >-
      "{{ ocp4_workload_cnd_rhoda_operator_automatic_install_plan_approval | default(true) }}"
    install_operator_starting_csv: "{{ ocp4_workload_cnd_rhoda_operator_starting_csv }}"
    install_operator_catalogsource_setup: "{{ ocp4_workload_cnd_rhoda_operator_use_catalog_snapshot }}"
    install_operator_catalogsource_name: "{{ ocp4_workload_cnd_rhoda_operator_catalogsource_name }}"
    install_operator_catalogsource_namespace: "user{{ item }}{{ ocp4_workload_cnd_rhoda_operator_namespace }}"
    install_operator_catalogsource_image: "{{ ocp4_workload_cnd_rhoda_operator_catalog_snapshot_image }}"
    install_operator_catalogsource_image_tag: "{{ ocp4_workload_cnd_rhoda_operator_catalog_snapshot_image_tag }}"
  loop: "{{ range(1, ocp4_workload_authentication_htpasswd_user_count | int + 1, 1) | list }}"

# Leave this as the last task in the playbook.
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
